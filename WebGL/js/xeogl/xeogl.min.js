/*
 * xeogl V0.7.0
 *
 * A WebGL-based 3D visualization engine from xeoLabs
 * http://xeogl.org/
 *
 * Built on 2018-03-31
 *
 * MIT License
 * Copyright 2018, Lindsay Kay
 * http://xeolabs.com/
 *
 */

!function(){"use strict";var a=function(){var a=[],b=0,c=[],d=0;this.length=0,this.shift=function(){if(d>=b){var e=a;if(e.length=0,a=c,c=e,d=0,!(b=a.length))return}var f=a[d];return d<0?delete a[d++]:a[d++]=void 0,this.length--,f},this.push=function(a){return this.length++,c.push(a),this},this.unshift=function(b){return a[--d]=b,this.length++,this}},b=function(){this._debug={forceHighShaderPrecision:!1},this.version=null,this.WEBGL_INFO=function(){var a={WEBGL:!1},b=document.createElement("canvas");if(!b)return a;var c=b.getContext("webgl",{antialias:!0})||b.getContext("experimental-webgl",{antialias:!0});return a.WEBGL=!!c,a.WEBGL?(a.ANTIALIAS=c.getContextAttributes().antialias,c.getShaderPrecisionFormat?c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.HIGH_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="highp":c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.MEDIUM_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="mediump":a.FS_MAX_FLOAT_PRECISION="lowp":a.FS_MAX_FLOAT_PRECISION="mediump",a.DEPTH_BUFFER_BITS=c.getParameter(c.DEPTH_BITS),a.MAX_TEXTURE_SIZE=c.getParameter(c.MAX_TEXTURE_SIZE),a.MAX_CUBE_MAP_SIZE=c.getParameter(c.MAX_CUBE_MAP_TEXTURE_SIZE),a.MAX_RENDERBUFFER_SIZE=c.getParameter(c.MAX_RENDERBUFFER_SIZE),a.MAX_TEXTURE_UNITS=c.getParameter(c.MAX_COMBINED_TEXTURE_IMAGE_UNITS),a.MAX_TEXTURE_IMAGE_UNITS=c.getParameter(c.MAX_TEXTURE_IMAGE_UNITS),a.MAX_VERTEX_ATTRIBS=c.getParameter(c.MAX_VERTEX_ATTRIBS),a.MAX_VERTEX_UNIFORM_VECTORS=c.getParameter(c.MAX_VERTEX_UNIFORM_VECTORS),a.MAX_FRAGMENT_UNIFORM_VECTORS=c.getParameter(c.MAX_FRAGMENT_UNIFORM_VECTORS),a.MAX_VARYING_VECTORS=c.getParameter(c.MAX_VARYING_VECTORS),a.SUPPORTED_EXTENSIONS={},c.getSupportedExtensions().forEach(function(b){a.SUPPORTED_EXTENSIONS[b]=!0}),a):a}(),this.stats={build:{version:b.version},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,entities:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}},this._sceneIDMap=null,this._scene=null,this.scenes={},this._scenesRenderInfo={},this._superTypes={},this._taskQueue=new a;var c=this;!function(){function a(){g=Date.now();var a=c._runScheduledTasks(g+k),b=c._taskQueue.length;c.stats.frame.tasksRun=a,c.stats.frame.tasksScheduled=b,c.stats.frame.tasksBudget=k,j.time=g;for(h in c.scenes)c.scenes.hasOwnProperty(h)&&(i=c.scenes[h],j.sceneId=h,j.startTime=i.startTime,j.deltaTime=null!=j.prevTime?j.time-j.prevTime:0,i.fire("tick",j,!0));j.prevTime=g}function b(){var a,b,d,e=c.scenes,f=c._scenesRenderInfo;for(h in e)e.hasOwnProperty(h)&&(a=e[h],b=f[h],d=a.ticksPerRender,b.ticksPerRender!==d&&(b.ticksPerRender=d,b.renderCountdown=d),0==--b.renderCountdown&&(a.render(!1),b.renderCountdown=d))}var d,e,f,g,h,i,j={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},k=10,l=0,m=[],n=30,o=0,p=function(){d=Date.now(),l>0&&(e=d-l,f=1e3/e,o+=f,m.push(f),m.length>=n&&(o-=m.shift()),c.stats.frame.fps=Math.round(o/m.length)),a(),b(),l=d,window.requestAnimationFrame(p)};window.requestAnimationFrame(p)}()};b.prototype={constructor:b,get scene(){return this._scene||(this._scene=new window.xeogl.Scene({id:"default.scene"}))},set scene(a){this._scene=a},_addScene:function(a){if(this._sceneIDMap=this._sceneIDMap||new window.xeogl.utils.Map,a.id){if(this.scenes[a.id])return void console.error("[ERROR] Scene "+b._inQuotes(a.id)+" already exists")}else a.id=this._sceneIDMap.addItem(a);this.scenes[a.id]=a;var c=a.ticksPerRender;this._scenesRenderInfo[a.id]={ticksPerRender:c,renderCountdown:c},this.stats.components.scenes++;var d=this;a.on("destroyed",function(){d._sceneIDMap.removeItem(a.id),delete d.scenes[a.id],delete d._scenesRenderInfo[a.id],d.stats.components.scenes--})},scheduleTask:function(a,b){this._taskQueue.push(a),this._taskQueue.push(b)},deferTask:function(a,b){b?a.call(b):a()},_runScheduledTasks:function(a){for(var b,c,d=(new Date).getTime(),e=this._taskQueue,f=0;e.length>0&&d<a;)b=e.shift(),c=e.shift(),c?b.call(c):b(),d=(new Date).getTime(),f++;return f},clear:function(){var a;for(var b in this.scenes)this.scenes.hasOwnProperty(b)&&(a=this.scenes[b],"default.scene"===b?a.clear():a.destroy());this.scenes={}},_isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},_isString:function(a){return"string"==typeof a||a instanceof String},_isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},_isID:function(a){return b._isString(a)||b._isNumeric(a)},_isSameComponent:function(a,c){return!(!a||!c)&&(b.prototype._isNumeric(a)||b.prototype._isString(a)?""+a:a.id)===(b.prototype._isNumeric(c)||b.prototype._isString(c)?""+c:c.id)},_isFunction:function(a){return"function"==typeof a},_isObject:function(){var a={}.constructor;return function(b){return!!b&&b.constructor===a}}(),_isComponentType:function(a,b){if(b=b||"xeogl.Component",a===b)return!0;var c=this._superTypes[a];if(!c)return!1;for(var d=c.length-1;d>=0;d--)if(c[d]===b)return!0;return!1},_copy:function(a){return this._apply(a,{})},_apply:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_apply2:function(a,b){for(var c in a)a.hasOwnProperty(c)&&void 0!==a[c]&&null!==a[c]&&(b[c]=a[c]);return b},_applyIf:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0!==b[c]&&null!==b[c]||(b[c]=a[c]));return b},_isEmptyObject:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},_inQuotes:function(a){return this._isNumeric(a)?""+a:"'"+a+"'"},_concat:function(a,b){var c=new a.constructor(a.length+b.length);return c.set(a),c.set(b,a.length),c}},window.xeogl=window.xeogl=new b}();var Canvas2Image=function(){var a=document.createElement("canvas"),b=String.fromCharCode,c="image/octet-stream",d=!1;if(!a.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var e=!!a.getContext("2d").getImageData,f=!!a.toDataURL,g=!!window.btoa,h=function(a){var b=parseInt(a.width),c=parseInt(a.height);return a.getContext("2d").getImageData(0,0,b,c)},i=function(a){var c,d,e="";if("string"==typeof a)e=a;else for(d=a,c=0;c<d.length;c++)e+=b(d[c]);return btoa(e)},j=function(a){var c="",d=a.width,e=a.height;c+="BM";var f=d*e*4+54;c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),c+=b(0,0,0,0,54,0,0,0),c+=b(40,0,0,0);var g=d;c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256);var h=e;c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),c+=b(1,0,32,0),c+=b(0,0,0,0);var j=d*e*4;c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),c+=b(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var k,l,m,n,o=a.data,p="",q=e;do{for(m=d*(q-1)*4,n="",k=0;k<d;k++)l=4*k,n+=b(o[m+l+2],o[m+l+1],o[m+l],o[m+l+3]);p+=n}while(--q);return i(c+p)},k=function(a){window.open(a)||(document.location.href=a)},l=function(a,b){return"data:"+b+";base64,"+a},m=function(a){var b=document.createElement("img");return b.src=a,b},n=function(a,b,c){if(b&&c){var d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";return d.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,b,b),d}return a};return{saveAsPNG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/png",j=h.toDataURL(i);return b?m(j):(k(d?j.replace(i,c):j),!0)},saveAsJPEG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/jpeg",j=h.toDataURL(i);return 5==j.indexOf(i)&&(b?m(j):(k(d?j.replace(i,c):j),!0))},saveAsBMP:function(a,b,c,d){if(!(f&&e&&g))return!1;var i=n(a,c,d),o="image/bmp",p=h(i),q=j(p);return b?m(l(q,o)):(k(l(q,o)),!0)}}}();!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(d){function e(){!a&&this.__init&&this.__init.apply(this,arguments)}var f=this.prototype;a=!0;var g=new this;a=!1;for(var h in d)if("_props"!==h)g[h]="function"==typeof d[h]&&"function"==typeof f[h]&&b.test(d[h])?function(a,b){return function(){var c=this._super;this._super=f[a];var d=b.apply(this,arguments);return this._super=c,d}}(h,d[h]):d[h];else{var i,j=d[h];for(var k in j)if(i=j[k],k.indexOf(",")>=0)for(var l=k.split(","),m=0,n=l.length;m<n;m++){var o=l[m].trim();i.set||function(){var a=o;i.set=function(){this.warn("Property '"+a+"' is read-only, ignoring assignment")}}(),i.enumerable=!0,Object.defineProperty(g,o,i)}else i.set||function(){var a=k;i.set=function(){this.warn("Property '"+a+"' is read-only, ignoring assignment")}}(),i.enumerable=!0,Object.defineProperty(g,k,i)}return g.superTypes=f.superTypes?f.superTypes.concat(f.type):[],d.type?xeogl._superTypes[d.type]=g.superTypes:d.type=f.type+"_"+c(),e.prototype=g,e.prototype.constructor=e,e.extend=arguments.callee,window[d.type]=e,e};var c=function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;e<36;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(d<=2&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}()}(),xeogl.utils=xeogl.utils||{},xeogl.utils.Map=function(a,b){this.items=a||[],b=b||0;var c=b+1;this.addItem=function(){var a;if(2===arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(a=arguments[0]||{};;){var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}},function(){"use strict";var a=new Float32Array(16),b=new Float32Array(16),c=new Float32Array(4),d=xeogl.math={MAX_DOUBLE:1e8,MIN_DOUBLE:-1e8,DEGTORAD:.0174532925,vec2:function(a){return new Float32Array(a||2)},vec3:function(a){return new Float32Array(a||3)},vec4:function(a){return new Float32Array(a||4)},mat3:function(a){return new Float32Array(a||9)},mat3ToMat4:function(a,b){},mat4:function(a){return new Float32Array(a||16)},mat4ToMat3:function(a,b){},createUUID:function(){for(var a=[],b=0;b<256;b++)a[b]=(b<16?"0":"")+b.toString(16);return function(){var b=4294967295*Math.random()|0,c=4294967295*Math.random()|0,d=4294967295*Math.random()|0,e=4294967295*Math.random()|0;return a[255&b]+a[b>>8&255]+a[b>>16&255]+a[b>>24&255]+"-"+a[255&c]+a[c>>8&255]+"-"+a[c>>16&15|64]+a[c>>24&255]+"-"+a[63&d|128]+a[d>>8&255]+"-"+a[d>>16&255]+a[d>>24&255]+a[255&e]+a[e>>8&255]+a[e>>16&255]+a[e>>24&255]}}(),clamp:function(a,b,c){return Math.max(b,Math.min(c,a))},fmod:function(a,b){if(a<b)return console.error("xeogl.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;b<=a;)a-=b;return a},negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return d.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(d.sqLenVec4(a))},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return d.dotVec3(a,a)},sqLenVec2:function(a){return d.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(d.sqLenVec3(a))},lenVec2:function(a){return Math.sqrt(d.sqLenVec2(a))},distVec2:function(){var a=new Float32Array(2);return function(b,c){return d.lenVec2(d.subVec2(b,c,a))}}(),rcpVec3:function(a,b){return d.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/d.lenVec4(a);return d.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/d.lenVec3(a);return d.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/d.lenVec2(a);return d.mulVec2Scalar(a,c,b)},angleVec3:function(a,b){var c=xeogl.math.dotVec3(a,b)/Math.sqrt(xeogl.math.sqLenVec3(a)*xeogl.math.sqLenVec3(b));return c=c<-1?-1:c>1?1:c,Math.acos(c)},vec3FromMat4Scale:function(){var a=new Float32Array(3);return function(b,c){return a[0]=b[0],a[1]=b[1],a[2]=b[2],c[0]=d.lenVec3(a),a[0]=b[4],a[1]=b[5],a[2]=b[6],c[1]=d.lenVec3(a),a[0]=b[8],a[1]=b[9],a[2]=b[10],c[2]=d.lenVec3(a),c}}(),vecToArray:function(){function a(a){return Math.round(1e5*a)/1e5}return function(b){b=Array.prototype.slice.call(b);for(var c=0,d=b.length;c<d;c++)b[c]=a(b[c]);return b}}(),dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return d.m4s(0)},setMat4ToOnes:function(){return d.m4s(1)},diagonalMat4v:function(a){return new Float32Array([a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]])},diagonalMat4c:function(a,b,c,e){return d.diagonalMat4v([a,b,c,e])},diagonalMat4s:function(a){return d.diagonalMat4c(a,a,a,a)},identityMat4:function(a){return a=a||new Float32Array(16),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},identityMat3:function(a){return a=a||new Float32Array(9),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},isIdentityMat4:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return d.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat3:function(a,b,c){c||(c=new Float32Array(9));var d=a[0],e=a[3],f=a[6],g=a[1],h=a[4],i=a[7],j=a[2],k=a[5],l=a[8],m=b[0],n=b[3],o=b[6],p=b[1],q=b[4],r=b[7],s=b[2],t=b[5],u=b[8];return c[0]=d*m+e*p+f*s,c[3]=d*n+e*q+f*t,c[6]=d*o+e*r+f*u,c[1]=g*m+h*p+i*s,c[4]=g*n+h*q+i*t,c[7]=g*o+h*r+i*u,c[2]=j*m+k*p+l*s,c[5]=j*n+k*q+l*t,c[8]=j*o+k*r+l*u,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a===b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a,b){var c=b||d.identityMat4();return c[12]=a[0],c[13]=a[1],c[14]=a[2],c},translationMat3v:function(a,b){var c=b||d.identityMat3();return c[6]=a[0],c[7]=a[1],c},translationMat4c:function(){var a=new Float32Array(3);return function(b,c,e,f){return a[0]=b,a[1]=c,a[2]=e,d.translationMat4v(a,f)}}(),translationMat4s:function(a,b){return d.translationMat4c(a,a,a,b)},translateMat4v:function(a,b){return d.translateMat4c(a[0],a[1],a[2],b)},OLDtranslateMat4c:function(a,b,c,d){var e=d[12];d[0]+=e*a,d[4]+=e*b,d[8]+=e*c;var f=d[13];d[1]+=f*a,d[5]+=f*b,d[9]+=f*c;var g=d[14];d[2]+=g*a,d[6]+=g*b,d[10]+=g*c;var h=d[15];return d[3]+=h*a,d[7]+=h*b,d[11]+=h*c,d},translateMat4c:function(a,b,c,d){var e=d[3];d[0]+=e*a,d[1]+=e*b,d[2]+=e*c;var f=d[7];d[4]+=f*a,d[5]+=f*b,d[6]+=f*c;var g=d[11];d[8]+=g*a,d[9]+=g*b,d[10]+=g*c;var h=d[15];return d[12]+=h*a,d[13]+=h*b,d[14]+=h*c,d},rotationMat4v:function(a,b,c){var e,f,g,h,i,j,k=d.normalizeVec4([b[0],b[1],b[2],0],[]),l=Math.sin(a),m=Math.cos(a),n=1-m,o=k[0],p=k[1],q=k[2];return e=o*p,f=p*q,g=q*o,h=o*l,i=p*l,j=q*l,c=c||d.mat4(),c[0]=n*o*o+m,c[1]=n*e+j,c[2]=n*g-i,c[3]=0,c[4]=n*e-j,c[5]=n*p*p+m,c[6]=n*f+h,c[7]=0,c[8]=n*g+i,c[9]=n*f-h,c[10]=n*q*q+m,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c},rotationMat4c:function(a,b,c,e,f){return d.rotationMat4v(a,[b,c,e],f)},scalingMat4v:function(a,b){return b=b||d.identityMat4(),b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat3v:function(a,b){return b=b||d.identityMat3(),b[0]=a[0],b[4]=a[1],b},scalingMat4c:function(){var a=new Float32Array(3);return function(b,c,e,f){return a[0]=b,a[1]=c,a[2]=e,d.scalingMat4v(a,f)}}(),scaleMat4c:function(a,b,c,d){return d[0]*=a,d[4]*=b,d[8]*=c,d[1]*=a,d[5]*=b,d[9]*=c,d[2]*=a,d[6]*=b,d[10]*=c,d[3]*=a,d[7]*=b,d[11]*=c,d},scaleMat4v:function(a,b){var c=a[0],d=a[1],e=a[2];return b[0]*=c,b[4]*=d,b[8]*=e,b[1]*=c,b[5]*=d,b[9]*=e,b[2]*=c,b[6]*=d,b[10]*=e,b[3]*=c,b[7]*=d,b[11]*=e,b},scalingMat4s:function(a){return d.scalingMat4c(a,a,a)},rotationTranslationMat4:function(a,b,c){c=c||d.mat4();var e=a[0],f=a[1],g=a[2],h=a[3],i=e+e,j=f+f,k=g+g,l=e*i,m=e*j,n=e*k,o=f*j,p=f*k,q=g*k,r=h*i,s=h*j,t=h*k;return c[0]=1-(o+q),c[1]=m+t,c[2]=n-s,c[3]=0,c[4]=m-t,c[5]=1-(l+q),c[6]=p+r,c[7]=0,c[8]=n+s,c[9]=p-r,c[10]=1-(l+o),c[11]=0,c[12]=b[0],c[13]=b[1],c[14]=b[2],c[15]=1,c},mat4ToEuler:function(a,b,c){c=c||d.vec4();var e=d.clamp,f=a[0],g=a[4],h=a[8],i=a[1],j=a[5],k=a[9],l=a[2],m=a[6],n=a[10];return"XYZ"===b?(c[1]=Math.asin(e(h,-1,1)),Math.abs(h)<.99999?(c[0]=Math.atan2(-k,n),c[2]=Math.atan2(-g,f)):(c[0]=Math.atan2(m,j),c[2]=0)):"YXZ"===b?(c[0]=Math.asin(-e(k,-1,1)),Math.abs(k)<.99999?(c[1]=Math.atan2(h,n),c[2]=Math.atan2(i,j)):(c[1]=Math.atan2(-l,f),c[2]=0)):"ZXY"===b?(c[0]=Math.asin(e(m,-1,1)),Math.abs(m)<.99999?(c[1]=Math.atan2(-l,n),c[2]=Math.atan2(-g,j)):(c[1]=0,c[2]=Math.atan2(i,f))):"ZYX"===b?(c[1]=Math.asin(-e(l,-1,1)),Math.abs(l)<.99999?(c[0]=Math.atan2(m,n),c[2]=Math.atan2(i,f)):(c[0]=0,c[2]=Math.atan2(-g,j))):"YZX"===b?(c[2]=Math.asin(e(i,-1,1)),Math.abs(i)<.99999?(c[0]=Math.atan2(-k,j),c[1]=Math.atan2(-l,f)):(c[0]=0,c[1]=Math.atan2(h,n))):"XZY"===b&&(c[2]=Math.asin(-e(g,-1,1)),Math.abs(g)<.99999?(c[0]=Math.atan2(m,j),c[1]=Math.atan2(h,f)):(c[0]=Math.atan2(-k,n),c[1]=0)),c},lookAtMat4v:function(a,b,c,e){e||(e=d.mat4());var f=a[0],g=a[1],h=a[2],i=c[0],j=c[1],k=c[2],l=b[0],m=b[1],n=b[2];if(f===l&&g===m&&h===n)return d.identityMat4();var o,p,q,r,s,t,u,v,w,x;return o=f-l,p=g-m,q=h-n,x=1/Math.sqrt(o*o+p*p+q*q),o*=x,p*=x,q*=x,r=j*q-k*p,s=k*o-i*q,t=i*p-j*o,x=Math.sqrt(r*r+s*s+t*t),x?(x=1/x,r*=x,s*=x,t*=x):(r=0,s=0,t=0),u=p*t-q*s,v=q*r-o*t,w=o*s-p*r,x=Math.sqrt(u*u+v*v+w*w),x?(x=1/x,u*=x,v*=x,w*=x):(u=0,v=0,w=0),e[0]=r,e[1]=u,e[2]=o,e[3]=0,e[4]=s,e[5]=v,e[6]=p,e[7]=0,e[8]=t,e[9]=w,e[10]=q,e[11]=0,e[12]=-(r*f+s*g+t*h),e[13]=-(u*f+v*g+w*h),e[14]=-(o*f+p*g+q*h),e[15]=1,e},lookAtMat4c:function(a,b,c,e,f,g,h,i,j){return d.lookAtMat4v([a,b,c],[e,f,g],[h,i,j],[])},orthoMat4c:function(a,b,c,e,f,g,h){h||(h=d.mat4());var i=b-a,j=e-c,k=g-f;return h[0]=2/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2/j,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=-2/k,h[11]=0,h[12]=-(a+b)/i,h[13]=-(e+c)/j,h[14]=-(g+f)/k,h[15]=1,h},frustumMat4v:function(c,e,f){f||(f=d.mat4());var g=[c[0],c[1],c[2],0],h=[e[0],e[1],e[2],0];d.addVec4(h,g,a),d.subVec4(h,g,b);var i=2*g[2],j=b[0],k=b[1],l=b[2];return f[0]=i/j,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=i/k,f[6]=0,f[7]=0,f[8]=a[0]/j,f[9]=a[1]/k,f[10]=-a[2]/l,f[11]=-1,f[12]=0,f[13]=0,f[14]=-i*h[2]/l,f[15]=0,f},frustumMat4:function(a,b,c,e,f,g,h){h||(h=d.mat4());var i=b-a,j=e-c,k=g-f;return h[0]=2*f/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2*f/j,h[6]=0,h[7]=0,h[8]=(b+a)/i,h[9]=(e+c)/j,h[10]=-(g+f)/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-g*f*2/k,h[15]=0,h},perspectiveMat4:function(a,b,c,e,f){var g=[],h=[];return g[2]=c,h[2]=e,h[1]=g[2]*Math.tan(a/2),g[1]=-h[1],h[0]=h[1]*b,g[0]=-h[0],d.frustumMat4v(g,h,f)},transformPoint3:function(a,b,c){return c=c||d.vec3(),c[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12],c[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13],c[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14],c},transformPoint4:function(a,b,c){return c=c||d.vec4(),c[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3],c[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3],c[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3],c[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3],c},transformPoints3:function(a,b,c){for(var d,e,f,g,h,i=c||[],j=b.length,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=a[12],x=a[13],y=a[14],z=a[15],A=0;A<j;++A)g=b[A],d=g[0],e=g[1],f=g[2],h=i[A]||(i[A]=[0,0,0]),h[0]=k*d+o*e+s*f+w,h[1]=l*d+p*e+t*f+x,h[2]=m*d+q*e+u*f+y,h[3]=n*d+r*e+v*f+z;return i.length=j,i},transformPositions3:function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=3)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},transformPositions4:function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=4)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},transformVec3:function(a,b,c){var d=b[0],e=b[1],f=b[2];return c=c||this.vec3(),c[0]=a[0]*d+a[4]*e+a[8]*f,c[1]=a[1]*d+a[5]*e+a[9]*f,c[2]=a[2]*d+a[6]*e+a[10]*f,c},transformVec4:function(a,b,c){var e=b[0],f=b[1],g=b[2],h=b[3];return c=c||d.vec4(),c[0]=a[0]*e+a[4]*f+a[8]*g+a[12]*h,c[1]=a[1]*e+a[5]*f+a[9]*g+a[13]*h,c[2]=a[2]*e+a[6]*f+a[10]*g+a[14]*h,c[3]=a[3]*e+a[7]*f+a[11]*g+a[15]*h,c},rotateVec3X:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[0],f[1]=e[1]*Math.cos(c)-e[2]*Math.sin(c),f[2]=e[1]*Math.sin(c)+e[2]*Math.cos(c),d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},rotateVec3Y:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[2]*Math.sin(c)+e[0]*Math.cos(c),f[1]=e[1],f[2]=e[2]*Math.cos(c)-e[0]*Math.sin(c),d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},rotateVec3Z:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[0]*Math.cos(c)-e[1]*Math.sin(c),f[1]=e[0]*Math.sin(c)+e[1]*Math.cos(c),f[2]=e[2],d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},projectVec4:function(a,b){var c=1/a[3];return b=b||d.vec2(),b[0]=v[0]*c,b[1]=v[1]*c,b},lerpVec3:function(a,b,c,e,f,g){var h=g||d.vec3(),i=(a-b)/(c-b);return h[0]=e[0]+i*(f[0]-e[0]),h[1]=e[1]+i*(f[1]-e[1]),h[2]=e[2]+i*(f[2]-e[2]),h},flatten:function(a){var b,c,d,e,f,g=[];for(b=0,c=a.length;b<c;b++)for(f=a[b],d=0,e=f.length;d<e;d++)g.push(f[d]);return g},identityQuaternion:function(a){return a=a||d.vec4(),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},eulerToQuaternion:function(a,b,c){c=c||d.vec4();var e=a[0]*d.DEGTORAD/2,f=a[1]*d.DEGTORAD/2,g=a[2]*d.DEGTORAD/2,h=Math.cos(e),i=Math.cos(f),j=Math.cos(g),k=Math.sin(e),l=Math.sin(f),m=Math.sin(g);return"XYZ"===b?(c[0]=k*i*j+h*l*m,c[1]=h*l*j-k*i*m,c[2]=h*i*m+k*l*j,c[3]=h*i*j-k*l*m):"YXZ"===b?(c[0]=k*i*j+h*l*m,c[1]=h*l*j-k*i*m,c[2]=h*i*m-k*l*j,c[3]=h*i*j+k*l*m):"ZXY"===b?(c[0]=k*i*j-h*l*m,c[1]=h*l*j+k*i*m,c[2]=h*i*m+k*l*j,c[3]=h*i*j-k*l*m):"ZYX"===b?(c[0]=k*i*j-h*l*m,c[1]=h*l*j+k*i*m,c[2]=h*i*m-k*l*j,c[3]=h*i*j+k*l*m):"YZX"===b?(c[0]=k*i*j+h*l*m,c[1]=h*l*j+k*i*m,c[2]=h*i*m-k*l*j,c[3]=h*i*j-k*l*m):"XZY"===b&&(c[0]=k*i*j-h*l*m,c[1]=h*l*j-k*i*m,c[2]=h*i*m+k*l*j,c[3]=h*i*j+k*l*m),c},mat4ToQuaternion:function(a,b){b=b||d.vec4();var c,e=a[0],f=a[4],g=a[8],h=a[1],i=a[5],j=a[9],k=a[2],l=a[6],m=a[10],n=e+i+m;return n>0?(c=.5/Math.sqrt(n+1),b[3]=.25/c,b[0]=(l-j)*c,b[1]=(g-k)*c,b[2]=(h-f)*c):e>i&&e>m?(c=2*Math.sqrt(1+e-i-m),b[3]=(l-j)/c,b[0]=.25*c,b[1]=(f+h)/c,b[2]=(g+k)/c):i>m?(c=2*Math.sqrt(1+i-e-m),b[3]=(g-k)/c,b[0]=(f+h)/c,b[1]=.25*c,b[2]=(j+l)/c):(c=2*Math.sqrt(1+m-e-i),b[3]=(h-f)/c,b[0]=(g+k)/c,b[1]=(j+l)/c,b[2]=.25*c),b},vec3PairToQuaternion:function(a,b,c){c=c||d.vec4();var e=Math.sqrt(d.dotVec3(a,a)*d.dotVec3(b,b)),f=e+d.dotVec3(a,b);return f<1e-8*e?(f=0,Math.abs(a[0])>Math.abs(a[2])?(c[0]=-a[1],c[1]=a[0],c[2]=0):(c[0]=0,c[1]=-a[2],c[2]=a[1])):d.cross3Vec3(a,b,c),c[3]=f,d.normalizeQuaternion(c)},angleAxisToQuaternion:function(a,b){b=b||d.vec4();var c=a[3]/2,e=Math.sin(c);return b[0]=e*a[0],b[1]=e*a[1],b[2]=e*a[2],b[3]=Math.cos(c),b},quaternionToEuler:function(a,b,c){c=c||d.vec4();var e=a[3]/2,f=Math.sin(e);return c[0]=f*a[0],c[1]=f*a[1],c[2]=f*a[2],c[3]=Math.cos(e),c},mulQuaternions:function(a,b,c){c=c||d.vec4();var e=a[0],f=a[1],g=a[2],h=a[3],i=b[0],j=b[1],k=b[2],l=b[3];return c[0]=h*i+e*l+f*k-g*j,c[1]=h*j+f*l+g*i-e*k,c[2]=h*k+g*l+e*j-f*i,c[3]=h*l-e*i-f*j-g*k,c},vec3ApplyQuaternion:function(a,b,c){c=c||d.vec3();var e=b[0],f=b[1],g=b[2],h=a[0],i=a[1],j=a[2],k=a[3],l=k*e+i*g-j*f,m=k*f+j*e-h*g,n=k*g+h*f-i*e,o=-h*e-i*f-j*g;return c[0]=l*k+o*-h+m*-j-n*-i,c[1]=m*k+o*-i+n*-h-l*-j,c[2]=n*k+o*-j+l*-i-m*-h,c},quaternionToMat4:function(a,b){b=d.identityMat4(b);var c=a[0],e=a[1],f=a[2],g=a[3],h=2*c,i=2*e,j=2*f,k=h*g,l=i*g,m=j*g,n=h*c,o=i*c,p=j*c,q=i*e,r=j*e,s=j*f;return b[0]=1-(q+s),b[1]=o+m,b[2]=p-l,b[4]=o-m,b[5]=1-(n+s),b[6]=r+k,b[8]=p+l,b[9]=r-k,b[10]=1-(n+q),b},quaternionToRotationMat4:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return b[0]=1-(m+o),b[4]=k-r,b[8]=l+q,b[1]=k+r,b[5]=1-(j+o),b[9]=n-p,b[2]=l-q,b[6]=n+p,b[10]=1-(j+m),b[3]=0,b[7]=0,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},normalizeQuaternion:function(a,b){b=b||a;var c=d.lenVec4([a[0],a[1],a[2],a[3]]);return b[0]=a[0]/c,b[1]=a[1]/c,b[2]=a[2]/c,b[3]=a[3]/c,b},conjugateQuaternion:function(a,b){return b=b||a,b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=a[3],b},inverseQuaternion:function(a,b){return d.normalizeQuaternion(d.conjugateQuaternion(a,b))},quaternionToAngleAxis:function(a,b){b=b||d.vec4(),a=d.normalizeQuaternion(a,c);var e=a[3],f=2*Math.acos(e),g=Math.sqrt(1-e*e);return g<.001?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=a[0]/g,b[0]=a[1]/g,b[0]=a[2]/g),b[3]=f,b},decompressPosition:function(a,b,c){c[0]=a[0]*b[0]+b[12],c[1]=a[1]*b[5]+b[13],c[2]=a[2]*b[10]+b[14]},decompressPositions:function(a,b,c){c=c||new Float32Array(a.length);for(var d=0,e=a.length;d<e;d+=3)c[d+0]=a[d+0]*b[0]+b[12],c[d+1]=a[d+1]*b[5]+b[13],c[d+2]=a[d+2]*b[10]+b[14];return c},decompressUV:function(a,b,c){c[0]=a[0]*b[0]+b[6],c[1]=a[1]*b[4]+b[7]},decompressUVs:function(a,b,c){c=c||new Float32Array(a.length);for(var d=0,e=a.length;d<e;d+=3)c[d+0]=a[d+0]*b[0]+b[6],c[d+1]=a[d+1]*b[4]+b[7];return c},octDecodeVec2:function(a,b){var c=a[0],d=a[1];c=(2*c+1)/255,d=(2*d+1)/255;var e=1-Math.abs(c)-Math.abs(d);e<0&&(c=(1-Math.abs(d))*(c>=0?1:-1),d=(1-Math.abs(c))*(d>=0?1:-1));var f=Math.sqrt(c*c+d*d+e*e);return b[0]=c/f,b[1]=d/f,b[2]=e/f,b},octDecodeVec2s:function(a,b){for(var c=0,d=0,e=a.length;c<e;c+=2){var f=a[c+0],g=a[c+1];f=(2*f+1)/255,g=(2*g+1)/255;var h=1-Math.abs(f)-Math.abs(g);h<0&&(f=(1-Math.abs(g))*(f>=0?1:-1),g=(1-Math.abs(f))*(g>=0?1:-1));var i=Math.sqrt(f*f+g*g+h*h);b[d+0]=f/i,b[d+1]=g/i,b[d+2]=h/i,d+=3}return b}}}(),function(){"use strict";var a=xeogl.math;a.AABB3=function(a){return new Float32Array(a||6)},
a.AABB2=function(a){return new Float32Array(a||4)},a.OBB3=function(a){return new Float32Array(a||32)},a.OBB2=function(a){return new Float32Array(a||16)},a.transformOBB3=function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=4)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},a.getAABB3Diag=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e){return b[0]=e[0],b[1]=e[1],b[2]=e[2],c[0]=e[3],c[1]=e[4],c[2]=e[5],a.subVec3(c,b,d),Math.abs(a.lenVec3(d))}}(),a.getAABB3DiagPoint=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e,f){b[0]=e[0],b[1]=e[1],b[2]=e[2],c[0]=e[3],c[1]=e[4],c[2]=e[5];var g=a.subVec3(c,b,d),h=f[0]-e[0],i=e[3]-f[0],j=f[1]-e[1],k=e[4]-f[1],l=f[2]-e[2],m=e[5]-f[2];return g[0]+=h>i?h:i,g[1]+=j>k?j:k,g[2]+=l>m?l:m,Math.abs(a.lenVec3(g))}}(),a.getAABB3Center=function(b,c){var d=c||a.vec3();return d[0]=(b[0]+b[3])/2,d[1]=(b[1]+b[4])/2,d[2]=(b[2]+b[5])/2,d},a.getAABB2Center=function(b,c){var d=c||a.vec2();return d[0]=(b[2]+b[0])/2,d[1]=(b[3]+b[1])/2,d},a.collapseAABB3=function(b){return b=b||a.AABB3(),b[0]=xeogl.math.MAX_DOUBLE,b[1]=xeogl.math.MAX_DOUBLE,b[2]=xeogl.math.MAX_DOUBLE,b[3]=-xeogl.math.MAX_DOUBLE,b[4]=-xeogl.math.MAX_DOUBLE,b[5]=-xeogl.math.MAX_DOUBLE,b},a.AABB3ToOBB3=function(b,c){return c=c||a.OBB3(),c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=1,c[4]=b[3],c[5]=b[1],c[6]=b[2],c[7]=1,c[8]=b[3],c[9]=b[4],c[10]=b[2],c[11]=1,c[12]=b[0],c[13]=b[4],c[14]=b[2],c[15]=1,c[16]=b[0],c[17]=b[1],c[18]=b[5],c[19]=1,c[20]=b[3],c[21]=b[1],c[22]=b[5],c[23]=1,c[24]=b[3],c[25]=b[4],c[26]=b[5],c[27]=1,c[28]=b[0],c[29]=b[4],c[30]=b[5],c[31]=1,c},a.positions3ToAABB3=function(){var b=new Float32Array(3);return function(c,d,e){d=d||a.AABB3();for(var f,g,h,i=xeogl.math.MAX_DOUBLE,j=xeogl.math.MAX_DOUBLE,k=xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,m=-xeogl.math.MAX_DOUBLE,n=-xeogl.math.MAX_DOUBLE,o=0,p=c.length;o<p;o+=3)e?(b[0]=c[o+0],b[1]=c[o+1],b[2]=c[o+2],a.decompressPosition(b,e,b),f=b[0],g=b[1],h=b[2]):(f=c[o+0],g=c[o+1],h=c[o+2]),f<i&&(i=f),g<j&&(j=g),h<k&&(k=h),f>l&&(l=f),g>m&&(m=g),h>n&&(n=h);return d[0]=i,d[1]=j,d[2]=k,d[3]=l,d[4]=m,d[5]=n,d}}(),a.OBB3ToAABB3=function(b,c){c=c||a.AABB3();for(var d,e,f,g=xeogl.math.MAX_DOUBLE,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,m=0,n=b.length;m<n;m+=4)d=b[m+0],e=b[m+1],f=b[m+2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.points3ToAABB3=function(b,c){c=c||a.AABB3();for(var d,e,f,g=xeogl.math.MAX_DOUBLE,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,m=0,n=b.length;m<n;m++)d=b[m][0],e=b[m][1],f=b[m][2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.points3ToSphere3=function(){var b=new Float32Array(3);return function(c,d){d=d||a.vec4();var e,f=0,g=0,h=0,i=c.length;for(e=0;e<i;e++)f+=c[e][0],g+=c[e][1],h+=c[e][2];d[0]=f/i,d[1]=g/i,d[2]=h/i;var j,k=0;for(e=0;e<i;e++)(j=Math.abs(a.lenVec3(a.subVec3(c[e],d,b))))>k&&(k=j);return d[3]=k,d}}(),a.OBB3ToSphere3=function(){var b=new Float32Array(3),c=new Float32Array(3);return function(d,e){e=e||a.vec4();var f,g=0,h=0,i=0,j=d.length,k=j/4;for(f=0;f<j;f+=4)g+=d[f+0],h+=d[f+1],i+=d[f+2];e[0]=g/k,e[1]=h/k,e[2]=i/k;var l,m=0;for(f=0;f<j;f+=4)b[0]=d[f+0],b[1]=d[f+1],b[2]=d[f+2],(l=Math.abs(a.lenVec3(a.subVec3(b,e,c))))>m&&(m=l);return e[3]=m,e}}(),a.getSphere3Center=function(b,c){return c=c||a.vec3(),c[0]=b[0],c[1]=b[1],c[2]=b[2],c},a.expandAABB3=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]>b[2]&&(a[2]=b[2]),a[3]<b[3]&&(a[3]=b[3]),a[4]<b[4]&&(a[4]=b[4]),a[5]<b[5]&&(a[5]=b[5]),a},a.expandAABB3Point3=function(a,b){return a[0]<b[0]&&(a[0]=b[0]),a[1]<b[1]&&(a[1]=b[1]),a[2]<b[2]&&(a[2]=b[2]),a[3]>b[0]&&(a[3]=b[0]),a[4]>b[1]&&(a[4]=b[1]),a[5]>b[2]&&(a[5]=b[2]),a},a.collapseAABB2=function(b){return b=b||a.AABB2(),b[0]=xeogl.math.MAX_DOUBLE,b[1]=xeogl.math.MAX_DOUBLE,b[2]=-xeogl.math.MAX_DOUBLE,b[3]=-xeogl.math.MAX_DOUBLE,b},a.OBB3ToAABB2=function(b,c){c=c||a.AABB2();for(var d,e,f,g,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=0,m=b.length;l<m;l+=4)d=b[l+0],e=b[l+1],f=b[l+3]||1,g=1/f,d*=g,e*=g,d<h&&(h=d),e<i&&(i=e),d>j&&(j=d),e>k&&(k=e);return c[0]=h,c[1]=i,c[2]=j,c[3]=k,c},a.expandAABB2=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]<b[2]&&(a[2]=b[2]),a[3]<b[3]&&(a[3]=b[3]),a},a.expandAABB2Point2=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]<b[0]&&(a[2]=b[0]),a[3]<b[1]&&(a[3]=b[1]),a},a.AABB2ToCanvas=function(a,b,c,d){d=d||a;var e=.5*(a[0]+1),f=.5*(a[1]+1),g=.5*(a[2]+1),h=.5*(a[3]+1);return d[0]=Math.floor(e*b),d[1]=c-Math.floor(h*c),d[2]=Math.floor(g*b),d[3]=c-Math.floor(f*c),d}}(),function(){"use strict";var a=xeogl.math;a.triangleNormal=function(b,c,d,e){e=e||a.vec3();var f=c[0]-b[0],g=c[1]-b[1],h=c[2]-b[2],i=d[0]-b[0],j=d[1]-b[1],k=d[2]-b[2],l=g*k-h*j,m=h*i-f*k,n=f*j-g*i,o=Math.sqrt(l*l+m*m+n*n);return 0===o?(e[0]=0,e[1]=0,e[2]=0):(e[0]=l/o,e[1]=m/o,e[2]=n/o),e},a.rayTriangleIntersect=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3);return function(g,h,i,j,k,l){l=l||a.vec3();var m=a.subVec3(j,i,b),n=a.subVec3(k,i,c),o=a.cross3Vec3(h,n,d),p=a.dotVec3(m,o);if(p<1e-6)return null;var q=a.subVec3(g,i,e),r=a.dotVec3(q,o);if(r<0||r>p)return null;var s=a.cross3Vec3(q,m,f),t=a.dotVec3(h,s);if(t<0||r+t>p)return null;var u=a.dotVec3(n,s)/p;return l[0]=g[0]+u*h[0],l[1]=g[1]+u*h[1],l[2]=g[2]+u*h[2],l}}(),a.rayPlaneIntersect=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3);return function(f,g,h,i,j,k){k=k||a.vec3(),g=a.normalizeVec3(g,b);var l=a.subVec3(i,h,c),m=a.subVec3(j,h,d),n=a.cross3Vec3(l,m,e);a.normalizeVec3(n,n);var o=-a.dotVec3(h,n),p=-(a.dotVec3(f,n)+o)/a.dotVec3(g,n);return k[0]=f[0]+p*g[0],k[1]=f[1]+p*g[1],k[2]=f[2]+p*g[2],k}}(),a.cartesianToBarycentric=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e,f,g,h,i){var j=a.subVec3(h,f,b),k=a.subVec3(g,f,c),l=a.subVec3(e,f,d),m=a.dotVec3(j,j),n=a.dotVec3(j,k),o=a.dotVec3(j,l),p=a.dotVec3(k,k),q=a.dotVec3(k,l),r=m*p-n*n;if(0===r)return null;var s=1/r,t=(p*o-n*q)*s,u=(m*q-n*o)*s;return i[0]=1-t-u,i[1]=u,i[2]=t,i}}(),a.barycentricInsideTriangle=function(a){var b=a[1],c=a[2];return c>=0&&b>=0&&c+b<1},a.barycentricToCartesian=function(b,c,d,e,f){f=f||a.vec3();var g=b[0],h=b[1],i=b[2];return f[0]=c[0]*g+d[0]*h+e[0]*i,f[1]=c[1]*g+d[1]*h+e[1]*i,f[2]=c[2]*g+d[2]*h+e[2]*i,f}}(),function(){"use strict";var a=xeogl.math;a.buildNormals=function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3(),g=a.vec3();return function(h,i,j){var k,l,m,n,o,p=new Array(h.length/3);for(k=0,l=i.length;k<l;k+=3){m=i[k],n=i[k+1],o=i[k+2],b[0]=h[3*m],b[1]=h[3*m+1],b[2]=h[3*m+2],c[0]=h[3*n],c[1]=h[3*n+1],c[2]=h[3*n+2],d[0]=h[3*o],d[1]=h[3*o+1],d[2]=h[3*o+2],a.subVec3(c,b,e),a.subVec3(d,b,f);var q=a.vec3();a.normalizeVec3(a.cross3Vec3(e,f,g),q),p[m]||(p[m]=[]),p[n]||(p[n]=[]),p[o]||(p[o]=[]),p[m].push(q),p[n].push(q),p[o].push(q)}j=j&&j.length===h.length?j:new Float32Array(h.length);var r,s,t,u;for(k=0,l=p.length;k<l;k++){r=p[k].length,s=0,t=0,u=0;for(var v=0;v<r;v++)s+=p[k][v][0],t+=p[k][v][1],u+=p[k][v][2];j[3*k]=s/r,j[3*k+1]=t/r,j[3*k+2]=u/r}return j}}(),a.buildTangents=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3),g=new Float32Array(3),h=new Float32Array(3);return function(i,j,k){for(var l=new Float32Array(i.length),m=0;m<j.length;m+=3){var n=j[m],o=i.subarray(3*n,3*n+3),p=k.subarray(2*n,2*n+2);n=j[m+1];var q=i.subarray(3*n,3*n+3),r=k.subarray(2*n,2*n+2);n=j[m+2];for(var s,t=i.subarray(3*n,3*n+3),u=k.subarray(2*n,2*n+2),v=a.subVec3(q,o,b),w=a.subVec3(t,o,c),x=a.subVec2(r,p,d),y=a.subVec2(u,p,e),z=1/(x[0]*y[1]-x[1]*y[0]),A=a.mulVec3Scalar(a.subVec3(a.mulVec3Scalar(v,y[1],f),a.mulVec3Scalar(w,x[1],g),h),z,g),B=0;B<3;B++)s=3*j[m+B],l[s]+=A[0],l[s+1]+=A[1],l[s+2]+=A[2]}return l}}(),a.buildPickTriangles=function(a,b,c){for(var d,e,f,g,h,i,j,k,l=b.length,m=c?new Uint16Array(30*l):new Float32Array(30*l),n=new Uint8Array(40*l),o=0,p=0;p<l;p+=3)e=3*p,f=4*p,k=o>>24&255,j=o>>16&255,i=o>>8&255,h=255&o,g=b[p],d=3*g,m[e]=a[d],m[e+1]=a[d+1],m[e+2]=a[d+2],n[f+0]=h,n[f+1]=i,n[f+2]=j,n[f+3]=k,g=b[p+1],d=3*g,m[e+3]=a[d],m[e+4]=a[d+1],m[e+5]=a[d+2],n[f+4]=h,n[f+5]=i,n[f+6]=j,n[f+7]=k,g=b[p+2],d=3*g,m[e+6]=a[d],m[e+7]=a[d+1],m[e+8]=a[d+2],n[f+8]=h,n[f+9]=i,n[f+10]=j,n[f+11]=k,o++;return{positions:m,colors:n}},a.mergeVertices=function(a,b,c,d,e){var f,g,h,i,j,k,l={},m=[],n=b?[]:null,o=c?[]:null,p=[],q=4,r=Math.pow(10,q);for(j=0,k=a.length;j<k;j+=3)f=a[j],g=a[j+1],h=a[j+2],i=Math.round(f*r)+"_"+Math.round(g*r)+"_"+Math.round(h*r),void 0===l[i]?(l[i]=j/3,m.push(f),m.push(g),m.push(h),c&&(o.push(c[j]),o.push(c[j+1]),o.push(c[j+2])),p[j/3]=(m.length-3)/3):p[j/3]=p[l[i]];var s=[];for(j=0,k=e.length;j<k;j+=3){e[j+0]=p[e[j+0]],e[j+1]=p[e[j+1]],e[j+2]=p[e[j+2]];for(var t=[e[j+0],e[j+1],e[j+2]],u=0;u<3;u++)if(t[u]===t[(u+1)%3]){s.push(j);break}}if(s.length>0)for(e=Array.prototype.slice.call(e),j=s.length-1;j>=0;j--){var v=s[j];e.splice(v,3)}var w={positions:m,indices:e};return b&&(w.uv=n),c&&(w.normals=o),w},a.faceToVertexNormals=function(b,c,d){d=d||{};var e,f,g,h,i,j,k,l,m,n,o,p=d.smoothNormalsAngleThreshold||20,q={},r=[],s={},t=4,u=Math.pow(10,t);for(k=0,m=b.length;k<m;k+=3){j=k/3,f=b[k],g=b[k+1],h=b[k+2],i=Math.round(f*u)+"_"+Math.round(g*u)+"_"+Math.round(h*u),void 0===q[i]?q[i]=[j]:q[i].push(j);var v=a.normalizeVec3([c[k],c[k+1],c[k+2]]);r[j]=v,e=a.vec4([v[0],v[1],v[2],1]),s[j]=e}for(i in q)if(q.hasOwnProperty(i)){var w=q[i],x=w.length;for(k=0;k<x;k++){var y=w[k];for(e=s[y],l=0;l<x;l++)if(k!==l){var z=w[l];n=r[y],o=r[z];var A=Math.abs(a.angleVec3(n,o)/a.DEGTORAD);A<p&&(e[0]+=o[0],e[1]+=o[1],e[2]+=o[2],e[3]+=1)}}}for(k=0,m=c.length;k<m;k+=3)e=s[k/3],c[k+0]=e[0]/e[3],c[k+1]=e[1]/e[3],c[k+2]=e[2]/e[3]}}(),function(){"use strict";var a=xeogl.math;a.tangentQuadraticBezier=function(a,b,c,d){return 2*(1-a)*(c-b)+2*a*(d-c)},a.tangentQuadraticBezier=function(a,b,c,d,e){return-3*b*(1-a)*(1-a)+3*c*(1-a)*(1-a)-6*a*c*(1-a)+6*a*d*(1-a)-3*a*a*d+3*a*a*e},a.tangentSpline=function(a){return 6*a*a-6*a+(3*a*a-4*a+1)+(-6*a*a+6*a)+(3*a*a-2*a)},a.catmullRomInterpolate=function(a,b,c,d,e){var f=.5*(c-a),g=.5*(d-b),h=e*e;return(2*b-2*c+f+g)*(e*h)+(-3*b+3*c-2*f-g)*h+f*e+b},a.b2p0=function(a,b){var c=1-a;return c*c*b},a.b2p1=function(a,b){return 2*(1-a)*a*b},a.b2p2=function(a,b){return a*a*b},a.b2=function(a,b,c,d){return this.b2p0(a,b)+this.b2p1(a,c)+this.b2p2(a,d)},a.b3p0=function(a,b){var c=1-a;return c*c*c*b},a.b3p1=function(a,b){var c=1-a;return 3*c*c*a*b},a.b3p2=function(a,b){return 3*(1-a)*a*a*b},a.b3p3=function(a,b){return a*a*a*b},a.b3=function(a,b,c,d,e){return this.b3p0(a,b)+this.b3p1(a,c)+this.b3p2(a,d)+this.b3p3(a,e)}}(),function(){"use strict";var a=xeogl.math;a.canvasPosToWorldRay=function(){var b=a.mat4(),c=a.mat4(),d=a.vec4(),e=a.vec4(),f=a.vec4(),g=a.vec4();return function(h,i,j,k){var l=h.scene.canvas.canvas,m=h.viewMatrix,n="ortho"===h.projection?h.ortho.matrix:h.perspective.matrix,o=a.mulMat4(n,m,b),p=a.inverseMat4(o,c),q=l.width,r=l.height,s=(i[0]-q/2)/(q/2),t=-(i[1]-r/2)/(r/2);d[0]=s,d[1]=t,d[2]=-1,d[3]=1,a.transformVec4(p,d,e),a.mulVec4Scalar(e,1/e[3]),f[0]=s,f[1]=t,f[2]=1,f[3]=1,a.transformVec4(p,f,g),a.mulVec4Scalar(g,1/g[3]),j[0]=g[0],j[1]=g[1],j[2]=g[2],a.subVec3(g,e,k),a.normalizeVec3(k)}}(),a.canvasPosToLocalRay=function(){var b=a.vec3(),c=a.vec3();return function(d,e,f,g,h){a.canvasPosToWorldRay(d,f,b,c),a.worldRayToLocalRay(e,b,c,g,h)}}(),a.worldRayToLocalRay=function(){var b=a.mat4(),c=a.vec4(),d=a.vec4();return function(e,f,g,h,i){var j=e.transform.leafMatrix,k=a.inverseMat4(j,b);c[0]=f[0],c[1]=f[1],c[2]=f[2],c[3]=1,a.transformVec4(k,c,d),h[0]=d[0],h[1]=d[1],h[2]=d[2],a.transformVec3(k,g,i)}}()}(),function(){"use strict";function a(e,f,g,h){var i=new Float32Array(6),j={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:i};i[0]=i[1]=i[2]=Number.POSITIVE_INFINITY,i[3]=i[4]=i[5]=Number.NEGATIVE_INFINITY;var k,l;for(k=0,l=e.length;k<l;++k)for(var m=3*e[k],n=0;n<3;++n){var o=3*f[m+n];g[o]<i[0]&&(i[0]=g[o]),g[o]>i[3]&&(i[3]=g[o]),g[o+1]<i[1]&&(i[1]=g[o+1]),g[o+1]>i[4]&&(i[4]=g[o+1]),g[o+2]<i[2]&&(i[2]=g[o+2]),g[o+2]>i[5]&&(i[5]=g[o+2])}if(e.length<c||h>b)return j.triangles=e,j.leaf=!0,j;d[0]=i[3]-i[0],d[1]=i[4]-i[1],d[2]=i[5]-i[2];var p=0;d[1]>d[p]&&(p=1),d[2]>d[p]&&(p=2),j.splitDim=p;var q=(i[p]+i[p+3])/2,r=new Array(e.length),s=0,t=new Array(e.length),u=0;for(k=0,l=e.length;k<l;++k){var m=3*e[k],v=f[m],w=f[m+1],x=f[m+2],y=3*v,z=3*w,A=3*x;g[y+p]<=q||g[z+p]<=q||g[A+p]<=q?r[s++]=e[k]:t[u++]=e[k]}return r.length=s,t.length=u,j.left=a(r,f,g,h+1),j.right=a(t,f,g,h+1),j}var b=10,c=20;xeogl.math.buildKDTree=function(b,c){for(var d=b.length/3,e=new Array(d),f=0;f<d;++f)e[f]=f;return a(e,b,c,0)};var d=new Float32Array}(),xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Renderer=function(a,b,c,d){"use strict";function e(a){for(var b,c=a.lights,d=0,e=c.length;d<e;d++)b=c[d],"ambient"===b.type&&(r=b)}function f(){x&&(g(),x=!1,y=!0),y&&(h(),y=!1,z=!0),i()}function g(){u=0;for(var a in p)p.hasOwnProperty(a)&&(t[u++]=p[a]);for(var b=u,c=t.length;b<c;b++)t[b]=null;t.length=u}function h(){t.length=u,t.sort(xeogl.renderer.Object.compareState)}function i(){var a,b,c,d=m.lights.lights;for(b=0,c=d.length;b<c;b++)a=d[b],a.shadow&&j(a)}function j(a){if(a.shadow){var b=a.getShadowRenderBuf();if(b){if(b.bind(),o.reset(),o.backfaces=!0,o.frontface=!0,o.drawElements=0,o.useProgram=-1,o.shadowViewMatrix=a.getShadowViewMatrix(),o.shadowProjMatrix=a.getShadowProjMatrix(),m.viewport){var d=m.viewport.boundary;c.viewport(d[0],d[1],d[2],d[3])}else c.viewport(0,0,c.drawingBufferWidth,c.drawingBufferHeight);c.clearColor(0,0,0,1),c.enable(c.DEPTH_TEST),c.disable(c.BLEND),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);var e,f;for(e=0;e<u;e++)f=t[e],f.modes.visible&&f.modes.castShadow&&0!==f.material.alpha&&f.drawShadow(o,a);b.unbind()}}}function k(a,b,d,e,f){if(o.reset(),o.backfaces=!0,o.pickViewMatrix=d,o.pickProjMatrix=e,o.pickObjectIndex=1,m.viewport){var g=m.viewport.boundary;c.viewport(g[0],g[1],g[2],g[3])}else c.viewport(0,0,c.drawingBufferWidth,c.drawingBufferHeight);c.clearColor(0,0,0,0),c.enable(c.DEPTH_TEST),c.disable(c.CULL_FACE),c.disable(c.BLEND),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),w=0;var h,i,j,k=f.includeObjects,l=f.excludeObjects;for(h=0,i=u;h<i;h++)j=t[h],!0!==j.modes.culled&&!1!==j.modes.visible&&!1!==j.modes.pickable&&(k&&!k[j.id]||l&&l[j.id]||(v[w++]=j,j.pickObject(o)));var n=C.read(a,b),p=n[0]+256*n[1]+256*n[2]*256+256*n[3]*256*256;return p--,p>=0?v[p]:null}function l(a,b,d,e,f){if(o.reset(),o.backfaces=!0,o.frontface=!0,o.pickViewMatrix=e,o.pickProjMatrix=f,m.viewport){var g=m.viewport.boundary;c.viewport(g[0],g[1],g[2],g[3])}else c.viewport(0,0,c.drawingBufferWidth,c.drawingBufferHeight);c.clearColor(0,0,0,0),c.enable(c.DEPTH_TEST),c.disable(c.CULL_FACE),c.disable(c.BLEND),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),a.pickTriangle(o);var h=C.read(b,d),i=h[0]+256*h[1]+256*h[2]*256+256*h[3]*256*256;return i*=3}var m=this;d=d||{},a=a||{};var n=new xeogl.utils.Map({}),o=new xeogl.renderer.Frame;this.gammaOutput=!0,this.viewport=null,this.lights=null,this.viewTransform=null,this.projTransform=null,this.clips=null,this.indicesBufs=[];var p={},q=!0===d.transparent,r=null,s=xeogl.math.vec4([0,0,0,1]),t=[],u=0,v=[],w=0,x=!0,y=!0,z=!0,A=!0;this.imageForceDirty=!0;var B=!0,C=null,D=null,E=null,F=null;this.needStateSort=function(){y=!0},this.shadowsDirty=function(){A=!0},this.imageDirty=function(){z=!0},this.setImageForceDirty=function(){this.imageForceDirty=!0},this.getAmbientColor=function(){return s},this.setBlendOneMinusSrcAlpha=function(a){B=a},this.webglRestored=function(a){},this.createObject=function(a,b,d,f,g,h,i,j,k,l){var o=n.addItem({}),q=new xeogl.renderer.Object(o,a,c,m,b,d,f,g,h,i,j,k,l);return q.errors?(q.destroy(),n.removeItem(o),{errors:q.errors}):(p[o]=q,x=!0,y=!0,e(this.lights),{objectId:o})},this.destroyObject=function(a){var b=p[a];b&&(b.destroy(),delete p[a],n.removeItem(a),x=!0)},this.clear=function(a){if(a=a||{},m.viewport){var b=m.viewport.boundary;c.viewport(b[0],b[1],b[2],b[3])}else c.viewport(0,0,c.drawingBufferWidth,c.drawingBufferHeight);if(q)c.clearColor(0,0,0,0);else{var d=a.ambientColor||s;c.clearColor(d[0],d[1],d[2],1)}E&&E(a.pass),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT|c.STENCIL_BUFFER_BIT),F&&F(a.pass)},this.render=function(b){b=b||{},f(),(z||this.imageForceDirty||b.force)&&(xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&c.getExtension("OES_element_index_uint"),xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_standard_derivatives&&c.getExtension("OES_standard_derivatives"),G(b),a.frame.frameCount++,z=!1,this.imageForceDirty=!1)};var G=function(){var b=[],d=[],e=[],f=[],g=[],h=[],i=[],j=[],k=[],l=[],n=[],p=[],v=[],w=[],x=[],y=[],z=[],A=[],C=[],D=[],G=[],H=[],I=0;return function(J){if(r){var K=r.color,L=r.intensity;s[0]=K[0]*L,s[1]=K[1]*L,s[2]=K[2]*L}else s[0]=0,s[1]=0,s[2]=0;if(o.reset(),o.pass=J.pass,m.viewport){var M=m.viewport.boundary;c.viewport(M[0],M[1],M[2],M[3])}else c.viewport(0,0,c.drawingBufferWidth,c.drawingBufferHeight);q?c.clearColor(0,0,0,0):c.clearColor(s[0],s[1],s[2],1),c.enable(c.DEPTH_TEST),c.frontFace(c.CCW),c.enable(c.CULL_FACE),c.depthMask(!0);var N,O,P,Q,R,S,T=Date.now();E&&E(J.pass),!1!==J.clear&&c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT|c.STENCIL_BUFFER_BIT);var U=0,V=0,W=0,X=0,Y=0,Z=0,$=0,_=0,aa=0,ba=0,ca=0,da=0,ea=0,fa=0,ga=0,ha=0,ia=0,ja=0,ka=0,la=0,ma=0;for(I=0,N=0,O=u;N<O;N++)if(P=t[N],Q=P.modes,R=P.material,!0!==Q.culled&&!1!==Q.visible&&0!==R.alpha)if(Q.ghosted){var na=P.ghostMaterial;na.edges&&(na.edgeAlpha<1?h[Z++]=P:e[W++]=P),na.vertices&&(na.vertexAlpha<1?g[Y++]=P:d[V++]=P),na.fill&&(na.fillAlpha<1?f[X++]=P:b[U++]=P)}else{if(Q.selected){var oa=P.selectedMaterial;oa.edges&&(oa.edgeAlpha<1?A[ma++]=P:x[ja++]=P),oa.vertices&&(oa.vertexAlpha<1?z[la++]=P:w[ia++]=P),oa.fill&&(oa.fillAlpha<1?y[ka++]=P:v[ha++]=P),Q.selected&&(G[aa++]=P)}if(Q.highlighted){var pa=P.highlightMaterial;pa.edges&&(pa.edgeAlpha<1?p[ga++]=P:k[da++]=P),pa.vertices&&(pa.vertexAlpha<1?n[fa++]=P:j[ca++]=P),pa.fill&&(pa.fillAlpha<1?l[ea++]=P:i[ba++]=P),Q.highlighted&&(D[_++]=P)}S=2===P.material.alphaMode||Q.xray||Q.colorize[3]<1,S?H[I++]=P:Q.outlined?C[$++]=P:P.draw(o)}if($>0){for(c.enable(c.STENCIL_TEST),c.stencilFunc(c.ALWAYS,1,1),c.stencilOp(c.KEEP,c.KEEP,c.REPLACE),c.stencilMask(1),c.clearStencil(0),c.clear(c.STENCIL_BUFFER_BIT),N=0;N<$;N++)C[N].draw(o);for(c.stencilFunc(c.EQUAL,0,1),c.stencilOp(c.KEEP,c.KEEP,c.KEEP),c.stencilMask(0),c.disable(c.CULL_FACE),N=0;N<$;N++)C[N].drawOutline(o);c.disable(c.STENCIL_TEST)}if(U>0)for(N=0;N<U;N++)b[N].drawGhostFill(o);if(W>0)for(N=0;N<W;N++)e[N].drawGhostEdges(o);if(V>0)for(N=0;N<V;N++)d[N].drawGhostVertices(o);if(X>0||Z>0||Y>0||I>0){if(c.enable(c.CULL_FACE),c.enable(c.BLEND),B?c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA):(c.blendEquation(c.FUNC_ADD),c.blendFuncSeparate(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA,c.ONE,c.ONE_MINUS_SRC_ALPHA)),o.backfaces=!1,Y>0)for(N=0;N<Y;N++)g[N].drawGhostVertices(o);if(Z>0)for(N=0;N<Z;N++)h[N].drawGhostEdges(o);if(X>0)for(N=0;N<X;N++)f[N].drawGhostFill(o);for($=0,N=0;N<I;N++)P=H[N],P.modes.outlined?C[$++]=P:P.draw(o);c.disable(c.BLEND)}if(ba>0||da>0||ca>0){if(o.lastProgramId=null,c.clear(c.DEPTH_BUFFER_BIT),ca>0)for(N=0;N<ca;N++)j[N].drawHighlightVertices(o);if(da>0)for(N=0;N<da;N++)k[N].drawHighlightEdges(o);if(ba>0)for(N=0;N<ba;N++)i[N].drawHighlightFill(o)}if(ea>0||ga>0||fa>0){if(o.lastProgramId=null,c.clear(c.DEPTH_BUFFER_BIT),c.enable(c.CULL_FACE),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),fa>0)for(N=0;N<fa;N++)n[N].drawHighlightVertices(o);if(ga>0)for(N=0;N<ga;N++)p[N].drawHighlightEdges(o);if(ea>0)for(N=0;N<ea;N++)l[N].drawHighlightFill(o);c.disable(c.BLEND)}if(ha>0||ja>0||ia>0){if(o.lastProgramId=null,c.clear(c.DEPTH_BUFFER_BIT),ia>0)for(N=0;N<ia;N++)w[N].drawSelectedVertices(o);if(ja>0)for(N=0;N<ja;N++)x[N].drawSelectedEdges(o);if(ha>0)for(N=0;N<ha;N++)v[N].drawSelectedFill(o)}if(ka>0||ma>0||la>0){if(o.lastProgramId=null,c.clear(c.DEPTH_BUFFER_BIT),c.enable(c.CULL_FACE),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),la>0)for(N=0;N<la;N++)z[N].drawSelectedVertices(o);if(ma>0)for(N=0;N<ma;N++)A[N].drawSelectedEdges(o);if(ka>0)for(N=0;N<ka;N++)y[N].drawSelectedFill(o);c.disable(c.BLEND)}var qa=Date.now(),ra=a.frame;ra.renderTime=(qa-T)/1e3,ra.drawElements=o.drawElements,ra.drawElements=o.drawElements,ra.useProgram=o.useProgram,ra.bindTexture=o.bindTexture,ra.bindArray=o.bindArray;for(var sa=xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,ta=0;ta<sa;ta++)c.activeTexture(c.TEXTURE0+ta);c.bindTexture(c.TEXTURE_CUBE_MAP,null),c.bindTexture(c.TEXTURE_2D,null),F&&F(J.pass)}}();this.pick=function(){var a=xeogl.math,d=a.vec3(),e=a.mat4(),g=a.vec3([0,1,0]),h=a.frustumMat4(-1,1,-1,1,.1,1e4);return function(i){f(),xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&c.getExtension("OES_element_index_uint");var j,m,n,o,p,q=null,r=null;i.canvasPos?(j=i.canvasPos[0],m=i.canvasPos[1]):(n=i.origin||a.vec3([0,0,0]),o=i.direction||a.vec3([0,0,1]),p=a.addVec3(n,o,d),q=a.lookAtMat4v(n,p,g,e),r=h,j=.5*b.clientWidth,m=.5*b.clientHeight),C=C||new xeogl.renderer.RenderBuffer(b,c),C.bind();var s=k(j,m,q,r,i);if(!s)return C.unbind(),null;var t={entity:s.entityId};return i.pickSurface&&(t.primIndex=l(s,j,m,q,r)),q&&(t.origin=n,t.direction=o),C.unbind(),t}}(),this.readPixels=function(a,d,e,f){D=D||(D=new xeogl.renderer.RenderBuffer(b,c)),D.bind(),D.clear(),this.render({force:!0,opaqueOnly:f});var g,h,i,j;for(h=0;h<e;h++)i=2*h,j=4*h,g=D.read(a[i],a[i+1]),d[j]=g[0],d[j+1]=g[1],d[j+2]=g[2],d[j+3]=g[3];D.unbind(),z=!0},this.destroy=function(){C&&C.destroy(),D&&D.destroy()}},xeogl.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}},xeogl.renderer.Object=function(a,b,c,d,e,f,g,h,i,j,k,l,m){this.id=a,this.entityId=b,this.gl=c,this.scene=d,this.material=e,this.ghostMaterial=f,this.outlineMaterial=g,this.highlightMaterial=h,this.selectedMaterial=i,this.vertexBufs=j,this.geometry=k,this.modelTransform=l,this.modes=m,this.scene=d,this.gl=c,this._draw=null,this._ghostFill=null,this._ghostEdges=null,this._ghostVertices=null,this._shadow=null,this._outline=null,this._pickObject=null,this._pickTriangle=null,this._pickVertex=null,this._draw=xeogl.renderer.DrawRenderer.create(this.gl,[this.scene.gammaOutput?"gam":"",this.scene.lights.hash,this.scene.clips.hash,this.geometry.hash,this.material.hash,this.modes.hash].join(";"),this.scene,this),this._draw.errors&&(this.errors=(this.errors||[]).concat(this._draw.errors),console.error(this._draw.errors.join("\n")))},xeogl.renderer.Object.compareState=function(a,b){return a.modes.layer-b.modes.layer||a._draw.id-b._draw.id||a.material.id-b.material.id||a.vertexBufs.id-b.vertexBufs.id||a.geometry.id-b.geometry.id},xeogl.renderer.Object.prototype._getSceneHash=function(){return(this.scene.gammaInput?"gi;":";")+(this.scene.gammaOutput?"go":"")},xeogl.renderer.Object.prototype.draw=function(a){if(!this._draw&&(this._draw=xeogl.renderer.DrawRenderer.create(this.gl,[this._getSceneHash(),this.scene.lights.hash,this.scene.clips.hash,this.geometry.hash,this.material.hash,this.modes.hash].join(";"),this.scene,this),this._draw.errors))return this.errors=(this.errors||[]).concat(this._draw.errors),void console.error(this._draw.errors.join("\n"));this._draw.drawObject(a,this)},xeogl.renderer.Object.prototype.drawGhostFill=function(a){if(!this._ghostFill&&(this._ghostFill=xeogl.renderer.GhostFillRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._ghostFill.errors))return this.errors=(this.errors||[]).concat(this._ghostFill.errors),void console.error(this._ghostFill.errors.join("\n"));this._ghostFill.drawObject(a,this,0)},xeogl.renderer.Object.prototype.drawGhostEdges=function(a){if(!this._ghostEdges&&(this._ghostEdges=xeogl.renderer.GhostEdgesRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._ghostEdges.errors))return this.errors=(this.errors||[]).concat(this._ghostEdges.errors),void console.error(this._ghostEdges.errors.join("\n"));this._ghostEdges.drawObject(a,this,0)},xeogl.renderer.Object.prototype.drawGhostVertices=function(a){if(!this._ghostVertices&&(this._ghostVertices=xeogl.renderer.GhostVerticesRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._ghostVertices.errors))return this.errors=(this.errors||[]).concat(this._ghostVertices.errors),void console.error(this._ghostVertices.errors.join("\n"));this._ghostVertices.drawObject(a,this,0)},xeogl.renderer.Object.prototype.drawHighlightFill=function(a){if(!this._ghostFill&&(this._ghostFill=xeogl.renderer.GhostFillRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._ghostFill.errors))return this.errors=(this.errors||[]).concat(this._ghostFill.errors),void console.error(this._ghostFill.errors.join("\n"));this._ghostFill.drawObject(a,this,1)},xeogl.renderer.Object.prototype.drawHighlightEdges=function(a){if(!this._ghostEdges&&(this._ghostEdges=xeogl.renderer.GhostEdgesRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._ghostEdges.errors))return this.errors=(this.errors||[]).concat(this._ghostEdges.errors),void console.error(this._ghostEdges.errors.join("\n"));this._ghostEdges.drawObject(a,this,1)},xeogl.renderer.Object.prototype.drawHighlightVertices=function(a){if(!this._ghostVertices&&(this._ghostVertices=xeogl.renderer.GhostVerticesRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._ghostVertices.errors))return this.errors=(this.errors||[]).concat(this._ghostVertices.errors),void console.error(this._ghostVertices.errors.join("\n"));this._ghostVertices.drawObject(a,this,1)},xeogl.renderer.Object.prototype.drawSelectedFill=function(a){if(!this._ghostFill&&(this._ghostFill=xeogl.renderer.GhostFillRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._ghostFill.errors))return this.errors=(this.errors||[]).concat(this._ghostFill.errors),void console.error(this._ghostFill.errors.join("\n"));this._ghostFill.drawObject(a,this,2)},xeogl.renderer.Object.prototype.drawSelectedEdges=function(a){if(!this._ghostEdges&&(this._ghostEdges=xeogl.renderer.GhostEdgesRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._ghostEdges.errors))return this.errors=(this.errors||[]).concat(this._ghostEdges.errors),void console.error(this._ghostEdges.errors.join("\n"));this._ghostEdges.drawObject(a,this,2)},xeogl.renderer.Object.prototype.drawSelectedVertices=function(a){if(!this._ghostVertices&&(this._ghostVertices=xeogl.renderer.GhostVerticesRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._ghostVertices.errors))return this.errors=(this.errors||[]).concat(this._ghostVertices.errors),void console.error(this._ghostVertices.errors.join("\n"));this._ghostVertices.drawObject(a,this,2)},xeogl.renderer.Object.prototype.drawShadow=function(a,b){if(!this._shadow&&(this._shadow=xeogl.renderer.ShadowRenderer.create(this.gl,[this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._shadow.errors))return this.errors=(this.errors||[]).concat(this._shadow.errors),void console.error(this._shadow.errors.join("\n"));this._shadow.drawObject(a,this,b)},xeogl.renderer.Object.prototype.drawOutline=function(a){if(!this._outline&&(this._outline=xeogl.renderer.OutlineRenderer.create(this.gl,[this._getSceneHash(),this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._outline.errors))return this.errors=(this.errors||[]).concat(this._outline.errors),void console.error(this._outline.errors.join("\n"));this._outline.drawObject(a,this)},xeogl.renderer.Object.prototype.pickObject=function(a){if(!this._pickObject&&(this._pickObject=xeogl.renderer.PickObjectRenderer.create(this.gl,[this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._pickObject.errors))return void(this.errors=(this.errors||[]).concat(this._pickObject.errors));this._pickObject.drawObject(a,this)},xeogl.renderer.Object.prototype.pickTriangle=function(a){if(!this._pickTriangle&&(this._pickTriangle=xeogl.renderer.PickTriangleRenderer.create(this.gl,[this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._pickTriangle.errors))return this.errors=(this.errors||[]).concat(this._pickTriangle.errors),void console.error(this._pickTriangle.errors.join("\n"));this._pickTriangle.drawObject(a,this)},xeogl.renderer.Object.prototype.pickVertex=function(a){if(!this._pickVertex&&(this._pickVertex=xeogl.renderer.PickVertexRenderer.create(this.gl,[this.scene.clips.hash,this.geometry.hash,this.modes.hash].join(";"),this.scene,this),this._pickVertex.errors))return this.errors=(this.errors||[]).concat(this._pickVertex.errors),void console.error(this._pickVertex.errors.join("\n"));this._pickVertex.drawObject(a,this)},xeogl.renderer.Object.prototype.destroy=function(){this._draw&&(this._draw.destroy(),this._draw=null),this._ghostFill&&(this._ghostFill.destroy(),this._ghostFill=null),this._ghostEdges&&(this._ghostEdges.destroy(),this._ghostEdges=null),this._ghostVertices&&(this._ghostVertices.destroy(),this._ghostVertices=null),this._outline&&(this._outline.destroy(),this._outline=null),this._shadow&&(this._shadow.destroy(),this._shadow=null),this._pickObject&&(this._pickObject.destroy(),this._pickObject=null),this._pickTriangle&&(this._pickTriangle.destroy(),this._pickTriangle=null),this._pickVertex&&(this._pickVertex.destroy(),
this._pickVertex=null)},xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Frame=function(){this.reset()},xeogl.renderer.Frame.prototype.reset=function(){this.lastProgramId=null,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickObjectIndex=1},function(){"use strict";function a(a){for(var b,c,d=[],e=0,f=a.length;e<f;e++)b=a[e],c=b.indexOf("/"),c>0&&"/"===b.charAt(c+1)&&(b=b.substring(0,c)),d.push(b);return d.join("\n")}var b=new xeogl.utils.Map({});xeogl.renderer.Program=function(c,d){if(this.id=b.addItem({}),this.gl=c,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new xeogl.renderer.Shader(c,c.VERTEX_SHADER,a(d.vertex)),this._fragmentShader=new xeogl.renderer.Shader(c,c.FRAGMENT_SHADER,a(d.fragment)),!this._vertexShader.allocated)return void(this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors));if(!this._fragmentShader.allocated)return void(this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors));if(this.allocated=!0,!this._vertexShader.compiled)return void(this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors));if(!this._fragmentShader.compiled)return void(this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors));this.compiled=!0;var e,f,g,h,i;if(this.handle=c.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(c.attachShader(this.handle,this._vertexShader.handle),c.attachShader(this.handle,this._fragmentShader.handle),c.linkProgram(this.handle),this.linked=c.getProgramParameter(this.handle,c.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(c.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(d.vertex),this.errors.push("\nFragment shader:\n"),void(this.errors=this.errors.concat(d.fragment));var j=c.getProgramParameter(this.handle,c.ACTIVE_UNIFORMS);for(f=0;f<j;++f)(g=c.getActiveUniform(this.handle,f))&&(h=g.name,"\0"===h[h.length-1]&&(h=h.substr(0,h.length-1)),i=c.getUniformLocation(this.handle,h),g.type===c.SAMPLER_2D||g.type===c.SAMPLER_CUBE||35682===g.type?this.samplers[h]=new xeogl.renderer.Sampler(c,i):this.uniforms[h]=i);var k=c.getProgramParameter(this.handle,c.ACTIVE_ATTRIBUTES);for(f=0;f<k;f++)(e=c.getActiveAttrib(this.handle,f))&&(i=c.getAttribLocation(this.handle,e.name),this.attributes[e.name]=new xeogl.renderer.Attribute(c,i));this.allocated=!0},xeogl.renderer.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},xeogl.renderer.Program.prototype.getLocation=function(a){if(this.allocated)return this.uniforms[a]},xeogl.renderer.Program.prototype.getAttribute=function(a){if(this.allocated)return this.attributes[a]},xeogl.renderer.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this.samplers[a];return!!d&&d.bindTexture(b,c)},xeogl.renderer.Program.prototype.destroy=function(){this.allocated&&(b.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),xeogl.renderer.Sampler=function(a,b){this.bindTexture=function(c,d){return!!c.bind(d)&&(a.uniform1i(b,d),!0)}},xeogl.renderer.Shader=function(a,b,c){if(this.allocated=!1,this.compiled=!1,this.handle=a.createShader(b),!this.handle)return void(this.errors=["Failed to allocate"]);if(this.allocated=!0,a.shaderSource(this.handle,c),a.compileShader(this.handle),this.compiled=a.getShaderParameter(this.handle,a.COMPILE_STATUS),!this.compiled&&!a.isContextLost()){for(var d=c.split("\n"),e=[],f=0;f<d.length;f++)e.push(f+1+": "+d[f]+"\n");this.errors=[],this.errors.push(""),this.errors.push(a.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(e.join(""))}},xeogl.renderer.Shader.prototype.destroy=function(){},xeogl.renderer.State=Class.extend({__init:function(a){this.id=this._ids.addItem({}),this.hash=a.hash||""+this.id;for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])},destroy:function(){this._ids.removeItem(this.id)}}),xeogl.renderer.Visibility=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Cull=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Modes=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Lights=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Light=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.LambertMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.PhongMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.SpecularMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.MetallicMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.VerticesMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.EmphasisMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.OutlineMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.HighlightMaterial=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ViewTransform=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.ProjTransform=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Transform=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Clips=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Texture=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.CubeTexture=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Fresnel=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.VertexBufs=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Geometry=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Viewport=xeogl.renderer.State.extend({_ids:new xeogl.utils.Map({})}),xeogl.renderer.Texture2D=function(a,b){this.gl=a,this.target=b||a.TEXTURE_2D,this.texture=a.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0},xeogl.renderer.Texture2D.prototype.setPreloadColor=function(){var a=new Uint8Array([0,0,0,1]);return function(b){b?(a[0]=Math.floor(255*b[0]),a[1]=Math.floor(255*b[1]),a[2]=Math.floor(255*b[2]),a[3]=Math.floor(255*(void 0!==b[3]?b[3]:1))):(a[0]=0,a[1]=0,a[2]=0,a[3]=255);var c=this.gl;if(c.bindTexture(this.target,this.texture),c.texParameteri(this.target,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(this.target,c.TEXTURE_MIN_FILTER,c.NEAREST),this.target===c.TEXTURE_CUBE_MAP)for(var d=[c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y,c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z],e=0,f=d.length;e<f;e++)c.texImage2D(d[e],0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,a);else c.texImage2D(this.target,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,a);c.bindTexture(this.target,null)}}(),xeogl.renderer.Texture2D.prototype.setTarget=function(a){this.target=a||this.gl.TEXTURE_2D},xeogl.renderer.Texture2D.prototype.setImage=function(a,b){var c=this.gl;if(c.bindTexture(this.target,this.texture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,b.flipY),this.target===c.TEXTURE_CUBE_MAP){if(xeogl._isArray(a))for(var d=a,e=[c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y,c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z],f=0,g=e.length;f<g;f++)c.texImage2D(e[f],0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,d[f])}else c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a);c.bindTexture(this.target,null)},xeogl.renderer.Texture2D.prototype.setProps=function(a){var b=this.gl;if(b.bindTexture(this.target,this.texture),a.minFilter){var c=this._getGLEnum(a.minFilter);c&&(b.texParameteri(this.target,b.TEXTURE_MIN_FILTER,c),c!==b.NEAREST_MIPMAP_NEAREST&&c!==b.LINEAR_MIPMAP_NEAREST&&c!==b.NEAREST_MIPMAP_LINEAR&&c!==b.LINEAR_MIPMAP_LINEAR||b.generateMipmap(this.target))}if(a.magFilter){var d=this._getGLEnum(a.magFilter);d&&b.texParameteri(this.target,b.TEXTURE_MAG_FILTER,d)}if(a.wrapS){var e=this._getGLEnum(a.wrapS);e&&b.texParameteri(this.target,b.TEXTURE_WRAP_S,e)}if(a.wrapT){var f=this._getGLEnum(a.wrapT);f&&b.texParameteri(this.target,b.TEXTURE_WRAP_T,f)}b.bindTexture(this.target,null)},xeogl.renderer.Texture2D.prototype._getGLEnum=function(a,b){if(void 0===a)return b;var c=xeogl.renderer.webgl.enums[a];return void 0===c?b:this.gl[c]},xeogl.renderer.Texture2D.prototype.bind=function(a){if(this.allocated){if(this.texture){var b=this.gl;return b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,this.texture),!0}return!1}},xeogl.renderer.Texture2D.prototype.unbind=function(a){if(this.allocated&&this.texture){var b=this.gl;b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,null)}},xeogl.renderer.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},xeogl.renderer.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=xeogl.renderer.nextHighestPowerOfTwo(e),g.height=xeogl.renderer.nextHighestPowerOfTwo(f);g.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},xeogl.renderer.ensureImageSizePowerOfTwo=function(a){if(!xeogl.renderer.isPowerOfTwo(a.width)||!xeogl.renderer.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=xeogl.renderer.nextHighestPowerOfTwo(a.width),b.height=xeogl.renderer.nextHighestPowerOfTwo(a.height);b.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},xeogl.renderer.isPowerOfTwo=function(a){return 0==(a&a-1)},xeogl.renderer.nextHighestPowerOfTwo=function(a){--a;for(var b=1;b<32;b<<=1)a|=a>>b;return a+1},xeogl.renderer.ArrayBuffer=function(a,b,c,d,e,f){switch(this._gl=a,this.type=b,this.allocated=!1,c.constructor){case Uint8Array:this.itemType=a.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=a.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=a.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=a.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=a.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=a.INT,this.itemByteSize=4;break;default:this.itemType=a.FLOAT,this.itemByteSize=4}this.usage=f,this.length=0,this.numItems=0,this.itemSize=e,this._allocate(c)},xeogl.renderer.ArrayBuffer.prototype._allocate=function(a){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,a,this.usage),this._gl.bindBuffer(this.type,null),this.length=a.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},xeogl.renderer.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):(this._gl.bindBuffer(this.type,this._handle),b||0===b?this._gl.bufferSubData(this.type,b*this.itemByteSize,a):this._gl.bufferData(this.type,a,this.usage),this._gl.bindBuffer(this.type,null)))},xeogl.renderer.ArrayBuffer.prototype.bind=function(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)},xeogl.renderer.ArrayBuffer.prototype.unbind=function(){this.allocated&&this._gl.bindBuffer(this.type,null)},xeogl.renderer.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)},xeogl.renderer.Attribute=function(a,b){this._gl=a,this.location=b},xeogl.renderer.Attribute.prototype.bindArrayBuffer=function(a,b){a&&(a.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,b===this._gl.BYTE?2:a.itemSize,b||this._gl.FLOAT,b===this._gl.BYTE,0,0))},xeogl.renderer.RenderBuffer=function(a,b,c){c=c||{},this.gl=b,this.allocated=!1,this.canvas=a,this.buffer=null,this.bound=!1,this.size=c.size},xeogl.renderer.RenderBuffer.prototype.setSize=function(a){this.size=a},xeogl.renderer.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buffer=null,this.allocated=!1,this.bound=!1},xeogl.renderer.RenderBuffer.prototype.bind=function(){if(this._touch(),!this.bound){var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}},xeogl.renderer.RenderBuffer.prototype._touch=function(){var a,b,c=this.gl;if(this.size?(a=this.size[0],b=this.size[1]):(a=this.canvas.clientWidth,b=this.canvas.clientHeight),this.buffer){if(this.buffer.width===a&&this.buffer.height===b)return;c.deleteTexture(this.buffer.texture),c.deleteFramebuffer(this.buffer.framebuf),c.deleteRenderbuffer(this.buffer.renderbuf)}var d=c.createTexture();c.bindTexture(c.TEXTURE_2D,d),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,a,b,0,c.RGBA,c.UNSIGNED_BYTE,null),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);var e=c.createRenderbuffer();c.bindRenderbuffer(c.RENDERBUFFER,e),c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,a,b);var f=c.createFramebuffer();if(c.bindFramebuffer(c.FRAMEBUFFER,f),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,d,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,e),c.bindTexture(c.TEXTURE_2D,null),c.bindRenderbuffer(c.RENDERBUFFER,null),c.bindFramebuffer(c.FRAMEBUFFER,null),c.bindFramebuffer(c.FRAMEBUFFER,f),!c.isFramebuffer(f))throw"Invalid framebuffer";c.bindFramebuffer(c.FRAMEBUFFER,null);var g=c.checkFramebufferStatus(c.FRAMEBUFFER);switch(g){case c.FRAMEBUFFER_COMPLETE:break;case c.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case c.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case c.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case c.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+g}this.buffer={framebuf:f,renderbuf:e,texture:d,width:a,height:b},this.bound=!1},xeogl.renderer.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";var a=this.gl;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},xeogl.renderer.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.height-b,e=new Uint8Array(4),f=this.gl;return f.readPixels(c,d,1,1,f.RGBA,f.UNSIGNED_BYTE,e),e},xeogl.renderer.RenderBuffer.prototype.unbind=function(){var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,null),this.bound=!1},xeogl.renderer.RenderBuffer.prototype.getTexture=function(){var a=this;return{renderBuffer:this,bind:function(b){return!(!a.buffer||!a.buffer.texture)&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buffer.texture),!0)},unbind:function(b){a.buffer&&a.buffer.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},xeogl.renderer.RenderBuffer.prototype.destroy=function(){if(this.allocated){var a=this.gl;a.deleteTexture(this.buffer.texture),a.deleteFramebuffer(this.buffer.framebuf),a.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}},function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.DrawRenderer=function(a,b,c,d){this._init(a,b,c,d)};var b={};xeogl.renderer.DrawRenderer.create=function(a,c,d,e){var f=b[c];return f||(f=new xeogl.renderer.DrawRenderer(a,c,d,e),b[c]=f,xeogl.stats.memory.programs++),f._useCount++,f},xeogl.renderer.DrawRenderer.prototype.destroy=function(){--this._useCount&&(a.removeItem(this.id),this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.DrawRenderer.prototype._init=function(b,c,d,e){if(this.id=a.addItem({}),this._gl=b,this._hash=c,this._shaderSource=new xeogl.renderer.DrawShaderSource(b,d,e),this._program=new xeogl.renderer.Program(b,this._shaderSource),this._scene=d,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var f=this._program;this._uPositionsDecodeMatrix=f.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=f.getLocation("uvDecodeMatrix"),this._uModelMatrix=f.getLocation("modelMatrix"),this._uModelNormalMatrix=f.getLocation("modelNormalMatrix"),this._uViewMatrix=f.getLocation("viewMatrix"),this._uViewNormalMatrix=f.getLocation("viewNormalMatrix"),this._uProjMatrix=f.getLocation("projMatrix"),this._uGammaFactor=f.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[];for(var g,h=d.lights.lights,i=0,j=h.length;i<j;i++){switch(g=h[i],g.type){case"ambient":this._uLightAmbient[i]=f.getLocation("lightAmbient");break;case"dir":this._uLightColor[i]=f.getLocation("lightColor"+i),this._uLightPos[i]=null,this._uLightDir[i]=f.getLocation("lightDir"+i);break;case"point":this._uLightColor[i]=f.getLocation("lightColor"+i),this._uLightPos[i]=f.getLocation("lightPos"+i),this._uLightDir[i]=null,this._uLightAttenuation[i]=f.getLocation("lightAttenuation"+i);break;case"spot":this._uLightColor[i]=f.getLocation("lightColor"+i),this._uLightPos[i]=f.getLocation("lightPos"+i),this._uLightDir[i]=f.getLocation("lightDir"+i),this._uLightAttenuation[i]=f.getLocation("lightAttenuation"+i)}g.shadow&&(this._uShadowViewMatrix[i]=f.getLocation("shadowViewMatrix"+i),this._uShadowProjMatrix[i]=f.getLocation("shadowProjMatrix"+i))}d.lights.lightMap&&(this._uLightMap="lightMap"),d.lights.reflectionMap&&(this._uReflectionMap="reflectionMap"),this._uClips=[];for(var k=d.clips.clips,i=0,j=k.length;i<j;i++)this._uClips.push({active:f.getLocation("clipActive"+i),pos:f.getLocation("clipPos"+i),dir:f.getLocation("clipDir"+i)});var l=e.material;switch(this._uPointSize=f.getLocation("pointSize"),l.type){case"LambertMaterial":this._uMaterialColor=f.getLocation("materialColor"),this._uMaterialEmissive=f.getLocation("materialEmissive"),this._uAlphaModeCutoff=f.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=f.getLocation("materialAmbient"),this._uMaterialDiffuse=f.getLocation("materialDiffuse"),this._uMaterialSpecular=f.getLocation("materialSpecular"),this._uMaterialEmissive=f.getLocation("materialEmissive"),this._uAlphaModeCutoff=f.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=f.getLocation("materialShininess"),l.ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=f.getLocation("ambientMapMatrix")),l.diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=f.getLocation("diffuseMapMatrix")),l.specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=f.getLocation("specularMapMatrix")),l.emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=f.getLocation("emissiveMapMatrix")),l.alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=f.getLocation("alphaMapMatrix")),l.reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=f.getLocation("reflectivityMapMatrix")),l.normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=f.getLocation("normalMapMatrix")),l.occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=f.getLocation("occlusionMapMatrix")),l.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=f.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=f.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=f.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=f.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=f.getLocation("diffuseFresnelPower")),l.specularFresnel&&(this._uSpecularFresnelEdgeBias=f.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=f.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=f.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=f.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=f.getLocation("specularFresnelPower")),l.alphaFresnel&&(this._uAlphaFresnelEdgeBias=f.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=f.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=f.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=f.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=f.getLocation("alphaFresnelPower")),l.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=f.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=f.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=f.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=f.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=f.getLocation("reflectivityFresnelPower")),l.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=f.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=f.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=f.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=f.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=f.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=f.getLocation("materialBaseColor"),this._uMaterialMetallic=f.getLocation("materialMetallic"),this._uMaterialRoughness=f.getLocation("materialRoughness"),this._uMaterialSpecularF0=f.getLocation("materialSpecularF0"),this._uMaterialEmissive=f.getLocation("materialEmissive"),this._uAlphaModeCutoff=f.getLocation("materialAlphaModeCutoff"),l.baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=f.getLocation("baseColorMapMatrix")),l.metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=f.getLocation("metallicMapMatrix")),l.roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=f.getLocation("roughnessMapMatrix")),l.metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=f.getLocation("metallicRoughnessMapMatrix")),l.emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=f.getLocation("emissiveMapMatrix")),l.occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=f.getLocation("occlusionMapMatrix")),l.alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=f.getLocation("alphaMapMatrix")),l.normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=f.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=f.getLocation("materialDiffuse"),this._uMaterialSpecular=f.getLocation("materialSpecular"),this._uMaterialGlossiness=f.getLocation("materialGlossiness"),this._uMaterialReflectivity=f.getLocation("reflectivityFresnel"),this._uMaterialEmissive=f.getLocation("materialEmissive"),this._uAlphaModeCutoff=f.getLocation("materialAlphaModeCutoff"),l.diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=f.getLocation("diffuseMapMatrix")),l.specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=f.getLocation("specularMapMatrix")),l.glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=f.getLocation("glossinessMapMatrix")),l.specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=f.getLocation("materialSpecularGlossinessMapMatrix")),l.emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=f.getLocation("emissiveMapMatrix")),l.occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=f.getLocation("occlusionMapMatrix")),l.alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=f.getLocation("alphaMapMatrix")),l.normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=f.getLocation("normalMapMatrix"))}this._aPosition=f.getAttribute("position"),this._aNormal=f.getAttribute("normal"),this._aUV=f.getAttribute("uv"),this._aColor=f.getAttribute("color"),this._aFlags=f.getAttribute("flags"),this._uClippable=f.getLocation("clippable"),this._uColorize=f.getLocation("colorize"),this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0},xeogl.renderer.DrawRenderer.prototype._bindProgram=function(a){var b=this._program;b.bind(),a.useProgram++,a.textureUnit=0;var c,d=this._gl,e=xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,f=this._scene,g=f.lights;this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,d.uniformMatrix4fv(this._uViewMatrix,!1,f.viewTransform.matrix),d.uniformMatrix4fv(this._uViewNormalMatrix,!1,f.viewTransform.normalMatrix),d.uniformMatrix4fv(this._uProjMatrix,!1,f.projTransform.matrix);for(var h=0,i=g.lights.length;h<i;h++)if(c=g.lights[h],this._uLightAmbient[h])d.uniform4f(this._uLightAmbient[h],c.color[0],c.color[1],c.color[2],c.intensity);else if(this._uLightColor[h]&&d.uniform4f(this._uLightColor[h],c.color[0],c.color[1],c.color[2],c.intensity),this._uLightPos[h]&&(d.uniform3fv(this._uLightPos[h],c.pos),this._uLightAttenuation[h]&&d.uniform1f(this._uLightAttenuation[h],c.attenuation)),this._uLightDir[h]&&d.uniform3fv(this._uLightDir[h],c.dir),c.shadow){this._uShadowViewMatrix[h]&&d.uniformMatrix4fv(this._uShadowViewMatrix[h],!1,c.getShadowViewMatrix()),this._uShadowProjMatrix[h]&&d.uniformMatrix4fv(this._uShadowProjMatrix[h],!1,c.getShadowProjMatrix());var j=c.getShadowRenderBuf();j&&(b.bindTexture("shadowMap"+h,j.getTexture(),a.textureUnit),a.textureUnit=(a.textureUnit+1)%e,a.bindTexture++)}if(g.lightMap&&g.lightMap.texture&&this._uLightMap&&(b.bindTexture(this._uLightMap,g.lightMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%e,a.bindTexture++),g.reflectionMap&&g.reflectionMap.texture&&this._uReflectionMap&&(b.bindTexture(this._uReflectionMap,g.reflectionMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%e,a.bindTexture++),f.clips.clips.length>0)for(var k,l,m,n,o=f.clips.clips,h=0,i=this._uClips.length;h<i;h++)k=this._uClips[h],l=k.active,m=o[h],l&&d.uniform1i(l,m.active),n=k.pos,n&&d.uniform3fv(k.pos,m.pos),k.dir&&d.uniform3fv(k.dir,m.dir);this._uGammaFactor&&d.uniform1f(this._uGammaFactor,f.gammaFactor),this._baseTextureUnit=a.textureUnit},xeogl.renderer.DrawRenderer.prototype.drawObject=function(a,b){a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a));var c=xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,d=this._gl,e=this._program,f=b.material,g=b.modelTransform,h=b.geometry;if(f.id!==this._lastMaterialId){a.textureUnit=this._baseTextureUnit;var i=f.backfaces;a.backfaces!==i&&(i?d.disable(d.CULL_FACE):d.enable(d.CULL_FACE),a.backfaces=i);var j=f.frontface;switch(a.frontface!==j&&(j?d.frontFace(d.CCW):d.frontFace(d.CW),a.frontface=j),a.lineWidth!==f.lineWidth&&(d.lineWidth(f.lineWidth),a.lineWidth=f.lineWidth),this._uPointSize&&d.uniform1f(this._uPointSize,f.pointSize),f.type){case"LambertMaterial":this._uMaterialAmbient&&d.uniform3fv(this._uMaterialAmbient,f.ambient),this._uMaterialColor&&d.uniform4f(this._uMaterialColor,f.color[0],f.color[1],f.color[2],f.alpha),this._uMaterialEmissive&&d.uniform3fv(this._uMaterialEmissive,f.emissive);break;case"PhongMaterial":this._uMaterialShininess&&d.uniform1f(this._uMaterialShininess,f.shininess),this._uMaterialAmbient&&d.uniform3fv(this._uMaterialAmbient,f.ambient),this._uMaterialDiffuse&&d.uniform3fv(this._uMaterialDiffuse,f.diffuse),this._uMaterialSpecular&&d.uniform3fv(this._uMaterialSpecular,f.specular),this._uMaterialEmissive&&d.uniform3fv(this._uMaterialEmissive,f.emissive),this._uAlphaModeCutoff&&d.uniform4f(this._uAlphaModeCutoff,1*f.alpha,1===f.alphaMode?1:0,f.alphaCutoff,0),f.ambientMap&&f.ambientMap.texture&&this._uMaterialAmbientMap&&(e.bindTexture(this._uMaterialAmbientMap,f.ambientMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uMaterialAmbientMapMatrix&&d.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,f.ambientMap.matrix)),f.diffuseMap&&f.diffuseMap.texture&&this._uDiffuseMap&&(e.bindTexture(this._uDiffuseMap,f.diffuseMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uDiffuseMapMatrix&&d.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,f.diffuseMap.matrix)),f.specularMap&&f.specularMap.texture&&this._uSpecularMap&&(e.bindTexture(this._uSpecularMap,f.specularMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uSpecularMapMatrix&&d.uniformMatrix4fv(this._uSpecularMapMatrix,!1,f.specularMap.matrix)),f.emissiveMap&&f.emissiveMap.texture&&this._uEmissiveMap&&(e.bindTexture(this._uEmissiveMap,f.emissiveMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uEmissiveMapMatrix&&d.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,f.emissiveMap.matrix)),f.alphaMap&&f.alphaMap.texture&&this._uAlphaMap&&(e.bindTexture(this._uAlphaMap,f.alphaMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uAlphaMapMatrix&&d.uniformMatrix4fv(this._uAlphaMapMatrix,!1,f.alphaMap.matrix)),f.reflectivityMap&&f.reflectivityMap.texture&&this._uReflectivityMap&&(e.bindTexture(this._uReflectivityMap,f.reflectivityMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,this._uReflectivityMapMatrix&&d.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,f.reflectivityMap.matrix)),f.normalMap&&f.normalMap.texture&&this._uNormalMap&&(e.bindTexture(this._uNormalMap,f.normalMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uNormalMapMatrix&&d.uniformMatrix4fv(this._uNormalMapMatrix,!1,f.normalMap.matrix)),f.occlusionMap&&f.occlusionMap.texture&&this._uOcclusionMap&&(e.bindTexture(this._uOcclusionMap,f.occlusionMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uOcclusionMapMatrix&&d.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,f.occlusionMap.matrix)),f.diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&d.uniform1f(this._uDiffuseFresnelEdgeBias,f.diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&d.uniform1f(this._uDiffuseFresnelCenterBias,f.diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&d.uniform3fv(this._uDiffuseFresnelEdgeColor,f.diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&d.uniform3fv(this._uDiffuseFresnelCenterColor,f.diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&d.uniform1f(this._uDiffuseFresnelPower,f.diffuseFresnel.power)),f.specularFresnel&&(this._uSpecularFresnelEdgeBias&&d.uniform1f(this._uSpecularFresnelEdgeBias,f.specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&d.uniform1f(this._uSpecularFresnelCenterBias,f.specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&d.uniform3fv(this._uSpecularFresnelEdgeColor,f.specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&d.uniform3fv(this._uSpecularFresnelCenterColor,f.specularFresnel.centerColor),this._uSpecularFresnelPower&&d.uniform1f(this._uSpecularFresnelPower,f.specularFresnel.power)),
f.alphaFresnel&&(this._uAlphaFresnelEdgeBias&&d.uniform1f(this._uAlphaFresnelEdgeBias,f.alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&d.uniform1f(this._uAlphaFresnelCenterBias,f.alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&d.uniform3fv(this._uAlphaFresnelEdgeColor,f.alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&d.uniform3fv(this._uAlphaFresnelCenterColor,f.alphaFresnel.centerColor),this._uAlphaFresnelPower&&d.uniform1f(this._uAlphaFresnelPower,f.alphaFresnel.power)),f.reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&d.uniform1f(this._uReflectivityFresnelEdgeBias,f.reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&d.uniform1f(this._uReflectivityFresnelCenterBias,f.reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&d.uniform3fv(this._uReflectivityFresnelEdgeColor,f.reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&d.uniform3fv(this._uReflectivityFresnelCenterColor,f.reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&d.uniform1f(this._uReflectivityFresnelPower,f.reflectivityFresnel.power)),f.emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&d.uniform1f(this._uEmissiveFresnelEdgeBias,f.emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&d.uniform1f(this._uEmissiveFresnelCenterBias,f.emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&d.uniform3fv(this._uEmissiveFresnelEdgeColor,f.emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&d.uniform3fv(this._uEmissiveFresnelCenterColor,f.emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&d.uniform1f(this._uEmissiveFresnelPower,f.emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&d.uniform3fv(this._uBaseColor,f.baseColor),this._uMaterialMetallic&&d.uniform1f(this._uMaterialMetallic,f.metallic),this._uMaterialRoughness&&d.uniform1f(this._uMaterialRoughness,f.roughness),this._uMaterialSpecularF0&&d.uniform1f(this._uMaterialSpecularF0,f.specularF0),this._uMaterialEmissive&&d.uniform3fv(this._uMaterialEmissive,f.emissive),this._uAlphaModeCutoff&&d.uniform4f(this._uAlphaModeCutoff,1*f.alpha,1===f.alphaMode?1:0,f.alphaCutoff,0),f.baseColorMap&&f.baseColorMap.texture&&this._uBaseColorMap&&(e.bindTexture(this._uBaseColorMap,f.baseColorMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uBaseColorMapMatrix&&d.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,f.baseColorMap.matrix)),f.metallicMap&&f.metallicMap.texture&&this._uMetallicMap&&(e.bindTexture(this._uMetallicMap,f.metallicMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uMetallicMapMatrix&&d.uniformMatrix4fv(this._uMetallicMapMatrix,!1,f.metallicMap.matrix)),f.roughnessMap&&f.roughnessMap.texture&&this._uRoughnessMap&&(e.bindTexture(this._uRoughnessMap,f.roughnessMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uRoughnessMapMatrix&&d.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,f.roughnessMap.matrix)),f.metallicRoughnessMap&&f.metallicRoughnessMap.texture&&this._uMetallicRoughnessMap&&(e.bindTexture(this._uMetallicRoughnessMap,f.metallicRoughnessMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uMetallicRoughnessMapMatrix&&d.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,f.metallicRoughnessMap.matrix)),f.emissiveMap&&f.emissiveMap.texture&&this._uEmissiveMap&&(e.bindTexture(this._uEmissiveMap,f.emissiveMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uEmissiveMapMatrix&&d.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,f.emissiveMap.matrix)),f.occlusionMap&&f.occlusionMap.texture&&this._uOcclusionMap&&(e.bindTexture(this._uOcclusionMap,f.occlusionMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uOcclusionMapMatrix&&d.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,f.occlusionMap.matrix)),f.alphaMap&&f.alphaMap.texture&&this._uAlphaMap&&(e.bindTexture(this._uAlphaMap,f.alphaMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uAlphaMapMatrix&&d.uniformMatrix4fv(this._uAlphaMapMatrix,!1,f.alphaMap.matrix)),f.normalMap&&f.normalMap.texture&&this._uNormalMap&&(e.bindTexture(this._uNormalMap,f.normalMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uNormalMapMatrix&&d.uniformMatrix4fv(this._uNormalMapMatrix,!1,f.normalMap.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&d.uniform3fv(this._uMaterialDiffuse,f.diffuse),this._uMaterialSpecular&&d.uniform3fv(this._uMaterialSpecular,f.specular),this._uMaterialGlossiness&&d.uniform1f(this._uMaterialGlossiness,f.glossiness),this._uMaterialReflectivity&&d.uniform1f(this._uMaterialReflectivity,f.reflectivity),this._uMaterialEmissive&&d.uniform3fv(this._uMaterialEmissive,f.emissive),this._uAlphaModeCutoff&&d.uniform4f(this._uAlphaModeCutoff,1*f.alpha,1===f.alphaMode?1:0,f.alphaCutoff,0),f.diffuseMap&&f.diffuseMap.texture&&this._uDiffuseMap&&(e.bindTexture(this._uDiffuseMap,f.diffuseMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uDiffuseMapMatrix&&d.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,f.diffuseMap.matrix)),f.specularMap&&f.specularMap.texture&&this._uSpecularMap&&(e.bindTexture(this._uSpecularMap,f.specularMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uSpecularMapMatrix&&d.uniformMatrix4fv(this._uSpecularMapMatrix,!1,f.specularMap.matrix)),f.glossinessMap&&f.glossinessMap.texture&&this._uGlossinessMap&&(e.bindTexture(this._uGlossinessMap,f.glossinessMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uGlossinessMapMatrix&&d.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,f.glossinessMap.matrix)),f.specularGlossinessMap&&f.specularGlossinessMap.texture&&this._uSpecularGlossinessMap&&(e.bindTexture(this._uSpecularGlossinessMap,f.specularGlossinessMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uSpecularGlossinessMapMatrix&&d.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,f.specularGlossinessMap.matrix)),f.emissiveMap&&f.emissiveMap.texture&&this._uEmissiveMap&&(e.bindTexture(this._uEmissiveMap,f.emissiveMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uEmissiveMapMatrix&&d.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,f.emissiveMap.matrix)),f.occlusionMap&&f.occlusionMap.texture&&this._uOcclusionMap&&(e.bindTexture(this._uOcclusionMap,f.occlusionMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uOcclusionMapMatrix&&d.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,f.occlusionMap.matrix)),f.alphaMap&&f.alphaMap.texture&&this._uAlphaMap&&(e.bindTexture(this._uAlphaMap,f.alphaMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uAlphaMapMatrix&&d.uniformMatrix4fv(this._uAlphaMapMatrix,!1,f.alphaMap.matrix)),f.normalMap&&f.normalMap.texture&&this._uNormalMap&&(e.bindTexture(this._uNormalMap,f.normalMap.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uNormalMapMatrix&&d.uniformMatrix4fv(this._uNormalMapMatrix,!1,f.normalMap.matrix))}this._lastMaterialId=f.id}g.id!==this._lastModelTransformId&&(d.uniformMatrix4fv(this._uModelMatrix,d.FALSE,g.getMatrix()),this._uModelNormalMatrix&&d.uniformMatrix4fv(this._uModelNormalMatrix,d.FALSE,g.getNormalMatrix()),this._lastModelTransformId=g.id);var k=b.modes;if(this._uClippable&&d.uniform1i(this._uClippable,k.clippable),this._uColorize){var l=k.colorize,m=this._lastColorize;m[0]===l[0]&&m[1]===l[0]&&m[2]===l[0]&&m[3]===l[0]||(d.uniform4fv(this._uColorize,l),m[0]=l[0],m[1]=l[1],m[2]=l[2],m[3]=l[3])}if(h.combined){var n=b.vertexBufs;n.id!==this._lastVertexBufsId&&(n.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),n.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(n.normalsBuf,n.quantized?d.BYTE:d.FLOAT),a.bindArray++),n.uvBuf&&this._aUV&&(this._aUV.bindArrayBuffer(n.uvBuf,h.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),n.colorsBuf&&this._aColor&&(this._aColor.bindArrayBuffer(n.colorsBuf),a.bindArray++),n.flagsBuf&&this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf,d.UNSIGNED_SHORT),a.bindArray++),this._lastVertexBufsId=n.id)}h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&d.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&d.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),h.combined?h.indicesBufCombined&&(h.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf,h.quantized?d.BYTE:d.FLOAT),a.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(h.uvBuf,h.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(h.colorsBuf),a.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(h.flagsBuf),a.bindArray++),h.indicesBuf?(h.indicesBuf.bind(),a.bindArray++):h.positions),this._lastGeometryId=h.id),h.combined?h.indicesBufCombined&&(d.drawElements(h.primitive,h.indicesBufCombined.numItems,h.indicesBufCombined.itemType,0),a.drawElements++):h.indicesBuf?(d.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),a.drawElements++):h.positions&&(d.drawArrays(d.TRIANGLES,0,h.positions.numItems),a.drawArrays++)}}(),function(){"use strict";function a(a,b){if(!b.modes.receiveShadow)return!1;var c=a.lights.lights;if(!c)return!1;for(var d=0,e=c.length;d<e;d++)if(c[d].shadow)return!0;return!1}function b(a){if(!a.geometry.uv)return!1;var b=a.material;return!!(b.ambientMap||b.occlusionMap||b.baseColorMap||b.diffuseMap||b.alphaMap||b.specularMap||b.glossinessMap||b.specularGlossinessMap||b.emissiveMap||b.metallicMap||b.roughnessMap||b.metallicRoughnessMap||b.reflectivityMap||a.material.normalMap)}function c(a){return!1}function d(a){var b=a.geometry.primitiveName;return!(!a.geometry.autoVertexNormals&&!a.geometry.normals||"triangles"!==b&&"triangle-strip"!==b&&"triangle-fan"!==b)}function e(a){var b=a.geometry;return!!(b.positions&&b.indices&&b.normals&&b.uv&&a.material.normalMap)}function f(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}function g(a,b,c,d){var e,f,g,h=c.lights.lights,i=d.modes.billboard,j=[];if(j.push("// Lambertian drawing vertex shader"),j.push("attribute vec3 position;"),j.push("uniform mat4 modelMatrix;"),j.push("uniform mat4 viewMatrix;"),j.push("uniform mat4 projMatrix;"),j.push("uniform vec4 colorize;"),b.quantizedGeometry&&j.push("uniform mat4 positionsDecodeMatrix;"),b.clipping&&j.push("varying vec4 vWorldPosition;"),j.push("uniform vec4   lightAmbient;"),j.push("uniform vec4   materialColor;"),b.normals){for(j.push("attribute vec3 normal;"),j.push("uniform mat4 modelNormalMatrix;"),j.push("uniform mat4 viewNormalMatrix;"),e=0,f=h.length;e<f;e++)g=h[e],"ambient"!==g.type&&(j.push("uniform vec4 lightColor"+e+";"),"dir"===g.type&&j.push("uniform vec3 lightDir"+e+";"),"point"===g.type&&j.push("uniform vec3 lightPos"+e+";"),"spot"===g.type&&(j.push("uniform vec3 lightPos"+e+";"),j.push("uniform vec3 lightDir"+e+";")));b.quantizedGeometry&&(j.push("vec3 octDecode(vec2 oct) {"),j.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),j.push("    if (v.z < 0.0) {"),j.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),j.push("    }"),j.push("    return normalize(v);"),j.push("}"))}if(j.push("varying vec4 vColor;"),"points"===d.geometry.primitiveName&&j.push("uniform float pointSize;"),"spherical"!==i&&"cylindrical"!==i||(j.push("void billboard(inout mat4 mat) {"),j.push("   mat[0][0] = 1.0;"),j.push("   mat[0][1] = 0.0;"),j.push("   mat[0][2] = 0.0;"),"spherical"===i&&(j.push("   mat[1][0] = 0.0;"),j.push("   mat[1][1] = 1.0;"),j.push("   mat[1][2] = 0.0;")),j.push("   mat[2][0] = 0.0;"),j.push("   mat[2][1] = 0.0;"),j.push("   mat[2][2] =1.0;"),j.push("}")),j.push("void main(void) {"),j.push("vec4 localPosition = vec4(position, 1.0); "),j.push("vec4 worldPosition;"),b.quantizedGeometry&&j.push("localPosition = positionsDecodeMatrix * localPosition;"),b.normals&&(b.quantizedGeometry?j.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):j.push("vec4 localNormal = vec4(normal, 0.0); "),j.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),j.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),j.push("mat4 viewMatrix2 = viewMatrix;"),j.push("mat4 modelMatrix2 = modelMatrix;"),d.modes.stationary&&j.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===i||"cylindrical"===i?(j.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),j.push("billboard(modelMatrix2);"),j.push("billboard(viewMatrix2);"),j.push("billboard(modelViewMatrix);"),b.normals&&(j.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),j.push("billboard(modelNormalMatrix2);"),j.push("billboard(viewNormalMatrix2);"),j.push("billboard(modelViewNormalMatrix);")),j.push("worldPosition = modelMatrix2 * localPosition;"),j.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(j.push("worldPosition = modelMatrix2 * localPosition;"),j.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),b.normals&&j.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),j.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),j.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),j.push("float lambertian = 1.0;"),b.normals)for(e=0,f=h.length;e<f;e++)if(g=h[e],"ambient"!==g.type){if("dir"===g.type)"view"===g.space?j.push("viewLightDir = normalize(lightDir"+e+");"):j.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===g.type)"view"===g.space?j.push("viewLightDir = normalize(lightPos"+e+" - viewPosition.xyz);"):j.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==g.type)continue;"view"===g.space?j.push("viewLightDir = normalize(lightDir"+e+");"):j.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);")}j.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),j.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}return j.push("vColor = vec4((reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),b.clipping&&j.push("vWorldPosition = worldPosition;"),"points"===d.geometry.primitiveName&&j.push("gl_PointSize = pointSize;"),j.push("   gl_Position = projMatrix * viewPosition;"),j.push("}"),j}function h(a,b,c,d){var e,f=[];if(f.push("// Lambertian drawing fragment shader"),f.push("precision lowp float;"),b.clipping)for(f.push("varying vec4 vWorldPosition;"),f.push("uniform bool clippable;"),e=0;e<c.clips.clips.length;e++)f.push("uniform bool clipActive"+e+";"),f.push("uniform vec3 clipPos"+e+";"),f.push("uniform vec3 clipDir"+e+";");if(f.push("varying vec4 vColor;"),b.gammaOutput&&(f.push("uniform float gammaFactor;"),f.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),f.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),f.push("}")),f.push("void main(void) {"),b.clipping){for(f.push("if (clippable) {"),f.push("  float dist = 0.0;"),e=0;e<c.clips.clips.length;e++)f.push("if (clipActive"+e+") {"),f.push("   dist += clamp(dot(-clipDir"+e+".xyz, vWorldPosition.xyz - clipPos"+e+".xyz), 0.0, 1000.0);"),f.push("}");f.push("  if (dist > 0.0) { discard; }"),b.solid&&(f.push("  if (gl_FrontFacing == false) {"),f.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),f.push("     return;"),f.push("  }")),f.push("}")}return"points"===d.geometry.primitiveName&&(f.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),f.push("float r = dot(cxy, cxy);"),f.push("if (r > 1.0) {"),f.push("   discard;"),f.push("}")),b.gammaOutput?f.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):f.push("gl_FragColor = vColor;"),f.push("}"),f}function i(a,b,c,d){var e,f,g,h=(d.material,d.geometry,c.lights.lights),i=[];if(i.push("// Drawing vertex shader"),i.push("attribute  vec3 position;"),b.quantizedGeometry&&i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform    mat4 modelMatrix;"),i.push("uniform    mat4 viewMatrix;"),i.push("uniform    mat4 projMatrix;"),i.push("varying    vec3 vViewPosition;"),b.clipping&&i.push("varying vec4 vWorldPosition;"),c.lights.lightMap&&i.push("varying    vec3 vWorldNormal;"),b.normals){for(i.push("attribute  vec3 normal;"),i.push("uniform    mat4 modelNormalMatrix;"),i.push("uniform    mat4 viewNormalMatrix;"),i.push("varying    vec3 vViewNormal;"),e=0,f=c.lights.lights.length;e<f;e++)g=c.lights.lights[e],"ambient"!==g.type&&("dir"===g.type&&i.push("uniform vec3 lightDir"+e+";"),"point"===g.type&&i.push("uniform vec3 lightPos"+e+";"),"spot"===g.type&&(i.push("uniform vec3 lightPos"+e+";"),i.push("uniform vec3 lightDir"+e+";")),"dir"===g.type&&"view"===g.space||i.push("varying vec4 vViewLightReverseDirAndDist"+e+";"));b.quantizedGeometry&&(i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"))}b.texturing&&(i.push("attribute vec2 uv;"),i.push("varying vec2 vUV;"),b.quantizedGeometry&&i.push("uniform mat3 uvDecodeMatrix;")),d.geometry.colors&&(i.push("attribute vec4 color;"),i.push("varying vec4 vColor;")),"points"===d.geometry.primitiveName&&i.push("uniform float pointSize;");var j=d.modes.billboard;if("spherical"!==j&&"cylindrical"!==j||(i.push("void billboard(inout mat4 mat) {"),i.push("   mat[0][0] = 1.0;"),i.push("   mat[0][1] = 0.0;"),i.push("   mat[0][2] = 0.0;"),"spherical"===j&&(i.push("   mat[1][0] = 0.0;"),i.push("   mat[1][1] = 1.0;"),i.push("   mat[1][2] = 0.0;")),i.push("   mat[2][0] = 0.0;"),i.push("   mat[2][1] = 0.0;"),i.push("   mat[2][2] =1.0;"),i.push("}")),b.receiveShadow)for(i.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),e=0,f=h.length;e<f;e++)h[e].shadow&&(i.push("uniform mat4 shadowViewMatrix"+e+";"),i.push("uniform mat4 shadowProjMatrix"+e+";"),i.push("varying vec4 vShadowPosFromLight"+e+";"));if(i.push("void main(void) {"),i.push("vec4 localPosition = vec4(position, 1.0); "),i.push("vec4 worldPosition;"),b.quantizedGeometry&&i.push("localPosition = positionsDecodeMatrix * localPosition;"),b.normals&&(b.quantizedGeometry?i.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):i.push("vec4 localNormal = vec4(normal, 0.0); "),i.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),i.push("mat4 viewNormalMatrix2     = viewNormalMatrix;")),i.push("mat4 viewMatrix2           = viewMatrix;"),i.push("mat4 modelMatrix2          = modelMatrix;"),d.modes.stationary&&i.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===j||"cylindrical"===j?(i.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),i.push("billboard(modelMatrix2);"),i.push("billboard(viewMatrix2);"),i.push("billboard(modelViewMatrix);"),b.normals&&(i.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),i.push("billboard(modelNormalMatrix2);"),i.push("billboard(viewNormalMatrix2);"),i.push("billboard(modelViewNormalMatrix);")),i.push("worldPosition = modelMatrix2 * localPosition;"),i.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(i.push("worldPosition = modelMatrix2 * localPosition;"),i.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),b.normals)for(i.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),c.lights.lightMap&&i.push("vWorldNormal = worldNormal;"),i.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),i.push("vec3 tmpVec3;"),i.push("float lightDist;"),e=0,f=c.lights.lights.length;e<f;e++)g=c.lights.lights[e],"ambient"!==g.type&&("dir"===g.type&&"world"===g.space&&(i.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+e+", 0.0) ).xyz;"),i.push("vViewLightReverseDirAndDist"+e+" = vec4(-tmpVec3, 0.0);")),"point"===g.type&&("world"===g.space?(i.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+e+", 1.0)).xyz - viewPosition.xyz;"),i.push("lightDist = abs(length(tmpVec3));")):(i.push("tmpVec3 = lightPos"+e+".xyz - viewPosition.xyz;"),i.push("lightDist = abs(length(tmpVec3));")),i.push("vViewLightReverseDirAndDist"+e+" = vec4(tmpVec3, lightDist);")));if(b.texturing&&(b.quantizedGeometry?i.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):i.push("vUV = uv;")),d.geometry.colors&&i.push("vColor = color;"),"points"===d.geometry.primitiveName&&i.push("gl_PointSize = pointSize;"),b.clipping&&i.push("vWorldPosition = worldPosition;"),i.push("   vViewPosition = viewPosition.xyz;"),i.push("   gl_Position = projMatrix * viewPosition;"),i.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),b.receiveShadow)for(i.push("vec4 tempx; "),e=0,f=h.length;e<f;e++)h[e].shadow&&i.push("vShadowPosFromLight"+e+" = texUnitConverter * shadowProjMatrix"+e+" * (shadowViewMatrix"+e+" * worldPosition); ");return i.push("}"),i}function j(a,b,c,d){var e,g,h,i=d.material,j=d.geometry,l=c.lights.lights,m=[];if(m.push("// Fragment vertex shader"),j.normals&&i.normalMap&&m.push("#extension GL_OES_standard_derivatives : enable"),m.push("precision "+f(a)+" float;"),b.receiveShadow&&(m.push("float unpackDepth (vec4 color) {"),m.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),m.push("  return dot(color, bitShift);"),m.push("}")),m.push("uniform float gammaFactor;"),m.push("vec4 linearToLinear( in vec4 value ) {"),m.push("  return value;"),m.push("}"),m.push("vec4 sRGBToLinear( in vec4 value ) {"),m.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),m.push("}"),m.push("vec4 gammaToLinear( in vec4 value) {"),m.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),m.push("}"),b.gammaOutput&&(m.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),m.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),m.push("}")),b.clipping){m.push("varying vec4 vWorldPosition;"),m.push("uniform bool clippable;");for(var e=0;e<c.clips.clips.length;e++)m.push("uniform bool clipActive"+e+";"),m.push("uniform vec3 clipPos"+e+";"),m.push("uniform vec3 clipDir"+e+";")}if(j.normals&&(c.lights.lightMap&&(m.push("uniform samplerCube lightMap;"),m.push("uniform mat4 viewNormalMatrix;")),c.lights.reflectionMap&&m.push("uniform samplerCube reflectionMap;"),(c.lights.lightMap||c.lights.reflectionMap)&&m.push("uniform mat4 viewMatrix;"),m.push("#define PI 3.14159265359"),m.push("#define RECIPROCAL_PI 0.31830988618"),m.push("#define RECIPROCAL_PI2 0.15915494"),m.push("#define EPSILON 1e-6"),m.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),m.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),m.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),m.push("}"),m.push("struct IncidentLight {"),m.push("   vec3 color;"),m.push("   vec3 direction;"),m.push("};"),m.push("struct ReflectedLight {"),m.push("   vec3 diffuse;"),m.push("   vec3 specular;"),m.push("};"),m.push("struct Geometry {"),m.push("   vec3 position;"),m.push("   vec3 viewNormal;"),m.push("   vec3 worldNormal;"),m.push("   vec3 viewEyeDir;"),m.push("};"),m.push("struct Material {"),m.push("   vec3    diffuseColor;"),m.push("   float   specularRoughness;"),m.push("   vec3    specularColor;"),m.push("   float   shine;"),m.push("};"),b.phongMaterial&&((c.lights.lightMap||c.lights.reflectionMap)&&(m.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),c.lights.lightMap&&(m.push("   vec3 irradiance = "+k[c.lights.lightMap.encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),m.push("   irradiance *= PI;"),m.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),c.lights.reflectionMap,m.push("}")),m.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),m.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),m.push("   vec3 irradiance = dotNL * directLight.color * PI;"),m.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),m.push("}")),(b.metallicMaterial||b.specularMaterial)&&(m.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),m.push("   float r = ggxRoughness + 0.0001;"),m.push("   return (2.0 / (r * r) - 2.0);"),m.push("}"),m.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),m.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),m.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),m.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),m.push("}"),c.lights.reflectionMap&&(m.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),m.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),m.push("   vec3 envMapColor = "+k[c.lights.reflectionMap.encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),m.push("  return envMapColor;"),m.push("}")),m.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),m.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),m.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),m.push("}"),m.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),m.push("   float a2 = ( alpha * alpha );"),m.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),m.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),m.push("   return 1.0 / ( gl * gv );"),m.push("}"),m.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),m.push("   float a2 = ( alpha * alpha );"),m.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),m.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),m.push("   return 0.5 / max( gv + gl, EPSILON );"),m.push("}"),m.push("float D_GGX(const in float alpha, const in float dotNH) {"),m.push("   float a2 = ( alpha * alpha );"),m.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),m.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),m.push("}"),m.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),m.push("   float alpha = ( roughness * roughness );"),m.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),m.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),m.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),m.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),m.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),m.push("   vec3  F = F_Schlick( specularColor, dotLH );"),m.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),m.push("   float D = D_GGX( alpha, dotNH );"),m.push("   return F * (G * D);"),m.push("}"),m.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),m.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),m.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),m.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),m.push("   vec4 r = roughness * c0 + c1;"),m.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),m.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),m.push("   return specularColor * AB.x + AB.y;"),m.push("}"),(c.lights.lightMap||c.lights.reflectionMap)&&(m.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),c.lights.lightMap&&(m.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),m.push("   irradiance *= PI;"),m.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),c.lights.reflectionMap&&(m.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),m.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),m.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),m.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),m.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),m.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),m.push("}")),m.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),m.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),m.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),m.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),m.push("}"))),m.push("varying vec3 vViewPosition;"),j.colors&&m.push("varying vec4 vColor;"),j.uv&&(j.normals&&i.normalMap||i.ambientMap||i.baseColorMap||i.diffuseMap||i.emissiveMap||i.metallicMap||i.roughnessMap||i.metallicRoughnessMap||i.specularMap||i.glossinessMap||i.specularGlossinessMap||i.occlusionMap||i.alphaMap)&&m.push("varying vec2 vUV;"),j.normals&&(c.lights.lightMap&&m.push("varying vec3 vWorldNormal;"),m.push("varying vec3 vViewNormal;")),i.ambient&&m.push("uniform vec3 materialAmbient;"),i.baseColor&&m.push("uniform vec3 materialBaseColor;"),void 0!==i.alpha&&null!==i.alpha&&m.push("uniform vec4 materialAlphaModeCutoff;"),i.emissive&&m.push("uniform vec3 materialEmissive;"),i.diffuse&&m.push("uniform vec3 materialDiffuse;"),void 0!==i.glossiness&&null!==i.glossiness&&m.push("uniform float materialGlossiness;"),void 0!==i.shininess&&null!==i.shininess&&m.push("uniform float materialShininess;"),i.specular&&m.push("uniform vec3 materialSpecular;"),void 0!==i.metallic&&null!==i.metallic&&m.push("uniform float materialMetallic;"),void 0!==i.roughness&&null!==i.roughness&&m.push("uniform float materialRoughness;"),void 0!==i.specularF0&&null!==i.specularF0&&m.push("uniform float materialSpecularF0;"),j.uv&&i.ambientMap&&(m.push("uniform sampler2D ambientMap;"),i.ambientMap.matrix&&m.push("uniform mat4 ambientMapMatrix;")),
j.uv&&i.baseColorMap&&(m.push("uniform sampler2D baseColorMap;"),i.baseColorMap.matrix&&m.push("uniform mat4 baseColorMapMatrix;")),j.uv&&i.diffuseMap&&(m.push("uniform sampler2D diffuseMap;"),i.diffuseMap.matrix&&m.push("uniform mat4 diffuseMapMatrix;")),j.uv&&i.emissiveMap&&(m.push("uniform sampler2D emissiveMap;"),i.emissiveMap.matrix&&m.push("uniform mat4 emissiveMapMatrix;")),j.normals&&j.uv&&i.metallicMap&&(m.push("uniform sampler2D metallicMap;"),i.metallicMap.matrix&&m.push("uniform mat4 metallicMapMatrix;")),j.normals&&j.uv&&i.roughnessMap&&(m.push("uniform sampler2D roughnessMap;"),i.roughnessMap.matrix&&m.push("uniform mat4 roughnessMapMatrix;")),j.normals&&j.uv&&i.metallicRoughnessMap&&(m.push("uniform sampler2D metallicRoughnessMap;"),i.metallicRoughnessMap.matrix&&m.push("uniform mat4 metallicRoughnessMapMatrix;")),j.normals&&i.normalMap&&(m.push("uniform sampler2D normalMap;"),i.normalMap.matrix&&m.push("uniform mat4 normalMapMatrix;"),m.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),m.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),m.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),m.push("      vec2 st0 = dFdx( uv.st );"),m.push("      vec2 st1 = dFdy( uv.st );"),m.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),m.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),m.push("      vec3 N = normalize( surf_norm );"),m.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),m.push("      mat3 tsn = mat3( S, T, N );"),m.push("      return normalize( tsn * mapN );"),m.push("}")),j.uv&&i.occlusionMap&&(m.push("uniform sampler2D occlusionMap;"),i.occlusionMap.matrix&&m.push("uniform mat4 occlusionMapMatrix;")),j.uv&&i.alphaMap&&(m.push("uniform sampler2D alphaMap;"),i.alphaMap.matrix&&m.push("uniform mat4 alphaMapMatrix;")),j.normals&&j.uv&&i.specularMap&&(m.push("uniform sampler2D specularMap;"),i.specularMap.matrix&&m.push("uniform mat4 specularMapMatrix;")),j.normals&&j.uv&&i.glossinessMap&&(m.push("uniform sampler2D glossinessMap;"),i.glossinessMap.matrix&&m.push("uniform mat4 glossinessMapMatrix;")),j.normals&&j.uv&&i.specularGlossinessMap&&(m.push("uniform sampler2D materialSpecularGlossinessMap;"),i.specularGlossinessMap.matrix&&m.push("uniform mat4 materialSpecularGlossinessMapMatrix;")),j.normals&&(i.diffuseFresnel||i.specularFresnel||i.alphaFresnel||i.emissiveFresnel||i.reflectivityFresnel)&&(m.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),m.push("    float fr = abs(dot(eyeDir, normal));"),m.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),m.push("    return pow(finalFr, power);"),m.push("}"),i.diffuseFresnel&&(m.push("uniform float  diffuseFresnelCenterBias;"),m.push("uniform float  diffuseFresnelEdgeBias;"),m.push("uniform float  diffuseFresnelPower;"),m.push("uniform vec3   diffuseFresnelCenterColor;"),m.push("uniform vec3   diffuseFresnelEdgeColor;")),i.specularFresnel&&(m.push("uniform float  specularFresnelCenterBias;"),m.push("uniform float  specularFresnelEdgeBias;"),m.push("uniform float  specularFresnelPower;"),m.push("uniform vec3   specularFresnelCenterColor;"),m.push("uniform vec3   specularFresnelEdgeColor;")),i.alphaFresnel&&(m.push("uniform float  alphaFresnelCenterBias;"),m.push("uniform float  alphaFresnelEdgeBias;"),m.push("uniform float  alphaFresnelPower;"),m.push("uniform vec3   alphaFresnelCenterColor;"),m.push("uniform vec3   alphaFresnelEdgeColor;")),i.reflectivityFresnel&&(m.push("uniform float  materialSpecularF0FresnelCenterBias;"),m.push("uniform float  materialSpecularF0FresnelEdgeBias;"),m.push("uniform float  materialSpecularF0FresnelPower;"),m.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),m.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i.emissiveFresnel&&(m.push("uniform float  emissiveFresnelCenterBias;"),m.push("uniform float  emissiveFresnelEdgeBias;"),m.push("uniform float  emissiveFresnelPower;"),m.push("uniform vec3   emissiveFresnelCenterColor;"),m.push("uniform vec3   emissiveFresnelEdgeColor;"))),m.push("uniform vec4   lightAmbient;"),j.normals)for(e=0,g=l.length;e<g;e++)h=l[e],"ambient"!==h.type&&(m.push("uniform vec4 lightColor"+e+";"),"point"===h.type&&m.push("uniform vec3 lightAttenuation"+e+";"),"dir"===h.type&&"view"===h.space&&m.push("uniform vec3 lightDir"+e+";"),"point"===h.type&&"view"===h.space?m.push("uniform vec3 lightPos"+e+";"):m.push("varying vec4 vViewLightReverseDirAndDist"+e+";"));if(b.receiveShadow)for(e=0,g=l.length;e<g;e++)l[e].shadow&&(m.push("varying vec4 vShadowPosFromLight"+e+";"),m.push("uniform sampler2D shadowMap"+e+";"));if(m.push("uniform vec4 colorize;"),m.push("void main(void) {"),b.clipping){m.push("if (clippable) {"),m.push("  float dist = 0.0;");for(var e=0;e<c.clips.clips.length;e++)m.push("if (clipActive"+e+") {"),m.push("   dist += clamp(dot(-clipDir"+e+".xyz, vWorldPosition.xyz - clipPos"+e+".xyz), 0.0, 1000.0);"),m.push("}");m.push("  if (dist > 0.0) { discard; }"),b.solid&&(m.push("  if (gl_FrontFacing == false) {"),m.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),m.push("     return;"),m.push("  }")),m.push("}")}if("points"===j.primitiveName&&(m.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),m.push("float r = dot(cxy, cxy);"),m.push("if (r > 1.0) {"),m.push("   discard;"),m.push("}")),m.push("float occlusion = 1.0;"),i.ambient?m.push("vec3 ambientColor = materialAmbient;"):m.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);"),i.diffuse?m.push("vec3 diffuseColor = materialDiffuse;"):i.baseColor?m.push("vec3 diffuseColor = materialBaseColor;"):m.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);"),j.colors&&m.push("diffuseColor *= vColor.rgb;"),i.emissive?m.push("vec3 emissiveColor = materialEmissive;"):m.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);"),i.specular?m.push("vec3 specular = materialSpecular;"):m.push("vec3 specular = vec3(1.0, 1.0, 1.0);"),void 0!==i.alpha?m.push("float alpha = materialAlphaModeCutoff[0];"):m.push("float alpha = 1.0;"),j.colors&&m.push("alpha *= vColor.a;"),void 0!==i.glossiness?m.push("float glossiness = materialGlossiness;"):m.push("float glossiness = 1.0;"),void 0!==i.metallic?m.push("float metallic = materialMetallic;"):m.push("float metallic = 1.0;"),void 0!==i.roughness?m.push("float roughness = materialRoughness;"):m.push("float roughness = 1.0;"),void 0!==i.specularF0?m.push("float specularF0 = materialSpecularF0;"):m.push("float specularF0 = 1.0;"),j.uv&&(j.normals&&i.normalMap||i.ambientMap||i.baseColorMap||i.diffuseMap||i.occlusionMap||i.emissiveMap||i.metallicMap||i.roughnessMap||i.metallicRoughnessMap||i.specularMap||i.glossinessMap||i.specularGlossinessMap||i.alphaMap)&&(m.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),m.push("vec2 textureCoord;")),j.uv&&i.ambientMap&&(i.ambientMap.matrix?m.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),m.push("ambientTexel = "+k[i.ambientMap.encoding]+"(ambientTexel);"),m.push("ambientColor *= ambientTexel.rgb;")),j.uv&&i.diffuseMap&&(i.diffuseMap.matrix?m.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),m.push("diffuseTexel = "+k[i.diffuseMap.encoding]+"(diffuseTexel);"),m.push("diffuseColor *= diffuseTexel.rgb;"),m.push("alpha *= diffuseTexel.a;")),j.uv&&i.baseColorMap&&(i.baseColorMap.matrix?m.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),m.push("baseColorTexel = "+k[i.baseColorMap.encoding]+"(baseColorTexel);"),m.push("diffuseColor *= baseColorTexel.rgb;"),m.push("alpha *= baseColorTexel.a;")),j.uv&&i.emissiveMap&&(i.emissiveMap.matrix?m.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),m.push("emissiveTexel = "+k[i.emissiveMap.encoding]+"(emissiveTexel);"),m.push("emissiveColor *= emissiveTexel.rgb;")),j.uv&&i.alphaMap&&(i.alphaMap.matrix?m.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("alpha *= texture2D(alphaMap, textureCoord).r;")),j.uv&&i.occlusionMap&&(i.occlusionMap.matrix?m.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("occlusion *= texture2D(occlusionMap, textureCoord).r;")),j.normals&&(l.length>0||c.lights.lightMap||c.lights.reflectionMap)){j.uv&&i.normalMap?(i.normalMap.matrix?m.push("textureCoord = (normalMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):m.push("vec3 viewNormal = normalize(vViewNormal);"),j.uv&&i.specularMap&&(i.specularMap.matrix?m.push("textureCoord = (specularMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("specular *= texture2D(specularMap, textureCoord).rgb;")),j.uv&&i.glossinessMap&&(i.glossinessMap.matrix?m.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),j.uv&&i.specularGlossinessMap&&(i.specularGlossinessMap.matrix?m.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),m.push("specular *= specGlossRGB.rgb;"),m.push("glossiness *= specGlossRGB.a;")),j.uv&&i.metallicMap&&(i.metallicMap.matrix?m.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("metallic *= texture2D(metallicMap, textureCoord).r;")),j.uv&&i.roughnessMap&&(i.roughnessMap.matrix?m.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),j.uv&&i.metallicRoughnessMap&&(i.metallicRoughnessMap.matrix?m.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),m.push("metallic *= metalRoughRGB.b;"),m.push("roughness *= metalRoughRGB.g;")),m.push("vec3 viewEyeDir = normalize(-vViewPosition);"),(i.diffuseFresnel||i.specularFresnel||i.alphaFresnel||i.emissiveFresnel||i.reflectivityFresnel)&&(i.diffuseFresnel&&(m.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),m.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i.specularFresnel&&(m.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),m.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i.alphaFresnel&&(m.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),m.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i.emissiveFresnel&&(m.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),m.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);"))),m.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),m.push("   discard;"),m.push("}"),m.push("IncidentLight  light;"),m.push("Material       material;"),m.push("Geometry       geometry;"),m.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),m.push("vec3           viewLightDir;"),b.phongMaterial&&(m.push("material.diffuseColor      = diffuseColor;"),m.push("material.specularColor     = specular;"),m.push("material.shine             = materialShininess;")),b.specularMaterial&&(m.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),m.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),m.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),m.push("material.specularColor     = specular;")),b.metallicMaterial&&(m.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),m.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),m.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),m.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),m.push("geometry.position      = vViewPosition;"),c.lights.lightMap&&m.push("geometry.worldNormal   = normalize(vWorldNormal);"),m.push("geometry.viewNormal    = viewNormal;"),m.push("geometry.viewEyeDir    = viewEyeDir;"),b.phongMaterial&&(c.lights.lightMap||c.lights.reflectionMap)&&m.push("computePhongLightMapping(geometry, material, reflectedLight);"),(b.specularMaterial||b.metallicMaterial)&&(c.lights.lightMap||c.lights.reflectionMap)&&m.push("computePBRLightMapping(geometry, material, reflectedLight);");var h;m.push("float shadow = 1.0;"),m.push("float shadowAcneRemover = 0.0007;"),m.push("vec3 fragmentDepth;"),m.push("float texelSize = 1.0 / 1024.0;"),m.push("float amountInLight = 0.0;"),m.push("vec3 shadowCoord;"),m.push("vec4 rgbaDepth;"),m.push("float depth;");for(e=0,g=l.length;e<g;e++)h=l[e],"ambient"!==h.type&&("dir"===h.type&&"view"===h.space?m.push("viewLightDir = -normalize(lightDir"+e+");"):"point"===h.type&&"view"===h.space?m.push("viewLightDir = normalize(lightPos"+e+" - vViewPosition);"):m.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+e+".xyz);"),b.receiveShadow&&h.shadow?(m.push("shadow = 0.0;"),m.push("fragmentDepth = vShadowPosFromLight"+e+".xyz;"),m.push("fragmentDepth.z -= shadowAcneRemover;"),m.push("for (int x = -3; x <= 3; x++) {"),m.push("  for (int y = -3; y <= 3; y++) {"),m.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+e+", fragmentDepth.xy + vec2(x, y) * texelSize));"),m.push("      if (fragmentDepth.z < texelDepth) {"),m.push("          shadow += 1.0;"),m.push("      }"),m.push("  }"),m.push("}"),m.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a * (shadow / 49.0));")):m.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a );"),m.push("light.direction = viewLightDir;"),b.phongMaterial&&m.push("computePhongLighting(light, geometry, material, reflectedLight);"),(b.specularMaterial||b.metallicMaterial)&&m.push("computePBRLighting(light, geometry, material, reflectedLight);"));b.phongMaterial?(m.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),m.push("vec3 outgoingLight =  ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;")):m.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (shadow * occlusion * reflectedLight.specular) + emissiveColor;")}else m.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),m.push("vec3 outgoingLight = emissiveColor + ambientColor;");return m.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),b.gammaOutput&&m.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);"),m.push("}"),m}xeogl.renderer.DrawShaderSource=function(f,k,l){var m={texturing:b(l),normals:d(l),normalMapping:e(l),clipping:k.clips.clips.length>0,solid:!1,lambertMaterial:"LambertMaterial"===l.material.type,phongMaterial:"PhongMaterial"===l.material.type,metallicMaterial:"MetallicMaterial"===l.material.type,specularMaterial:"SpecularMaterial"===l.material.type,reflection:c(k),receiveShadow:a(k,l),quantizedGeometry:!!l.geometry.quantized,gammaInput:k.gammaInput,gammaOutput:k.gammaOutput};this.vertex=m.lambertMaterial?g(f,m,k,l):i(f,m,k,l),this.fragment=m.lambertMaterial?h(f,m,k,l):j(f,m,k,l)};const k={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"}}(),function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.OutlineRenderer=function(a,b,c,d){this._init(a,b,c,d)};var b={};xeogl.renderer.OutlineRenderer.create=function(a,c,d,e){var f=b[c];return f||(f=new xeogl.renderer.OutlineRenderer(a,c,d,e),b[c]=f,xeogl.stats.memory.programs++),f._useCount++,f},xeogl.renderer.OutlineRenderer.prototype.destroy=function(){--this._useCount&&(a.removeItem(this.id),this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.OutlineRenderer.prototype._init=function(b,c,d,e){if(this.id=a.addItem({}),this._gl=b,this._hash=c,this._shaderSource=new xeogl.renderer.OutlineShaderSource(b,d,e),this._program=new xeogl.renderer.Program(b,this._shaderSource),this._scene=d,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var f=this._program;this._uPositionsDecodeMatrix=f.getLocation("positionsDecodeMatrix"),this._uModelMatrix=f.getLocation("modelMatrix"),this._uViewMatrix=f.getLocation("viewMatrix"),this._uProjMatrix=f.getLocation("projMatrix"),this._uClips=[];for(var g=d.clips.clips,h=0,i=g.length;h<i;h++)this._uClips.push({active:f.getLocation("clipActive"+h),pos:f.getLocation("clipPos"+h),dir:f.getLocation("clipDir"+h)});this._uColor=f.getLocation("color"),this._uWidth=f.getLocation("width"),this._aPosition=f.getAttribute("position"),this._aNormal=f.getAttribute("normal"),this._uClippable=f.getLocation("clippable"),this._uGammaFactor=f.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},xeogl.renderer.OutlineRenderer.prototype._bindProgram=function(a){this._program.bind(),a.useProgram++;var b=this._gl,c=this._scene;if(this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,b.uniformMatrix4fv(this._uViewMatrix,!1,c.viewTransform.matrix),b.uniformMatrix4fv(this._uProjMatrix,!1,c.projTransform.matrix),c.clips.clips.length>0)for(var d,e,f,g,h=c.clips.clips,i=0,j=this._uClips.length;i<j;i++)d=this._uClips[i],e=d.active,f=h[i],e&&b.uniform1i(e,f.active),g=d.pos,g&&b.uniform3fv(d.pos,f.pos),d.dir&&b.uniform3fv(d.dir,f.dir);this._uGammaFactor&&b.uniform1f(this._uGammaFactor,c.gammaFactor)},xeogl.renderer.OutlineRenderer.prototype.drawObject=function(a,b){a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a));var c=this._gl,d=b.outlineMaterial,e=b.modelTransform,f=b.geometry;if(d.id!==this._lastMaterialId){if(this._uWidth&&c.uniform1f(this._uWidth,d.width),this._uColor){var g=d.color,h=d.alpha;c.uniform4f(this._uColor,g[0],g[1],g[2],h)}this._lastMaterialId=d.id}e.id!==this._lastModelTransformId&&(c.uniformMatrix4fv(this._uModelMatrix,c.FALSE,e.getMatrix()),this._uModelNormalMatrix&&c.uniformMatrix4fv(this._uModelNormalMatrix,c.FALSE,e.getNormalMatrix()),this._lastModelTransformId=e.id);var i=b.modes;if(this._uClippable&&c.uniform1i(this._uClippable,i.clippable),f.combined){var j=b.vertexBufs;j.id!==this._lastVertexBufsId&&(j.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(j.positionsBuf,j.quantized?c.UNSIGNED_SHORT:c.FLOAT),a.bindArray++),j.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(j.normalsBuf,j.quantized?c.BYTE:c.FLOAT),a.bindArray++),this._lastVertexBufsId=j.id)}f.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&c.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,f.positionsDecodeMatrix),this._uUVDecodeMatrix&&c.uniformMatrix3fv(this._uUVDecodeMatrix,!1,f.uvDecodeMatrix),f.combined?f.indicesBufCombined&&(f.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(f.positionsBuf,f.quantized?c.UNSIGNED_SHORT:c.FLOAT),a.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(f.normalsBuf,f.quantized?c.BYTE:c.FLOAT),a.bindArray++),f.indicesBuf?(f.indicesBuf.bind(),a.bindArray++):f.positions),this._lastGeometryId=f.id),f.combined?f.indicesBufCombined&&(c.drawElements(f.primitive,f.indicesBufCombined.numItems,f.indicesBufCombined.itemType,0),a.drawElements++):f.indicesBuf?(c.drawElements(f.primitive,f.indicesBuf.numItems,f.indicesBuf.itemType,0),a.drawElements++):f.positions&&(c.drawArrays(c.TRIANGLES,0,f.positions.numItems),a.drawArrays++)}}(),function(){"use strict";function a(a){var b=a.geometry.primitiveName;return!(!a.geometry.autoVertexNormals&&!a.geometry.normals||"triangles"!==b&&"triangle-strip"!==b&&"triangle-fan"!==b)}function b(a,b,c){var d=c.modes.billboard,e=[];return e.push("// Outline effect vertex shader"),e.push("attribute vec3 position;"),e.push("uniform mat4 modelMatrix;"),e.push("uniform mat4 viewMatrix;"),e.push("uniform mat4 projMatrix;"),e.push("uniform float width;"),b.quantizedGeometry&&e.push("uniform mat4 positionsDecodeMatrix;"),b.clipping&&e.push("varying vec4 vWorldPosition;"),b.normals&&(e.push("attribute vec3 normal;"),b.quantizedGeometry&&(e.push("vec3 octDecode(vec2 oct) {"),e.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),e.push("    if (v.z < 0.0) {"),e.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),e.push("    }"),e.push("    return normalize(v);"),e.push("}"))),"spherical"!==d&&"cylindrical"!==d||(e.push("void billboard(inout mat4 mat) {"),e.push("   mat[0][0] = 1.0;"),e.push("   mat[0][1] = 0.0;"),e.push("   mat[0][2] = 0.0;"),"spherical"===d&&(e.push("   mat[1][0] = 0.0;"),e.push("   mat[1][1] = 1.0;"),e.push("   mat[1][2] = 0.0;")),e.push("   mat[2][0] = 0.0;"),e.push("   mat[2][1] = 0.0;"),e.push("   mat[2][2] =1.0;"),e.push("}")),e.push("void main(void) {"),e.push("vec4 localPosition = vec4(position, 1.0); "),e.push("vec4 worldPosition;"),b.quantizedGeometry&&e.push("localPosition = positionsDecodeMatrix * localPosition;"),b.normals&&(b.quantizedGeometry?e.push("vec3 localNormal = octDecode(normal.xy); "):e.push("vec3 localNormal = normal; "),e.push("  localPosition.xyz += (normalize(normal) * (width * 0.0005));")),e.push("mat4 viewMatrix2 = viewMatrix;"),e.push("mat4 modelMatrix2 = modelMatrix;"),c.modes.stationary&&e.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===d||"cylindrical"===d?(e.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),e.push("billboard(modelMatrix2);"),e.push("billboard(viewMatrix2);"),e.push("billboard(modelViewMatrix);"),e.push("worldPosition = modelMatrix2 * localPosition;"),e.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(e.push("worldPosition = modelMatrix2 * localPosition;"),e.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),b.clipping&&e.push("vWorldPosition = worldPosition;"),e.push("   gl_Position = projMatrix * viewPosition;"),e.push("}"),e}function c(a,b,c){var d=[];if(d.push("precision lowp float;"),d.push("uniform vec4  color;"),b.clipping){d.push("uniform bool clippable;"),d.push("varying vec4 vWorldPosition;");for(var e=0;e<c.clips.clips.length;e++)d.push("uniform bool clipActive"+e+";"),d.push("uniform vec3 clipPos"+e+";"),d.push("uniform vec3 clipDir"+e+";")}if(d.push("void main(void) {"),b.clipping){d.push("if (clippable) {"),d.push("  float dist = 0.0;");for(var e=0;e<c.clips.clips.length;e++)d.push("if (clipActive"+e+") {"),d.push("   dist += clamp(dot(-clipDir"+e+".xyz, vWorldPosition.xyz - clipPos"+e+".xyz), 0.0, 1000.0);"),d.push("}");d.push("  if (dist > 0.0) { discard; }"),d.push("}")}return d.push("   gl_FragColor = color;"),d.push("}"),d}xeogl.renderer.OutlineShaderSource=function(d,e,f){var g={normals:a(f),clipping:e.clips.clips.length>0,quantizedGeometry:!!f.geometry.quantized};this.vertex=b(d,g,f),this.fragment=c(d,g,e)}}(),function(){"use strict";xeogl.renderer.PickObjectRenderer=function(a,b,c,d){if(this._gl=a,this._hash=b,this._shaderSource=new xeogl.renderer.PickObjectShaderSource(a,c,d),this._program=new xeogl.renderer.Program(a,this._shaderSource),this._scene=c,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var e=this._program;this._uPositionsDecodeMatrix=e.getLocation("positionsDecodeMatrix"),this._uModelMatrix=e.getLocation("modelMatrix"),this._uViewMatrix=e.getLocation("viewMatrix"),this._uProjMatrix=e.getLocation("projMatrix"),this._uClips=[];for(var f=c.clips.clips,g=0,h=f.length;g<h;g++)this._uClips.push({active:e.getLocation("clipActive"+g),pos:e.getLocation("clipPos"+g),dir:e.getLocation("clipDir"+g)});this._aPosition=e.getAttribute("position"),this._uClippable=e.getLocation("clippable"),this._uPickColor=e.getLocation("pickColor"),this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};var a={};xeogl.renderer.PickObjectRenderer.create=function(b,c,d,e){var f=a[c];return f||(f=new xeogl.renderer.PickObjectRenderer(b,c,d,e),a[c]=f,xeogl.stats.memory.programs++),f._useCount++,f},xeogl.renderer.PickObjectRenderer.prototype.destroy=function(){--this._useCount&&(this._program.destroy(),delete a[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.PickObjectRenderer.prototype._bindProgram=function(a){var b=this._gl,c=this._scene;if(this._program.bind(),a.useProgram++,this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,b.uniformMatrix4fv(this._uViewMatrix,!1,a.pickViewMatrix||c.viewTransform.matrix),b.uniformMatrix4fv(this._uProjMatrix,!1,a.pickProjMatrix||c.projTransform.matrix),c.clips.clips.length>0)for(var d,e,f,g,h=c.clips.clips,i=0,j=this._uClips.length;i<j;i++)d=this._uClips[i],e=d.active,f=h[i],e&&b.uniform1i(e,f.active),g=d.pos,g&&b.uniform3fv(d.pos,f.pos),d.dir&&b.uniform3fv(d.dir,f.dir)},xeogl.renderer.PickObjectRenderer.prototype.drawObject=function(a,b){a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a));var c=this._gl,d=b.material,e=b.modelTransform,f=b.geometry;if(d.id!==this._lastMaterialId){var g=d.backfaces;a.backfaces!==g&&(g?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=g);var h=d.frontface;a.frontface!==h&&(h?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=h),a.lineWidth!==d.lineWidth&&(c.lineWidth(d.lineWidth),a.lineWidth=d.lineWidth),this._uPointSize&&c.uniform1i(this._uPointSize,d.pointSize),this._lastMaterialId=d.id}if(e.id!==this._lastModelTransformId&&(c.uniformMatrix4fv(this._uModelMatrix,c.FALSE,e.getMatrix()),this._lastModelTransformId=e.id),f.combined){var i=b.vertexBufs;i.id!==this._lastVertexBufsId&&(i.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(i.positionsBuf,i.quantized?c.UNSIGNED_SHORT:c.FLOAT),a.bindArray++),this._lastVertexBufsId=i.id)}this._uClippable&&c.uniform1i(this._uClippable,b.modes.clippable),f.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&c.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,f.positionsDecodeMatrix),f.combined?f.indicesBufCombined&&(f.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(f.positionsBuf,f.quantized?c.UNSIGNED_SHORT:c.FLOAT),a.bindArray++),f.indicesBuf&&(f.indicesBuf.bind(),a.bindArray++)),this._lastGeometryId=f.id);var j=a.pickObjectIndex>>24&255,k=a.pickObjectIndex>>16&255,l=a.pickObjectIndex>>8&255,m=255&a.pickObjectIndex;a.pickObjectIndex++,c.uniform4f(this._uPickColor,m/255,l/255,k/255,j/255),f.combined?f.indicesBufCombined&&(c.drawElements(f.primitive,f.indicesBufCombined.numItems,f.indicesBufCombined.itemType,0),a.drawElements++):f.indicesBuf?(c.drawElements(f.primitive,f.indicesBuf.numItems,f.indicesBuf.itemType,0),a.drawElements++):f.positions&&c.drawArrays(c.TRIANGLES,0,f.positions.numItems)}}(),function(){"use strict";function a(a,b,c){var d=[];d.push("// Object picking vertex shader"),d.push("attribute vec3 position;"),d.push("uniform mat4 modelMatrix;"),d.push("uniform mat4 viewMatrix;"),d.push("uniform mat4 viewNormalMatrix;"),d.push("uniform mat4 projMatrix;"),d.push("varying vec4 vViewPosition;"),b.quantizedGeometry&&d.push("uniform mat4 positionsDecodeMatrix;"),b.clipping&&d.push("varying vec4 vWorldPosition;");var e=c.modes.billboard;return"spherical"!==e&&"cylindrical"!==e||(d.push("void billboard(inout mat4 mat) {"),d.push("   mat[0][0] = 1.0;"),d.push("   mat[0][1] = 0.0;"),d.push("   mat[0][2] = 0.0;"),"spherical"===e&&(d.push("   mat[1][0] = 0.0;"),d.push("   mat[1][1] = 1.0;"),d.push("   mat[1][2] = 0.0;")),d.push("   mat[2][0] = 0.0;"),d.push("   mat[2][1] = 0.0;"),d.push("   mat[2][2] =1.0;"),d.push("}")),d.push("void main(void) {"),d.push("vec4 localPosition = vec4(position, 1.0); "),b.quantizedGeometry&&d.push("localPosition = positionsDecodeMatrix * localPosition;"),d.push("mat4 viewMatrix2 = viewMatrix;"),d.push("mat4 modelMatrix2 = modelMatrix;"),c.modes.stationary&&d.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"!==e&&"cylindrical"!==e||(d.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),d.push("billboard(modelMatrix2);"),d.push("billboard(viewMatrix2);")),d.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),d.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),b.clipping&&d.push("   vWorldPosition = worldPosition;"),d.push("   gl_Position = projMatrix * viewPosition;"),d.push("}"),d}function b(a,b,c){var d=[];if(d.push("// Object picking fragment shader"),d.push("precision lowp float;"),d.push("uniform vec4 pickColor;"),b.clipping){d.push("uniform bool clippable;"),d.push("varying vec4 vWorldPosition;");for(var e=0;e<c.clips.clips.length;e++)d.push("uniform bool clipActive"+e+";"),d.push("uniform vec3 clipPos"+e+";"),d.push("uniform vec3 clipDir"+e+";")}if(d.push("void main(void) {"),b.clipping){d.push("if (clippable) {"),d.push("  float dist = 0.0;");for(var e=0;e<c.clips.clips.length;e++)d.push("if (clipActive"+e+") {"),d.push("   dist += clamp(dot(-clipDir"+e+".xyz, vWorldPosition.xyz - clipPos"+e+".xyz), 0.0, 1000.0);"),d.push("}");d.push("  if (dist > 0.0) { discard; }"),d.push("}")}return d.push("   gl_FragColor = pickColor; "),d.push("}"),d}xeogl.renderer.PickObjectShaderSource=function(c,d,e){var f={clipping:d.clips.clips.length>0,quantizedGeometry:!!e.geometry.quantized};this.vertex=a(c,f,e),this.fragment=b(c,f,d)}}(),function(){"use strict";xeogl.renderer.PickTriangleRenderer=function(a,b,c,d){if(this._gl=a,this._hash=b,this._shaderSource=new xeogl.renderer.PickTriangleShaderSource(a,c,d),this._program=new xeogl.renderer.Program(a,this._shaderSource),this._scene=c,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var e=this._program;this._uPositionsDecodeMatrix=e.getLocation("positionsDecodeMatrix"),this._uModelMatrix=e.getLocation("modelMatrix"),this._uViewMatrix=e.getLocation("viewMatrix"),this._uProjMatrix=e.getLocation("projMatrix"),this._uClips=[];for(var f=c.clips.clips,g=0,h=f.length;g<h;g++)this._uClips.push({active:e.getLocation("clipActive"+g),pos:e.getLocation("clipPos"+g),dir:e.getLocation("clipDir"+g)});this._aPosition=e.getAttribute("position"),this._aColor=e.getAttribute("color"),this._uClippable=e.getLocation("clippable")};var a={};xeogl.renderer.PickTriangleRenderer.create=function(b,c,d,e){var f=a[c];return f||(f=new xeogl.renderer.PickTriangleRenderer(b,c,d,e),a[c]=f,xeogl.stats.memory.programs++),f._useCount++,f},xeogl.renderer.PickTriangleRenderer.prototype.destroy=function(){--this._useCount&&(this._program.destroy(),delete a[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.PickTriangleRenderer.prototype.drawObject=function(a,b){var c=this._gl,d=this._scene;if(this._program.bind(),a.useProgram++,c.uniformMatrix4fv(this._uViewMatrix,!1,a.pickViewMatrix||d.viewTransform.matrix),c.uniformMatrix4fv(this._uProjMatrix,!1,a.pickProjMatrix||d.projTransform.matrix),
d.clips.clips.length>0)for(var e,f,g,h,i=d.clips.clips,j=0,k=this._uClips.length;j<k;j++)e=this._uClips[j],f=e.active,g=i[j],f&&c.uniform1i(f,g.active),h=e.pos,h&&c.uniform3fv(e.pos,g.pos),e.dir&&c.uniform3fv(e.dir,g.dir);var l=b.material,m=b.modelTransform,n=b.geometry,o=l.backfaces;a.backfaces!==o&&(o?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE),a.backfaces=o);var p=l.frontface;a.frontface!==p&&(p?c.frontFace(c.CCW):c.frontFace(c.CW),a.frontface=p),this._lastMaterialId=l.id,c.uniformMatrix4fv(this._uModelMatrix,c.FALSE,m.getMatrix()),this._uClippable&&c.uniform1i(this._uClippable,b.modes.clippable);var q=n.getPickTrianglePositions();this._uPositionsDecodeMatrix?(c.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(q,n.quantized?c.UNSIGNED_SHORT:c.FLOAT)):this._aPosition.bindArrayBuffer(q);var r=n.getPickTriangleColors();r.bind(),c.enableVertexAttribArray(this._aColor.location),this._gl.vertexAttribPointer(this._aColor.location,r.itemSize,r.itemType,!0,0,0),c.drawArrays(n.primitive,0,q.numItems/3)}}(),function(){"use strict";function a(a,b){var c=[];return c.push("// Surface picking vertex shader"),c.push("attribute vec3 position;"),c.push("attribute vec4 color;"),c.push("uniform mat4 modelMatrix;"),c.push("uniform mat4 viewMatrix;"),c.push("uniform mat4 projMatrix;"),b.clipping&&(c.push("uniform bool clippable;"),c.push("varying vec4 vWorldPosition;")),c.push("varying vec4 vColor;"),b.quantizedGeometry&&c.push("uniform mat4 positionsDecodeMatrix;"),c.push("void main(void) {"),c.push("vec4 localPosition = vec4(position, 1.0); "),b.quantizedGeometry&&c.push("localPosition = positionsDecodeMatrix * localPosition;"),c.push("   vec4 worldPosition = modelMatrix * localPosition; "),c.push("   vec4 viewPosition = viewMatrix * worldPosition;"),b.clipping&&c.push("   vWorldPosition = worldPosition;"),c.push("   vColor = color;"),c.push("   gl_Position = projMatrix * viewPosition;"),c.push("}"),c}function b(a,b,c){var d=[];if(d.push("// Surface picking fragment shader"),d.push("precision lowp float;"),d.push("varying vec4 vColor;"),b.clipping){d.push("uniform bool clippable;"),d.push("varying vec4 vWorldPosition;");for(var e=0;e<c.clips.clips.length;e++)d.push("uniform bool clipActive"+e+";"),d.push("uniform vec3 clipPos"+e+";"),d.push("uniform vec3 clipDir"+e+";")}if(d.push("void main(void) {"),b.clipping){d.push("if (clippable) {"),d.push("  float dist = 0.0;");for(var e=0;e<c.clips.clips.length;e++)d.push("if (clipActive"+e+") {"),d.push("   dist += clamp(dot(-clipDir"+e+".xyz, vWorldPosition.xyz - clipPos"+e+".xyz), 0.0, 1000.0);"),d.push("}");d.push("  if (dist > 0.0) { discard; }"),d.push("}")}return d.push("   gl_FragColor = vColor;"),d.push("}"),d}xeogl.renderer.PickTriangleShaderSource=function(c,d,e){var f={clipping:d.clips.clips.length>0,quantizedGeometry:!!e.geometry.quantized};this.vertex=a(c,f),this.fragment=b(c,f,d)}}(),function(){"use strict";xeogl.renderer.ShadowRenderer=function(a,b,c,d){if(this._gl=a,this._hash=b,this._shaderSource=new xeogl.renderer.ShadowShaderSource(a,c,d),this._program=new xeogl.renderer.Program(a,this._shaderSource),this._scene=c,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var e=this._program;this._uPositionsDecodeMatrix=e.getLocation("positionsDecodeMatrix"),this._uModelMatrix=e.getLocation("modelMatrix"),this._uViewMatrix=e.getLocation("viewMatrix"),this._uProjMatrix=e.getLocation("projMatrix"),this._uClips={};for(var f=c.clips,g=0,h=f.length;g<h;g++)this._uClips.push({active:e.getLocation("clipActive"+g),pos:e.getLocation("clipPos"+g),dir:e.getLocation("clipDir"+g)});this._aPosition=e.getAttribute("position"),this._uClippable=e.getLocation("clippable"),this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};var a={};xeogl.renderer.ShadowRenderer.create=function(b,c,d,e){var f=a[c];return f||(f=new xeogl.renderer.ShadowRenderer(b,c,d,e),a[c]=f),f._useCount++,f},xeogl.renderer.ShadowRenderer.prototype.destroy=function(){--this._useCount&&(this._program.destroy(),delete a[this._hash])},xeogl.renderer.ShadowRenderer.prototype._bindProgram=function(a){var b=this._gl,c=this._scene;if(this._program.bind(),a.useProgram++,this._lastLightId=null,this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,c.clips.clips.length>0)for(var d,e,f,g,h=c.clips.clips,i=0,j=this._uClips.length;i<j;i++)d=this._uClips[i],e=d.active,f=h[i],e&&b.uniform1i(e,f.active),g=d.pos,g&&b.uniform3fv(d.pos,f.pos),d.dir&&b.uniform3fv(d.dir,f.dir)},xeogl.renderer.ShadowRenderer.prototype.drawObject=function(a,b,c){a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a));var d=this._gl,e=b.material,f=b.modelTransform,g=b.geometry;if(a.textureUnit=0,c.id!==this._lastLightId&&(d.uniformMatrix4fv(this._uViewMatrix,!1,c.getShadowViewMatrix()),d.uniformMatrix4fv(this._uProjMatrix,!1,c.getShadowProjMatrix()),this._lastLightId=c.id),e.id!==this._lastMaterialId){var h=e.backfaces;a.backfaces!==h&&(h?d.disable(d.CULL_FACE):d.enable(d.CULL_FACE),a.backfaces=h);var i=e.frontface;a.frontface!==i&&(i?d.frontFace(d.CCW):d.frontFace(d.CW),a.frontface=i),a.lineWidth!==e.lineWidth&&(d.lineWidth(e.lineWidth),a.lineWidth=e.lineWidth),this._uPointSize&&d.uniform1i(this._uPointSize,e.pointSize),this._lastMaterialId=e.id}if(f.id!==this._lastModelTransformId&&(d.uniformMatrix4fv(this._uModelMatrix,d.FALSE,f.getMatrix()),this._lastModelTransformId=f.id),this._uClippable&&d.uniform1i(this._uClippable,b.modes.clippable),g.combined){var j=b.vertexBufs;j.id!==this._lastVertexBufsId&&(j.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(j.positionsBuf,j.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),this._lastVertexBufsId=j.id)}g.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&d.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,g.positionsDecodeMatrix),g.combined?g.indicesBufCombined&&(g.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(g.positionsBuf,g.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),g.indicesBuf&&(g.indicesBuf.bind(),a.bindArray++)),this._lastGeometryId=g.id),g.combined?g.indicesBufCombined&&(d.drawElements(g.primitive,g.indicesBufCombined.numItems,g.indicesBufCombined.itemType,0),a.drawElements++):g.indicesBuf?(d.drawElements(g.primitive,g.indicesBuf.numItems,g.indicesBuf.itemType,0),a.drawElements++):g.positions&&(d.drawArrays(d.TRIANGLES,0,g.positions.numItems),a.drawArrays++)}}(),function(){"use strict";function a(a,b,c,d){var e=(c.lights.lights,d.modes.billboard),f=[];return f.push("// Shadow drawing vertex shader"),f.push("attribute vec3 position;"),f.push("uniform mat4 modelMatrix;"),f.push("uniform mat4 viewMatrix;"),f.push("uniform mat4 projMatrix;"),b.quantizedGeometry&&f.push("uniform mat4 positionsDecodeMatrix;"),b.clipping&&f.push("varying vec4 vWorldPosition;"),"points"===d.geometry.primitiveName&&f.push("uniform float pointSize;"),"spherical"!==e&&"cylindrical"!==e||(f.push("void billboard(inout mat4 mat) {"),f.push("   mat[0][0] = 1.0;"),f.push("   mat[0][1] = 0.0;"),f.push("   mat[0][2] = 0.0;"),"spherical"===e&&(f.push("   mat[1][0] = 0.0;"),f.push("   mat[1][1] = 1.0;"),f.push("   mat[1][2] = 0.0;")),f.push("   mat[2][0] = 0.0;"),f.push("   mat[2][1] = 0.0;"),f.push("   mat[2][2] =1.0;"),f.push("}")),f.push("void main(void) {"),f.push("vec4 localPosition = vec4(position, 1.0); "),f.push("vec4 worldPosition;"),b.quantizedGeometry&&f.push("localPosition = positionsDecodeMatrix * localPosition;"),f.push("mat4 viewMatrix2 = viewMatrix;"),f.push("mat4 modelMatrix2 = modelMatrix;"),d.modes.stationary&&f.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===e||"cylindrical"===e?(f.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),f.push("billboard(modelMatrix2);"),f.push("billboard(viewMatrix2);"),f.push("billboard(modelViewMatrix);"),b.normals&&(f.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),f.push("billboard(modelNormalMatrix2);"),f.push("billboard(viewNormalMatrix2);"),f.push("billboard(modelViewNormalMatrix);")),f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),b.clipping&&f.push("vWorldPosition = worldPosition;"),"points"===d.geometry.primitiveName&&f.push("gl_PointSize = pointSize;"),f.push("   gl_Position = projMatrix * viewPosition;"),f.push("}"),f}function b(a,b,d,e){var f,g=[];if(g.push("// Shadow fragment shader"),g.push("precision "+c(a)+" float;"),b.clipping)for(g.push("varying vec4 vWorldPosition;"),g.push("uniform bool clippable;"),f=0;f<d.clips.clips.length;f++)g.push("uniform bool clipActive"+f+";"),g.push("uniform vec3 clipPos"+f+";"),g.push("uniform vec3 clipDir"+f+";");if(g.push("vec4 packDepth (float depth) {"),g.push("  const vec4 bitShift = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);"),g.push("  const vec4 bitMask = vec4(1.0/256.0, 1.0/256.0, 1.0/256.0, 0.0);"),g.push("  vec4 comp = fract(depth * bitShift);"),g.push("  comp -= comp.gbaa * bitMask;"),g.push("  return comp;"),g.push("}"),g.push("void main(void) {"),b.clipping){for(g.push("if (clippable) {"),g.push("  float dist = 0.0;"),f=0;f<d.clips.clips.length;f++)g.push("if (clipActive"+f+") {"),g.push("   dist += clamp(dot(-clipDir"+f+".xyz, vWorldPosition.xyz - clipPos"+f+".xyz), 0.0, 1000.0);"),g.push("}");g.push("  if (dist > 0.0) { discard; }"),b.solid&&(g.push("  if (gl_FrontFacing == false) {"),g.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),g.push("     return;"),g.push("  }")),g.push("}")}return"points"===e.geometry.primitiveName&&(g.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),g.push("float r = dot(cxy, cxy);"),g.push("if (r > 1.0) {"),g.push("   discard;"),g.push("}")),g.push("gl_FragColor = packDepth(gl_FragCoord.z);"),g.push("}"),g}function c(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}xeogl.renderer.ShadowShaderSource=function(c,d,e){var f={clipping:d.clips.clips.length>0,quantizedGeometry:!!e.geometry.quantized};this.vertex=a(c,f,d,e),this.fragment=b(c,f,d,e)}}(),function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.GhostFillRenderer=function(a,b,c,d){this._init(a,b,c,d)};var b={};xeogl.renderer.GhostFillRenderer.create=function(a,c,d,e){var f=b[c];return f||(f=new xeogl.renderer.GhostFillRenderer(a,c,d,e),b[c]=f,xeogl.stats.memory.programs++),f._useCount++,f},xeogl.renderer.GhostFillRenderer.prototype.destroy=function(){--this._useCount&&(a.removeItem(this.id),this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.GhostFillRenderer.prototype._init=function(b,c,d,e){if(this.id=a.addItem({}),this._gl=b,this._hash=c,this._shaderSource=new xeogl.renderer.GhostFillShaderSource(b,d,e),this._program=new xeogl.renderer.Program(b,this._shaderSource),this._scene=d,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var f=this._program;this._uPositionsDecodeMatrix=f.getLocation("positionsDecodeMatrix"),this._uModelMatrix=f.getLocation("modelMatrix"),this._uModelNormalMatrix=f.getLocation("modelNormalMatrix"),this._uViewMatrix=f.getLocation("viewMatrix"),this._uViewNormalMatrix=f.getLocation("viewNormalMatrix"),this._uProjMatrix=f.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var g,h=d.lights.lights,i=0,j=h.length;i<j;i++)switch(g=h[i],g.type){case"ambient":this._uLightAmbient[i]=f.getLocation("lightAmbient");break;case"dir":this._uLightColor[i]=f.getLocation("lightColor"+i),this._uLightPos[i]=null,this._uLightDir[i]=f.getLocation("lightDir"+i);break;case"point":this._uLightColor[i]=f.getLocation("lightColor"+i),this._uLightPos[i]=f.getLocation("lightPos"+i),this._uLightDir[i]=null,this._uLightAttenuation[i]=f.getLocation("lightAttenuation"+i)}this._uClips=[];for(var k=d.clips.clips,i=0,j=k.length;i<j;i++)this._uClips.push({active:f.getLocation("clipActive"+i),pos:f.getLocation("clipPos"+i),dir:f.getLocation("clipDir"+i)});e.material;this._uFillColor=f.getLocation("fillColor"),this._aPosition=f.getAttribute("position"),this._aNormal=f.getAttribute("normal"),this._uClippable=f.getLocation("clippable"),this._uGammaFactor=f.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},xeogl.renderer.GhostFillRenderer.prototype._bindProgram=function(a){this._program.bind(),a.useProgram++,a.textureUnit=0;var b,c=this._gl,d=this._scene,e=d.lights;this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,c.uniformMatrix4fv(this._uViewMatrix,!1,d.viewTransform.matrix),c.uniformMatrix4fv(this._uViewNormalMatrix,!1,d.viewTransform.normalMatrix),c.uniformMatrix4fv(this._uProjMatrix,!1,d.projTransform.matrix);for(var f=0,g=e.lights.length;f<g;f++)b=e.lights[f],this._uLightAmbient[f]?c.uniform4f(this._uLightAmbient[f],b.color[0],b.color[1],b.color[2],b.intensity):(this._uLightColor[f]&&c.uniform4f(this._uLightColor[f],b.color[0],b.color[1],b.color[2],b.intensity),this._uLightPos[f]&&(c.uniform3fv(this._uLightPos[f],b.pos),this._uLightAttenuation[f]&&c.uniform1f(this._uLightAttenuation[f],b.attenuation)),this._uLightDir[f]&&c.uniform3fv(this._uLightDir[f],b.dir));if(d.clips.clips.length>0)for(var h,i,j,k,l=d.clips.clips,f=0,g=this._uClips.length;f<g;f++)h=this._uClips[f],i=h.active,j=l[f],i&&c.uniform1i(i,j.active),k=h.pos,k&&c.uniform3fv(h.pos,j.pos),h.dir&&c.uniform3fv(h.dir,j.dir);this._uGammaFactor&&c.uniform1f(this._uGammaFactor,d.gammaFactor)},xeogl.renderer.GhostFillRenderer.prototype.drawObject=function(a,b,c){a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a));var d=this._gl,e=0===c?b.ghostMaterial:1===c?b.highlightMaterial:b.selectedMaterial,f=b.modelTransform,g=b.geometry;if(e.id!==this._lastMaterialId){var h=e.fillColor;d.uniform4f(this._uFillColor,h[0],h[1],h[2],e.fillAlpha),this._lastMaterialId=e.id}f.id!==this._lastModelTransformId&&(d.uniformMatrix4fv(this._uModelMatrix,d.FALSE,f.getMatrix()),this._uModelNormalMatrix&&d.uniformMatrix4fv(this._uModelNormalMatrix,d.FALSE,f.getNormalMatrix()),this._lastModelTransformId=f.id);var i=b.modes;if(this._uClippable&&d.uniform1i(this._uClippable,i.clippable),g.combined){var j=b.vertexBufs;j.id!==this._lastVertexBufsId&&(j.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(j.positionsBuf,j.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),j.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(j.normalsBuf,j.quantized?d.BYTE:d.FLOAT),a.bindArray++),this._lastVertexBufsId=j.id)}g.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&d.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,g.positionsDecodeMatrix),this._uUVDecodeMatrix&&d.uniformMatrix3fv(this._uUVDecodeMatrix,!1,g.uvDecodeMatrix),g.combined?g.indicesBufCombined&&(g.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(g.positionsBuf,g.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(g.normalsBuf,g.quantized?d.BYTE:d.FLOAT),a.bindArray++),g.indicesBuf?(g.indicesBuf.bind(),a.bindArray++):g.positions),this._lastGeometryId=g.id),g.combined?g.indicesBufCombined&&(d.drawElements(g.primitive,g.indicesBufCombined.numItems,g.indicesBufCombined.itemType,0),a.drawElements++):g.indicesBuf?(d.drawElements(g.primitive,g.indicesBuf.numItems,g.indicesBuf.itemType,0),a.drawElements++):g.positions&&(d.drawArrays(d.TRIANGLES,0,g.positions.numItems),a.drawArrays++)}}(),function(){"use strict";function a(a){var b=a.geometry.primitiveName;return!(!a.geometry.autoVertexNormals&&!a.geometry.normals||"triangles"!==b&&"triangle-strip"!==b&&"triangle-fan"!==b)}function b(a,b,c,d){var e,f,g,h=c.lights.lights,i=d.modes.billboard,j=[];if(j.push("// Lambertian drawing vertex shader"),j.push("attribute vec3 position;"),j.push("uniform mat4 modelMatrix;"),j.push("uniform mat4 viewMatrix;"),j.push("uniform mat4 projMatrix;"),j.push("uniform vec4 colorize;"),b.quantizedGeometry&&j.push("uniform mat4 positionsDecodeMatrix;"),b.clipping&&j.push("varying vec4 vWorldPosition;"),j.push("uniform vec4   lightAmbient;"),j.push("uniform vec4   fillColor;"),b.normals){for(j.push("attribute vec3 normal;"),j.push("uniform mat4 modelNormalMatrix;"),j.push("uniform mat4 viewNormalMatrix;"),e=0,f=h.length;e<f;e++)g=h[e],"ambient"!==g.type&&(j.push("uniform vec4 lightColor"+e+";"),"dir"===g.type&&j.push("uniform vec3 lightDir"+e+";"),"point"===g.type&&j.push("uniform vec3 lightPos"+e+";"),"spot"===g.type&&j.push("uniform vec3 lightPos"+e+";"));b.quantizedGeometry&&(j.push("vec3 octDecode(vec2 oct) {"),j.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),j.push("    if (v.z < 0.0) {"),j.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),j.push("    }"),j.push("    return normalize(v);"),j.push("}"))}if(j.push("varying vec4 vColor;"),"spherical"!==i&&"cylindrical"!==i||(j.push("void billboard(inout mat4 mat) {"),j.push("   mat[0][0] = 1.0;"),j.push("   mat[0][1] = 0.0;"),j.push("   mat[0][2] = 0.0;"),"spherical"===i&&(j.push("   mat[1][0] = 0.0;"),j.push("   mat[1][1] = 1.0;"),j.push("   mat[1][2] = 0.0;")),j.push("   mat[2][0] = 0.0;"),j.push("   mat[2][1] = 0.0;"),j.push("   mat[2][2] =1.0;"),j.push("}")),j.push("void main(void) {"),j.push("vec4 localPosition = vec4(position, 1.0); "),j.push("vec4 worldPosition;"),b.quantizedGeometry&&j.push("localPosition = positionsDecodeMatrix * localPosition;"),b.normals&&(b.quantizedGeometry?j.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):j.push("vec4 localNormal = vec4(normal, 0.0); "),j.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),j.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),j.push("mat4 viewMatrix2 = viewMatrix;"),j.push("mat4 modelMatrix2 = modelMatrix;"),d.modes.stationary&&j.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===i||"cylindrical"===i?(j.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),j.push("billboard(modelMatrix2);"),j.push("billboard(viewMatrix2);"),j.push("billboard(modelViewMatrix);"),b.normals&&(j.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),j.push("billboard(modelNormalMatrix2);"),j.push("billboard(viewNormalMatrix2);"),j.push("billboard(modelViewNormalMatrix);")),j.push("worldPosition = modelMatrix2 * localPosition;"),j.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(j.push("worldPosition = modelMatrix2 * localPosition;"),j.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),b.normals&&j.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),j.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),j.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),j.push("float lambertian = 1.0;"),b.normals)for(e=0,f=h.length;e<f;e++)if(g=h[e],"ambient"!==g.type){if("dir"===g.type)"view"===g.space?j.push("viewLightDir = normalize(lightDir"+e+");"):j.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);");else{if("point"!==g.type)continue;"view"===g.space?j.push("viewLightDir = normalize(lightPos"+e+" - viewPosition.xyz);"):j.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+e+", 0.0)).xyz);")}j.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),j.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}return j.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),b.clipping&&j.push("vWorldPosition = worldPosition;"),"points"===d.geometry.primitiveName&&j.push("gl_PointSize = pointSize;"),j.push("   gl_Position = projMatrix * viewPosition;"),j.push("}"),j}function c(a,b,c,d){var e,f=[];if(f.push("// Lambertian drawing fragment shader"),f.push("precision lowp float;"),b.gammaOutput&&(f.push("uniform float gammaFactor;"),f.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),f.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),f.push("}")),b.clipping)for(f.push("varying vec4 vWorldPosition;"),f.push("uniform bool clippable;"),e=0;e<c.clips.clips.length;e++)f.push("uniform bool clipActive"+e+";"),f.push("uniform vec3 clipPos"+e+";"),f.push("uniform vec3 clipDir"+e+";");if(f.push("varying vec4 vColor;"),f.push("void main(void) {"),b.clipping){for(f.push("if (clippable) {"),f.push("  float dist = 0.0;"),e=0;e<c.clips.clips.length;e++)f.push("if (clipActive"+e+") {"),f.push("   dist += clamp(dot(-clipDir"+e+".xyz, vWorldPosition.xyz - clipPos"+e+".xyz), 0.0, 1000.0);"),f.push("}");f.push("  if (dist > 0.0) { discard; }"),f.push("}")}return"points"===d.geometry.primitiveName&&(f.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),f.push("float r = dot(cxy, cxy);"),f.push("if (r > 1.0) {"),f.push("   discard;"),f.push("}")),f.push("gl_FragColor = vColor;"),b.gammaOutput?f.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):f.push("gl_FragColor = vColor;"),f.push("}"),f}xeogl.renderer.GhostFillShaderSource=function(d,e,f){var g={normals:a(f),clipping:e.clips.clips.length>0,quantizedGeometry:!!f.geometry.quantized,gammaOutput:e.gammaOutput};this.vertex=b(d,g,e,f),this.fragment=c(d,g,e,f)}}(),function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.GhostVerticesRenderer=function(a,b,c,d){this._init(a,b,c,d)};var b={};xeogl.renderer.GhostVerticesRenderer.create=function(a,c,d,e){var f=b[c];return f||(f=new xeogl.renderer.GhostVerticesRenderer(a,c,d,e),b[c]=f,xeogl.stats.memory.programs++),f._useCount++,f},xeogl.renderer.GhostVerticesRenderer.prototype.destroy=function(){--this._useCount&&(a.removeItem(this.id),this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.GhostVerticesRenderer.prototype._init=function(b,c,d,e){if(this.id=a.addItem({}),this._gl=b,this._hash=c,this._shaderSource=new xeogl.renderer.GhostVerticesShaderSource(b,d,e),this._program=new xeogl.renderer.Program(b,this._shaderSource),this._scene=d,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var f=this._program;this._uPositionsDecodeMatrix=f.getLocation("positionsDecodeMatrix"),this._uModelMatrix=f.getLocation("modelMatrix"),this._uViewMatrix=f.getLocation("viewMatrix"),this._uProjMatrix=f.getLocation("projMatrix"),this._uClips=[];for(var g=d.clips.clips,h=0,i=g.length;h<i;h++)this._uClips.push({active:f.getLocation("clipActive"+h),pos:f.getLocation("clipPos"+h),dir:f.getLocation("clipDir"+h)});this._uVertexColor=f.getLocation("vertexColor"),this._uVertexSize=f.getLocation("vertexSize"),this._aPosition=f.getAttribute("position"),this._aNormal=f.getAttribute("normal"),this._uClippable=f.getLocation("clippable"),this._uGammaFactor=f.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},xeogl.renderer.GhostVerticesRenderer.prototype._bindProgram=function(a){this._program.bind(),a.useProgram++,a.textureUnit=0;var b=this._gl,c=this._scene;if(this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,b.uniformMatrix4fv(this._uViewMatrix,!1,c.viewTransform.matrix),b.uniformMatrix4fv(this._uProjMatrix,!1,c.projTransform.matrix),c.clips.clips.length>0)for(var d,e,f,g,h=c.clips.clips,i=0,j=this._uClips.length;i<j;i++)d=this._uClips[i],e=d.active,f=h[i],e&&b.uniform1i(e,f.active),g=d.pos,g&&b.uniform3fv(d.pos,f.pos),d.dir&&b.uniform3fv(d.dir,f.dir);this._uGammaFactor&&b.uniform1f(this._uGammaFactor,c.gammaFactor)},xeogl.renderer.GhostVerticesRenderer.prototype.drawObject=function(a,b,c){a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a));var d=this._gl,e=0===c?b.ghostMaterial:1===c?b.highlightMaterial:b.selectedMaterial,f=b.modelTransform,g=b.geometry;if(e.id!==this._lastMaterialId){if(this._uVertexSize&&d.uniform1f(this._uVertexSize,e.vertexSize),this._uVertexColor){var h=e.vertexColor,i=e.vertexAlpha;d.uniform4f(this._uVertexColor,h[0],h[1],h[2],i)}this._lastMaterialId=e.id}f.id!==this._lastModelTransformId&&(d.uniformMatrix4fv(this._uModelMatrix,d.FALSE,f.getMatrix()),this._uModelNormalMatrix&&d.uniformMatrix4fv(this._uModelNormalMatrix,d.FALSE,f.getNormalMatrix()),this._lastModelTransformId=f.id);var j=b.modes;if(this._uClippable&&d.uniform1i(this._uClippable,j.clippable),g.combined){var k=b.vertexBufs;k.id!==this._lastVertexBufsId&&(k.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(k.positionsBuf,k.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),k.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(k.normalsBuf,k.quantized?d.BYTE:d.FLOAT),a.bindArray++),this._lastVertexBufsId=k.id)}g.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&d.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,g.positionsDecodeMatrix),g.combined?g.indicesBufCombined&&(g.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(g.positionsBuf,g.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(g.normalsBuf,g.quantized?d.BYTE:d.FLOAT),a.bindArray++),g.indicesBuf?(g.indicesBuf.bind(),a.bindArray++):g.positions),this._lastGeometryId=g.id),g.combined?g.indicesBufCombined&&(d.drawElements(d.POINTS,g.indicesBufCombined.numItems,g.indicesBufCombined.itemType,0),a.drawElements++):g.indicesBuf?(d.drawElements(d.POINTS,g.indicesBuf.numItems,g.indicesBuf.itemType,0),a.drawElements++):g.positions&&(d.drawArrays(d.POINTS,0,g.positions.numItems),a.drawArrays++)}}(),function(){"use strict";function a(a){var b=a.geometry.primitiveName;return!(!a.geometry.autoVertexNormals&&!a.geometry.normals||"triangles"!==b&&"triangle-strip"!==b&&"triangle-fan"!==b)}function b(a,b,c,d){var e=d.modes.billboard,f=[];return f.push("// Vertices drawing vertex shader"),f.push("attribute vec3 position;"),f.push("uniform mat4 modelMatrix;"),f.push("uniform mat4 viewMatrix;"),f.push("uniform mat4 projMatrix;"),f.push("uniform vec4 vertexColor;"),f.push("uniform float vertexSize;"),b.quantizedGeometry&&f.push("uniform mat4 positionsDecodeMatrix;"),b.clipping&&f.push("varying vec4 vWorldPosition;"),b.normals&&(f.push("attribute vec3 normal;"),b.quantizedGeometry&&(f.push("vec3 octDecode(vec2 oct) {"),f.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),f.push("    if (v.z < 0.0) {"),f.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),f.push("    }"),f.push("    return normalize(v);"),f.push("}"))),f.push("varying vec4 vColor;"),"spherical"!==e&&"cylindrical"!==e||(f.push("void billboard(inout mat4 mat) {"),f.push("   mat[0][0] = 1.0;"),f.push("   mat[0][1] = 0.0;"),f.push("   mat[0][2] = 0.0;"),"spherical"===e&&(f.push("   mat[1][0] = 0.0;"),f.push("   mat[1][1] = 1.0;"),f.push("   mat[1][2] = 0.0;")),f.push("   mat[2][0] = 0.0;"),f.push("   mat[2][1] = 0.0;"),f.push("   mat[2][2] =1.0;"),f.push("}")),f.push("void main(void) {"),f.push("vec4 localPosition = vec4(position, 1.0); "),f.push("vec4 worldPosition;"),b.quantizedGeometry&&f.push("localPosition = positionsDecodeMatrix * localPosition;"),b.normals&&(b.quantizedGeometry?f.push("vec3 localNormal = octDecode(normal.xy); "):f.push("vec3 localNormal = normal; ")),f.push("mat4 viewMatrix2 = viewMatrix;"),f.push("mat4 modelMatrix2 = modelMatrix;"),d.modes.stationary&&f.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===e||"cylindrical"===e?(f.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),f.push("billboard(modelMatrix2);"),f.push("billboard(viewMatrix2);"),f.push("billboard(modelViewMatrix);"),f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("vec4 viewPosition = modelViewMatrix * (localPosition + normal);")):(f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),f.push("vColor = vertexColor;"),f.push("gl_PointSize = vertexSize;"),b.clipping&&f.push("vWorldPosition = worldPosition;"),f.push("   gl_Position = projMatrix * viewPosition;"),f.push("}"),f}function c(a,b,c,d){var e,f=[];if(f.push("// Vertices drawing fragment shader"),f.push("precision lowp float;"),b.gammaOutput&&(f.push("uniform float gammaFactor;"),f.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),f.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),f.push("}")),b.clipping)for(f.push("varying vec4 vWorldPosition;"),f.push("uniform bool clippable;"),e=0;e<c.clips.clips.length;e++)f.push("uniform bool clipActive"+e+";"),f.push("uniform vec3 clipPos"+e+";"),f.push("uniform vec3 clipDir"+e+";");if(f.push("varying vec4 vColor;"),f.push("void main(void) {"),b.clipping){for(f.push("if (clippable) {"),f.push("  float dist = 0.0;"),e=0;e<c.clips.clips.length;e++)f.push("if (clipActive"+e+") {"),f.push("   dist += clamp(dot(-clipDir"+e+".xyz, vWorldPosition.xyz - clipPos"+e+".xyz), 0.0, 1000.0);"),f.push("}");f.push("  if (dist > 0.0) { discard; }"),f.push("}")}return f.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),f.push("float r = dot(cxy, cxy);"),f.push("if (r > 1.0) {"),f.push("   discard;"),f.push("}"),f.push("gl_FragColor = vColor;"),b.gammaOutput?f.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):f.push("gl_FragColor = vColor;"),f.push("}"),f}xeogl.renderer.GhostVerticesShaderSource=function(d,e,f){var g={normals:a(f),clipping:e.clips.clips.length>0,quantizedGeometry:!!f.geometry.quantized,gammaOutput:e.gammaOutput};this.vertex=b(d,g,e,f),this.fragment=c(d,g,e,f)}}(),function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.GhostEdgesRenderer=function(a,b,c,d){this._init(a,b,c,d)};var b={};xeogl.renderer.GhostEdgesRenderer.create=function(a,c,d,e){var f=b[c];return f||(f=new xeogl.renderer.GhostEdgesRenderer(a,c,d,e),b[c]=f,xeogl.stats.memory.programs++),f._useCount++,f},xeogl.renderer.GhostEdgesRenderer.prototype.destroy=function(){--this._useCount&&(a.removeItem(this.id),this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.GhostEdgesRenderer.prototype._init=function(b,c,d,e){if(this.id=a.addItem({}),this._gl=b,this._hash=c,this._shaderSource=new xeogl.renderer.GhostEdgesShaderSource(b,d,e),this._program=new xeogl.renderer.Program(b,this._shaderSource),this._scene=d,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var f=this._program;this._uPositionsDecodeMatrix=f.getLocation("positionsDecodeMatrix"),this._uModelMatrix=f.getLocation("modelMatrix"),this._uViewMatrix=f.getLocation("viewMatrix"),this._uProjMatrix=f.getLocation("projMatrix"),this._uClips=[];for(var g=d.clips.clips,h=0,i=g.length;h<i;h++)this._uClips.push({active:f.getLocation("clipActive"+h),pos:f.getLocation("clipPos"+h),dir:f.getLocation("clipDir"+h)});this._uEdgeColor=f.getLocation("edgeColor"),this._aPosition=f.getAttribute("position"),this._aNormal=f.getAttribute("normal"),this._uClippable=f.getLocation("clippable"),this._uGammaFactor=f.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},xeogl.renderer.GhostEdgesRenderer.prototype._bindProgram=function(a){this._program.bind(),a.useProgram++;var b=this._gl,c=this._scene;if(this._lastMaterialId=null,this._lastModelTransformId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,
b.uniformMatrix4fv(this._uViewMatrix,!1,c.viewTransform.matrix),b.uniformMatrix4fv(this._uProjMatrix,!1,c.projTransform.matrix),c.clips.clips.length>0)for(var d,e,f,g,h=c.clips.clips,i=0,j=this._uClips.length;i<j;i++)d=this._uClips[i],e=d.active,f=h[i],e&&b.uniform1i(e,f.active),g=d.pos,g&&b.uniform3fv(d.pos,f.pos),d.dir&&b.uniform3fv(d.dir,f.dir);this._uGammaFactor&&b.uniform1f(this._uGammaFactor,c.gammaFactor)},xeogl.renderer.GhostEdgesRenderer.prototype.drawObject=function(a,b,c){a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a));var d=this._gl,e=0===c?b.ghostMaterial:1===c?b.highlightMaterial:b.selectedMaterial,f=b.modelTransform,g=b.geometry;if(e.id!==this._lastMaterialId){if(a.lineWidth!==e.edgeWidth&&(d.lineWidth(e.edgeWidth),a.lineWidth=e.edgeWidth),this._uEdgeColor){var h=e.edgeColor,i=e.edgeAlpha;d.uniform4f(this._uEdgeColor,h[0],h[1],h[2],i)}this._lastMaterialId=e.id}f.id!==this._lastModelTransformId&&(d.uniformMatrix4fv(this._uModelMatrix,d.FALSE,f.getMatrix()),this._uModelNormalMatrix&&d.uniformMatrix4fv(this._uModelNormalMatrix,d.FALSE,f.getNormalMatrix()),this._lastModelTransformId=f.id);var j=b.modes;if(this._uClippable&&d.uniform1i(this._uClippable,j.clippable),g.combined){var k=b.vertexBufs;k.id!==this._lastVertexBufsId&&(k.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(k.positionsBuf,k.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),k.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(k.normalsBuf,k.quantized?d.BYTE:d.FLOAT),a.bindArray++),this._lastVertexBufsId=k.id)}var l;g.primitive===d.TRIANGLES?l=g.getGhostEdgesIndices():g.primitive===d.LINES&&(l=g.indicesBuf),l&&(g.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&d.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,g.positionsDecodeMatrix),g.combined||(this._aPosition&&(this._aPosition.bindArrayBuffer(g.positionsBuf,g.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(g.normalsBuf,g.quantized?d.BYTE:d.FLOAT),a.bindArray++)),l.bind(),a.bindArray++,this._lastGeometryId=g.id),d.drawElements(d.LINES,l.numItems,l.itemType,0),a.drawElements++)}}(),function(){"use strict";function a(a){var b=a.geometry.primitiveName;return!(!a.geometry.autoVertexNormals&&!a.geometry.normals||"triangles"!==b&&"triangle-strip"!==b&&"triangle-fan"!==b)}function b(a,b,c,d){var e=d.modes.billboard,f=[];return f.push("// Edges drawing vertex shader"),f.push("attribute vec3 position;"),f.push("uniform mat4 modelMatrix;"),f.push("uniform mat4 viewMatrix;"),f.push("uniform mat4 projMatrix;"),f.push("uniform vec4 edgeColor;"),b.quantizedGeometry&&f.push("uniform mat4 positionsDecodeMatrix;"),b.clipping&&f.push("varying vec4 vWorldPosition;"),b.normals&&(f.push("attribute vec3 normal;"),b.quantizedGeometry&&(f.push("vec3 octDecode(vec2 oct) {"),f.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),f.push("    if (v.z < 0.0) {"),f.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),f.push("    }"),f.push("    return normalize(v);"),f.push("}"))),f.push("varying vec4 vColor;"),"spherical"!==e&&"cylindrical"!==e||(f.push("void billboard(inout mat4 mat) {"),f.push("   mat[0][0] = 1.0;"),f.push("   mat[0][1] = 0.0;"),f.push("   mat[0][2] = 0.0;"),"spherical"===e&&(f.push("   mat[1][0] = 0.0;"),f.push("   mat[1][1] = 1.0;"),f.push("   mat[1][2] = 0.0;")),f.push("   mat[2][0] = 0.0;"),f.push("   mat[2][1] = 0.0;"),f.push("   mat[2][2] =1.0;"),f.push("}")),f.push("void main(void) {"),f.push("vec4 localPosition = vec4(position, 1.0); "),f.push("vec4 worldPosition;"),b.quantizedGeometry&&f.push("localPosition = positionsDecodeMatrix * localPosition;"),b.normals&&(b.quantizedGeometry?f.push("vec3 localNormal = octDecode(normal.xy); "):f.push("vec3 localNormal = normal; ")),f.push("mat4 viewMatrix2 = viewMatrix;"),f.push("mat4 modelMatrix2 = modelMatrix;"),d.modes.stationary&&f.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===e||"cylindrical"===e?(f.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),f.push("billboard(modelMatrix2);"),f.push("billboard(viewMatrix2);"),f.push("billboard(modelViewMatrix);"),f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),f.push("vColor = edgeColor;"),b.clipping&&f.push("vWorldPosition = worldPosition;"),f.push("   gl_Position = projMatrix * viewPosition;"),f.push("}"),f}function c(a,b,c,d){var e,f=[];if(f.push("// Edges drawing fragment shader"),f.push("precision lowp float;"),b.gammaOutput&&(f.push("uniform float gammaFactor;"),f.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),f.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),f.push("}")),b.clipping)for(f.push("varying vec4 vWorldPosition;"),f.push("uniform bool clippable;"),e=0;e<c.clips.clips.length;e++)f.push("uniform bool clipActive"+e+";"),f.push("uniform vec3 clipPos"+e+";"),f.push("uniform vec3 clipDir"+e+";");if(f.push("varying vec4 vColor;"),f.push("void main(void) {"),b.clipping){for(f.push("if (clippable) {"),f.push("  float dist = 0.0;"),e=0;e<c.clips.clips.length;e++)f.push("if (clipActive"+e+") {"),f.push("   dist += clamp(dot(-clipDir"+e+".xyz, vWorldPosition.xyz - clipPos"+e+".xyz), 0.0, 1000.0);"),f.push("}");f.push("  if (dist > 0.0) { discard; }"),f.push("}")}return f.push("gl_FragColor = vColor;"),b.gammaOutput?f.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):f.push("gl_FragColor = vColor;"),f.push("}"),f}xeogl.renderer.GhostEdgesShaderSource=function(d,e,f){var g={normals:a(f),clipping:e.clips.clips.length>0,quantizedGeometry:!!f.geometry.quantized,gammaOutput:e.gammaOutput};this.vertex=b(d,g,e,f),this.fragment=c(d,g,e,f)}}(),function(){"use strict";xeogl.Component=Class.extend({__init:function(){var a={},b=arguments[0],c=arguments[1];this.scene=null;var d=null;"xeogl.Scene"===this.type?(this.scene=this,b&&(a=b)):(b?"xeogl.Scene"===b.type?(this.scene=b,d=this.scene,c&&(a=c)):b.isType&&b.isType("xeogl.Component")?(this.scene=b.scene,d=b,c&&(a=c)):(this.scene=xeogl.scene,d=this.scene,a=b):(this.scene=xeogl.scene,d=this.scene),this._renderer=this.scene._renderer),this.meta=a.meta||{},this.isDefault=a.isDefault,this.id=a.id,this.destroyed=!1,this._attached={},this._attachments=null,this._handleMap=null,this._handleEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._adoptees=null,this.scene&&"xeogl.Scene"!==this.type&&this.scene._addComponent(this),this._updateScheduled=!1,this._init&&this._init(a),d&&d._adopt(this)},type:"xeogl.Component",superTypes:[],isType:function(a){return!(!xeogl._isString(a)&&!(a=a.type))&&xeogl._isComponentType(this.type,a)},_init:function(a){},fire:function(a,b,c){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==c&&(this._events[a]=b);var d,e=this._eventSubs[a];if(e)for(var f in e)e.hasOwnProperty(f)&&(d=e[f],this._eventCallDepth++,this._eventCallDepth<300?d.callback.call(d.scope,b):this.error("fire: potential stack overflow from recursive event '"+a+"' - dropping this event"),this._eventCallDepth--)},on:function(a,b,c){this._events||(this._events={}),this._handleMap||(this._handleMap=new xeogl.utils.Map),this._handleEvents||(this._handleEvents={}),this._eventSubs||(this._eventSubs={});var d=this._eventSubs[a];d||(d={},this._eventSubs[a]=d);var e=this._handleMap.addItem();d[e]={callback:b,scope:c||this},this._handleEvents[e]=a;var f=this._events[a];return void 0!==f&&b.call(c||this,f),e},off:function(a){if(void 0!==a&&null!==a&&this._handleEvents){var b=this._handleEvents[a];if(b){delete this._handleEvents[a];var c=this._eventSubs[b];c&&delete c[a],this._handleMap.removeItem(a)}}},once:function(a,b,c){var d=this,e=this.on(a,function(a){d.off(e),b(a)},c)},hasSubs:function(a){return this._eventSubs&&!!this._eventSubs[a]},log:function(a){a="[LOG]"+this._message(a),window.console.log(a),this.scene.fire("log",a)},_message:function(a){return" ["+this.type+" "+xeogl._inQuotes(this.id)+"]: "+a},warn:function(a){a="[WARN]"+this._message(a),window.console.warn(a),this.scene.fire("warn",a)},error:function(a){a="[ERROR]"+this._message(a),window.console.error(a),this.scene.fire("error",a)},_attach:function(a){var b=a.name;if(!b)return void this.error("Component 'name' expected");var c=a.component,d=a.sceneDefault,e=a.sceneSingleton,f=a.type,g=a.on,h=!1!==a.recompiles,i=!1;if(c)if(xeogl._isNumeric(c)||xeogl._isString(c)){var j=c;if(!(c=this.scene.components[j]))return void this.error("Component not found: "+xeogl._inQuotes(j))}else if(xeogl._isObject(c)){var k=c,l=k.type||f||"xeogl.Component",m=window[l];if(!m)return void this.error("Component type not found: "+l);if(f&&!xeogl._isComponentType(l,f))return void this.error("Expected a "+f+" type or subtype, not a "+l);c=new m(this.scene,k),i=!0}if(!c)if(!0===e){var n=this.scene.types[f];for(var o in n)if(n.hasOwnProperty){c=n[o];break}if(!c)return this.error("Scene has no default component for '"+b+"'"),null}else if(!0===d&&!(c=this.scene[b]))return this.error("Scene has no default component for '"+b+"'"),null;if(c){if(c.scene.id!==this.scene.id)return void this.error("Not in same scene: "+c.type+" "+xeogl._inQuotes(c.id));if(f&&!c.isType(f))return void this.error("Expected a "+f+" type or subtype: "+c.type+" "+xeogl._inQuotes(c.id))}this._attachments||(this._attachments={});var p,q,r,s=this._attached[b];if(s){if(c&&s.id===c.id)return;var t=this._attachments[s.id];for(p=t.subs,q=0,r=p.length;q<r;q++)s.off(p[q]);delete this._attached[b],delete this._attachments[s.id];var u=t.params.onDetached;u&&(xeogl._isFunction(u)?u(s):u.scope?u.callback.call(u.scope,s):u.callback(s)),t.managingLifecycle&&s.destroy()}if(c){var v={params:a,component:c,subs:[],managingLifecycle:i};v.subs.push(c.on("destroyed",function(){v.params.component=null,this._attach(v.params)},this)),h&&v.subs.push(c.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[b]=c,this._attachments[c.id]=v;var w=a.onAttached;if(w&&(xeogl._isFunction(w)?w(c):w.scope?w.callback.call(w.scope,c):w.callback(c)),g){var x,y,z,A;for(x in g)if(g.hasOwnProperty(x)){if(y=g[x],xeogl._isFunction(y)?(z=y,A=null):(z=y.callback,A=y.scope),!z)continue;v.subs.push(c.on(x,z,A))}}}return h&&this.fire("dirty",this),this.fire(b,c),c},create:function(a){var b,c;if(xeogl._isObject(a)?(b=a.type||"xeogl.Component",c=xeogl[b.substring(6)]):xeogl._isString(a)?(b=a,c=xeogl[b.substring(6)]):(c=a,b=a.prototype.type),!c)return void this.error("Component type not found: "+b);if(!xeogl._isComponentType(b,"xeogl.Component"))return void this.error("Expected a xeogl.Component type or subtype");a&&a.id&&this.components[a.id]&&(this.error("Component "+xeogl._inQuotes(a.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),a.id=void 0);var d=new c(this,a);return d&&this._adopt(d),d},_adopt:function(a){this._adoptees||(this._adoptees={}),this._adoptees[a.id]||(this._adoptees[a.id]=a),a.on("destroyed",function(){delete this._adoptees[a.id]},this)},_needUpdate:function(a){this._updateScheduled||(this._updateScheduled=!0,0===a?xeogl.deferTask(this._doUpdate,this):xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())},_update:null,destroy:function(){if(!this.destroyed){var a,b,c,d,e,f;if(this._attachments)for(a in this._attachments)if(this._attachments.hasOwnProperty(a)){for(b=this._attachments[a],c=b.component,d=b.subs,e=0,f=d.length;e<f;e++)c.off(d[e]);b.managingLifecycle&&c.destroy()}if(this._adoptees)for(a in this._adoptees)this._adoptees.hasOwnProperty(a)&&(c=this._adoptees[a],delete this._adoptees[a]);this._destroy&&this._destroy(),this.fire("destroyed",this.destroyed=!0)}},_destroy:function(){}})}(),function(){"use strict";xeogl.Scene=xeogl.Component.extend({type:"xeogl.Scene",_init:function(a){var b=this,c=!!a.transparent;this.loading=0,this.startTime=(new Date).getTime(),this.components={},this.types={},this.entities={},this.models={},this._dirtyEntities={},this.canvas=new xeogl.Canvas(this,{canvas:a.canvas,transparent:c,backgroundColor:a.backgroundColor,backgroundImage:a.backgroundImage,webgl2:!1!==a.webgl2,contextAttr:a.contextAttr||{}}),this.canvas.on("boundary",function(){b._renderer.imageDirty()}),this.canvas.on("webglContextFailed",function(){alert("xeogl failed to find WebGL!")}),this._renderer=new xeogl.renderer.Renderer(xeogl.stats,this.canvas.canvas,this.canvas.gl,{transparent:c}),this.input=new xeogl.Input(this,{element:this.canvas.canvas}),xeogl._addScene(this);var d=a.components;if(d)for(var e,f,g,h=0,i=d.length;h<i;h++)e=d[h],(f=e.type)&&(g=window[f])&&new g(this,e);this._initDefaults(),this._viewport=new xeogl.Viewport(this,{id:"default.viewport",autoBoundary:!0}),this._camera=new xeogl.Camera(this,{id:"default.camera"}),this._clips=new xeogl.Clips(this,{id:"default.clips"}),this._lights=new xeogl.Lights(this,{id:"default.lights",lights:[new xeogl.DirLight(this,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),new xeogl.DirLight(this,{dir:[-.8,-.4,-.4],color:[1,1,1],intensity:1,space:"view"}),new xeogl.DirLight(this,{dir:[.2,-.8,.8],color:[.6,.6,.6],intensity:1,space:"view"})]});var j=this._viewport,k=this._renderer,l=this._camera,m=this._clips,n=this._lights;k.viewport=j._state,k.projTransform=l[l.projection]._state,k.viewTransform=l._state,k.lights=n._getState(),k.clips=m._getState(),l.on("dirty",function(){k.projTransform=l.project._state,k.viewTransform=l._state,k.imageDirty()}),m.on("dirty",function(){k.clips=m._getState();for(var a in b.entities)b.entities.hasOwnProperty(a)&&b._entityDirty(b.entities[a])}),n.on("dirty",function(){k.lights=n._getState();for(var a in b.entities)b.entities.hasOwnProperty(a)&&(b._entityDirty(b.entities[a]),!0)}),this.ticksPerRender=a.ticksPerRender,this.passes=a.passes,this.clearEachPass=a.clearEachPass,this.gammaInput=a.gammaInput,this.gammaOutput=a.gammaOutput,this.gammaFactor=a.gammaFactor},_initDefaults:function(){this.geometry,this.material,this.ghostMaterial,this.outlineMaterial,this.transform},_addComponent:function(a){if(a.id){if(this.components[a.id])return void this.error("Component "+xeogl._inQuotes(a.id)+" already exists in Scene - ignoring ID, will randomly-generate instead")}else for(void 0===window.nextID&&(window.nextID=0),a.id="_"+window.nextID++;this.components[a.id];)a.id=xeogl.math.createUUID();this.components[a.id]=a;var b=a.type,c=this.types[a.type];c||(c=this.types[b]={}),c[a.id]=a,a.on("destroyed",function(){this._componentDestroyed(a)},this),a.isType("xeogl.Entity")&&(a.on("dirty",this._entityDirty,this),this.entities[a.id]=a,a.on("boundary",this._setBoundaryDirty,this),xeogl.stats.components.entities++),a.isType("xeogl.Model")&&(this.models[a.id]=a,xeogl.stats.components.models++)},_componentDestroyed:function(a){delete this.components[a.id];var b=this.types[a.type];b&&(delete b[a.id],xeogl._isEmptyObject(b)&&delete this.types[a.type]),a.isType("xeogl.Entity")&&(xeogl.stats.components.entities--,delete this.entities[a.id],delete this._dirtyEntities[a.id],xeogl.stats.components.entities--),a.isType("xeogl.Model")&&(delete this.models[a.id],xeogl.stats.components.models--)},_entityDirty:function(a){this._dirtyEntities[a.id]=a},render:function(){var a={sceneId:null,pass:null};return function(b){var c=this._renderer.imageForceDirty;if(this.loading>0&&!b&&!c)return void this._compileDirtyEntities(100);if(this.canvas.spinner.processes>0&&!c)return void this._compileDirtyEntities(100);this._compileDirtyEntities(15),a.sceneId=this.id;var d,e,f=this._passes,g=this._clearEachPass;for(d=0;d<f;d++)a.pass=d,this.fire("rendering",a,!0),e=g||0===d,this._renderer.render({pass:d,clear:e,force:b}),this.fire("rendered",a,!0);this._saveAmbientColor()}}(),_compileDirtyEntities:function(a){var b,c=(new Date).getTime();for(var d in this._dirtyEntities)if(this._dirtyEntities.hasOwnProperty(d)){b=this._dirtyEntities[d],b._valid()&&(b._compile(),delete this._dirtyEntities[d]);var e=(new Date).getTime();if(e-c>a)return}},_saveAmbientColor:function(){var a=this.canvas;if(a.transparent||a.backgroundImage||a.backgroundColor)this._lastAmbientColor=null;else{var b=this._renderer.getAmbientColor();this._lastAmbientColor&&this._lastAmbientColor[0]===b[0]&&this._lastAmbientColor[1]===b[1]&&this._lastAmbientColor[2]===b[2]&&this._lastAmbientColor[3]===b[3]||(a.backgroundColor=b,this._lastAmbientColor||(this._lastAmbientColor=xeogl.math.vec4([0,0,0,1])),this._lastAmbientColor.set(b))}},_props:{ticksPerRender:{set:function(a){void 0===a||null===a?a=1:(!xeogl._isNumeric(a)||a<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+a+"' - should be an integer greater than zero."),a=1),a!==this._ticksPerRender&&(this._ticksPerRender=a)},get:function(){return this._ticksPerRender}},passes:{set:function(a){void 0===a||null===a?a=1:(!xeogl._isNumeric(a)||a<=0)&&(this.error("Unsupported value for 'passes': '"+a+"' - should be an integer greater than zero."),a=1),a!==this._passes&&(this._passes=a,this._renderer.imageDirty())},get:function(){return this._passes}},clearEachPass:{set:function(a){(a=!!a)!==this._clearEachPass&&(this._clearEachPass=a,this._renderer.imageDirty())},get:function(){return this._clearEachPass}},gammaInput:{set:function(a){if((a=!1!==a)!==this._renderer.gammaInput){this._renderer.gammaInput=a;for(var b in this.entities)this.entities.hasOwnProperty(b)&&this._entityDirty(this.entities[b])}},get:function(){return this._renderer.gammaInput}},gammaOutput:{set:function(a){if((a=!1!==a)!==this._renderer.gammaOutput){this._renderer.gammaOutput=a;for(var b in this.entities)this.entities.hasOwnProperty(b)&&this._entityDirty(this.entities[b])}},get:function(){return this._renderer.gammaOutput}},gammaFactor:{set:function(a){(a=void 0===a||null===a?2.2:a)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=a,this._renderer.imageDirty())},get:function(){return this._renderer.gammaFactor}},transform:{get:function(){return this.components["default.transform"]||new xeogl.Transform(this,{id:"default.transform",isDefault:!0})}},geometry:{get:function(){return this.components["default.geometry"]||new xeogl.BoxGeometry(this,{id:"default.geometry",isDefault:!0})}},material:{get:function(){return this.components["default.material"]||new xeogl.PhongMaterial(this,{id:"default.material",isDefault:!0,emissive:[.4,.4,.4]})}},ghostMaterial:{get:function(){return this.components["default.ghostMaterial"]||new xeogl.EmphasisMaterial(this,{id:"default.ghostMaterial",preset:"sepia",isDefault:!0})}},highlightMaterial:{get:function(){return this.components["default.highlightMaterial"]||new xeogl.EmphasisMaterial(this,{id:"default.highlightMaterial",preset:"yellowHighlight",isDefault:!0})}},selectedMaterial:{get:function(){return this.components["default.selectedMaterial"]||new xeogl.EmphasisMaterial(this,{id:"default.selectedMaterial",preset:"greenSelected",isDefault:!0})}},outlineMaterial:{get:function(){return this.components["default.outlineMaterial"]||new xeogl.OutlineMaterial(this,{id:"default.outlineMaterial",isDefault:!0})}},viewport:{get:function(){return this._viewport}},lights:{get:function(){return this._lights}},camera:{get:function(){return this._camera}},clips:{get:function(){return this._clips}},center:{get:function(){if(this._aabbDirty){this._center||(this._center=xeogl.math.AABB3());var a=this.aabb;this._center[0]=(a[0]+a[3])/2,this._center[1]=(a[1]+a[4])/2,this._center[2]=(a[2]+a[5])/2}return this._center}},aabb:{get:function(){if(this._aabbDirty){this._aabb||(this._aabb=xeogl.math.AABB3());var a,b,c=xeogl.math.MAX_DOUBLE,d=xeogl.math.MAX_DOUBLE,e=xeogl.math.MAX_DOUBLE,f=-xeogl.math.MAX_DOUBLE,g=-xeogl.math.MAX_DOUBLE,h=-xeogl.math.MAX_DOUBLE,i=this.entities;for(var j in i)if(i.hasOwnProperty(j)){if(b=i[j],!b.collidable)continue;if(!(a=b.aabb)){this.error("internal error: entity without aabb: "+j);continue}a[0]<c&&(c=a[0]),a[1]<d&&(d=a[1]),a[2]<e&&(e=a[2]),a[3]>f&&(f=a[3]),a[4]>g&&(g=a[4]),a[5]>h&&(h=a[5])}this._aabb[0]=c,this._aabb[1]=d,this._aabb[2]=e,this._aabb[3]=f,this._aabb[4]=g,this._aabb[5]=h,this._aabbDirty=!1}return this._aabb}}},_setBoundaryDirty:function(){this._aabbDirty||(this._aabbDirty=!0,this.fire("boundary"))},pick:function(){function a(a,b){for(var c,d,e={},f=0,g=b.length;f<g;f++)c=b[f],d=a.entities[c],d?e[d._objectId]=!0:a.warn("pick(): Entity not found: "+c);return e}var b=xeogl.math,c=b.vec3(),d=b.vec3(),e=b.vec3(),f=b.vec3(),g=b.vec3(),h=b.vec3(),i=b.vec4(),j=b.vec3(),k=b.vec3(),l=b.vec3(),m=b.vec3(),n=b.vec3(),o=b.vec3(),p=b.vec3(),q=b.vec3(),r=b.vec3(),s=b.vec4(),t=b.vec4(),u=b.vec4(),v=b.vec3(),w=b.vec3(),x=b.vec3(),y=b.vec3(),z=b.vec3(),A=b.vec3(),B=b.vec3(),C=b.vec3(),D=b.vec3(),E=b.vec3(),F=b.vec3();return function(G){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;G=G||{},G.pickSurface=G.pickSurface||G.rayPick,G.canvasPos||G.origin&&G.direction||this.warn("picking without canvasPos or ray origin and direction"),G.include&&(G.includeObjects=a(this,G.include)),G.exclude&&(G.excludeObjects=a(this,G.exclude));var H=this._renderer.pick(G);if(H){var I=this.entities[H.entity];if(H.entity=I,G.pickSurface&&void 0!==H.primIndex&&H.primIndex>-1){var J=I.geometry._state;if("triangles"===J.primitiveName){H.primitive="triangle";var K,L,M,N=H.primIndex,O=J.indices,P=J.positions;if(O){var Q=O[N+0],R=O[N+1],S=O[N+2];h[0]=Q,h[1]=R,h[2]=S,H.indices=h,K=3*Q,L=3*R,M=3*S}else K=3*N,L=K+3,M=L+3;if(e[0]=P[K+0],e[1]=P[K+1],e[2]=P[K+2],f[0]=P[L+0],f[1]=P[L+1],f[2]=P[L+2],g[0]=P[M+0],g[1]=P[M+1],g[2]=P[M+2],J.quantized){var T=J.positionsDecodeMatrix;T&&(b.decompressPosition(e,T,e),b.decompressPosition(f,T,f),b.decompressPosition(g,T,g))}var U;G.canvasPos?(U=G.canvasPos,H.canvasPos=G.canvasPos,b.canvasPosToLocalRay(this.camera,I,U,c,d)):G.origin&&G.direction&&b.worldRayToLocalRay(I,G.origin,G.direction,c,d),b.normalizeVec3(d),b.rayPlaneIntersect(c,d,e,f,g,i),H.localPos=i,H.position=i,s[0]=i[0],s[1]=i[1],s[2]=i[2],s[3]=1,b.transformVec4(I.transform.leafMatrix,s,t),j[0]=t[0],j[1]=t[1],j[2]=t[2],H.worldPos=j,b.transformVec4(I.scene.camera.matrix,t,u),k[0]=u[0],k[1]=u[1],k[2]=u[2],H.viewPos=k,b.cartesianToBarycentric(i,e,f,g,l),H.bary=l;var V=J.normals;if(V){if(J.quantized){var W=2*Q,X=2*R,Y=2*S;b.octDecodeVec2(V.subarray(W,W+2),m),b.octDecodeVec2(V.subarray(X,X+2),n),b.octDecodeVec2(V.subarray(Y,Y+2),o)}else m[0]=V[K],m[1]=V[K+1],m[2]=V[K+2],n[0]=V[L],n[1]=V[L+1],n[2]=V[L+2],o[0]=V[M],o[1]=V[M+1],o[2]=V[M+2];var Z=b.addVec3(b.addVec3(b.mulVec3Scalar(m,l[0],v),b.mulVec3Scalar(n,l[1],w),x),b.mulVec3Scalar(o,l[2],y),z);H.normal=b.transformVec3(I.transform.leafNormalMatrix,Z,A)}var $=J.uv;if($){if(p[0]=$[2*Q],p[1]=$[2*Q+1],q[0]=$[2*R],q[1]=$[2*R+1],r[0]=$[2*S],r[1]=$[2*S+1],J.quantized){var _=J.uvDecodeMatrix;_&&(b.decompressUV(p,_,p),b.decompressUV(q,_,q),b.decompressUV(r,_,r))}H.uv=b.addVec3(b.addVec3(b.mulVec2Scalar(p,l[0],B),b.mulVec2Scalar(q,l[1],C),D),b.mulVec2Scalar(r,l[2],E),F)}}}return H}}}(),getAABB:function(a){if(0===arguments.length||void 0===a)return this.aabb;if(xeogl._isArray(a)&&!xeogl._isString(a[0]))return a;if(xeogl._isString(a)&&(a=[a]),0===a.length)return this.aabb;var b,c;if(1===a.length)return b=a[0],c=this.components[b],c?c.aabb||this.aabb:this.aabb;var d,e,f,g=1e5,h=1e5,i=1e5,j=-1e5,k=-1e5,l=-1e5,m=!1;for(d=0,e=a.length;d<e;d++)b=a[d],(c=this.components[b])&&!(f=c.aabb)||(f[0]<g&&(g=f[0]),f[1]<h&&(h=f[1]),f[2]<i&&(i=f[2]),f[3]>j&&(j=f[3]),f[4]>k&&(k=f[4]),f[5]>l&&(l=f[5]),m=!0);if(m){var n=new xeogl.math.AABB3;return n[0]=g,n[1]=h,n[2]=i,n[3]=j,n[4]=k,n[5]=l,n}return this.aabb},clear:function(){for(var a in this.components)this.components.hasOwnProperty(a)&&this.components[a].destroy();this._initDefaults(),this._dirtyEntities={}},_destroy:function(){this.clear()}})}(),function(){"use strict";var a=xeogl.math;xeogl.CameraFlightAnimation=xeogl.Component.extend({type:"xeogl.CameraFlightAnimation",_init:function(b){this._aabbHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.AABBGeometry"}),material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[.5,1,.5],lineWidth:2}),visible:!1,collidable:!1}),this._obbHelper=this.create({type:"xeogl.Entity",geometry:this.create({type:"xeogl.OBBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[.5,1,.5],lineWidth:2})}),visible:!1,collidable:!1}),this._look1=a.vec3(),this._eye1=a.vec3(),this._up1=a.vec3(),this._look2=a.vec3(),this._eye2=a.vec3(),this._up2=a.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingUp=!1,this._callback=null,this._callbackScope=null,this._onTick=null,this._time1=null,this._time2=null,this.easing=!1!==b.easing,this.duration=b.duration,this.fit=b.fit,this.fitFOV=b.fitFOV,this.trail=b.trail},flyTo:function(){var b=a.vec3();return function(c,d,e){c=c||this.scene,this._flying&&this.stop(),this._flying=!1,this._callback=d,this._callbackScope=e;var f=this.scene.camera;this._eye1[0]=f.eye[0],this._eye1[1]=f.eye[1],this._eye1[2]=f.eye[2],this._look1[0]=f.look[0],this._look1[1]=f.look[1],this._look1[2]=f.look[2],this._up1[0]=f.up[0],this._up1[1]=f.up[1],this._up1[2]=f.up[2],this._orthoScale1=f.ortho.scale,this._orthoScale2=c.orthoScale||this._orthoScale1;var g,h,i,j,k;if(c.aabb)g=c.aabb;else if(6===c.length)g=c;else if(c.eye&&c.look||c.up)h=c.eye,i=c.look,j=c.up;else if(c.eye)h=c.eye;else if(c.look)i=c.look;else{var l=c;if((xeogl._isNumeric(l)||xeogl._isString(l))&&(k=l,!(l=this.scene.components[k])))return this.error("Component not found: "+xeogl._inQuotes(k)),void(d&&(e?d.call(e):d()));g=l.aabb||this.scene.aabb}var m=c.offset;if(g){if(g[3]<g[0]||g[4]<g[1]||g[5]<g[2])return;if(g[3]===g[0]&&g[4]===g[1]&&g[5]===g[2])return;!1!==c.showAABB&&(this._aabbHelper.geometry.targetAABB=g,this._aabbHelper.visible=!0);var n=a.getAABB3Center(g);this._look2=c.look||n,m&&(this._look2[0]+=m[0],this._look2[1]+=m[1],this._look2[2]+=m[2]);var o=a.subVec3(this._eye1,this._look1,b),p=a.normalizeVec3(o),q=(c.look,a.getAABB3Diag(g)),r=c.fitFOV||this._fitFOV,s=Math.abs(q/Math.tan(r*xeogl.math.DEGTORAD));this._orthoScale2=1.1*q,this._eye2[0]=this._look2[0]+p[0]*s,this._eye2[1]=this._look2[1]+p[1]*s,this._eye2[2]=this._look2[2]+p[2]*s,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyEyeLookUp=!1}else(h||i||j)&&(this._flyEyeLookUp=!!h&&!!i&&!!j,this._flyingEye=!!h&&!i,this._flyingLook=!!i&&!h,i&&(this._look2[0]=i[0],this._look2[1]=i[1],this._look2[2]=i[2]),h&&(this._eye2[0]=h[0],this._eye2[1]=h[1],this._eye2[2]=h[2]),j&&(this._up2[0]=j[0],this._up2[1]=j[1],this._up2[2]=j[2]));this.fire("started",c,!0),this._time1=Date.now(),this._time2=this._time1+(c.duration?1e3*c.duration:this._duration),this._flying=!0,xeogl.scheduleTask(this._update,this)}}(),jumpTo:function(a){this._jumpTo(a)},_jumpTo:function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3();return function(g){this._flying&&this.stop();var h,i,j=this.scene.camera;if(g.aabb)h=g.aabb;else if(6===g.length)h=g;else if(g.eye||g.look||g.up)b=g.eye,c=g.look,d=g.up;else{var k=g;if((xeogl._isNumeric(k)||xeogl._isString(k))&&(i=k,!(k=this.scene.components[i])))return void this.error("Component not found: "+xeogl._inQuotes(i));h=k.aabb||this.scene.aabb}g.offset;if(h){var l;if(h[3]<=h[0]||h[4]<=h[1]||h[5]<=h[2])return;l=a.getAABB3Diag(h),a.getAABB3Center(h,c),this._trail?a.subVec3(j.look,c,e):a.subVec3(j.eye,j.look,e),a.normalizeVec3(e);var m;m=(void 0!==g.fit?g.fit:this._fit)?Math.abs(l/Math.tan((g.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD)):a.lenVec3(a.subVec3(j.eye,j.look,f)),a.mulVec3Scalar(e,m),j.eye=a.addVec3(c,e,b),j.look=c}else(b||c||d)&&(b&&(j.eye=b),c&&(j.look=c),d&&(j.up=d))}}(),_update:function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3();return function(){if(this._flying){var g=Date.now(),h=(g-this._time1)/(this._time2-this._time1),i=h>=1;h>1&&(h=1),h=this.easing?this._ease(h,0,1,1):h;var j=this.scene.camera;if(this._flyingEye||this._flyingLook)this._flyingEye?(a.subVec3(j.eye,j.look,b),j.eye=a.lerpVec3(h,0,1,this._eye1,this._eye2,c),j.look=a.subVec3(c,b,d)):this._flyingLook&&(j.look=a.lerpVec3(h,0,1,this._look1,this._look2,d),j.up=a.lerpVec3(h,0,1,this._up1,this._up2,e));else if(this._flyEyeLookUp)j.eye=a.lerpVec3(h,0,1,this._eye1,this._eye2,c),j.look=a.lerpVec3(h,0,1,this._look1,this._look2,d),j.up=a.lerpVec3(h,0,1,this._up1,this._up2,e);else{a.lerpVec3(h,0,1,this._look1,this._look2,d);var k;this._trail?a.subVec3(d,j.look,b):a.subVec3(j.eye,j.look,b),a.normalizeVec3(b),a.lerpVec3(h,0,1,this._eye1,this._eye2,c),a.subVec3(c,d,f),k=a.lenVec3(f),a.mulVec3Scalar(b,k),j.eye=a.addVec3(d,b,c),j.look=d}if(this.scene.camera.ortho.scale=this._orthoScale1+h*(this._orthoScale2-this._orthoScale1),i)return void this.stop();xeogl.scheduleTask(this._update,this)}}}(),_ease:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},stop:function(){if(this._flying){this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null;var a=this._callback;a&&(this._callback=null,this._callbackScope?a.call(this._callbackScope):a()),this.fire("stopped",!0,!0)}},cancel:function(){this._flying&&(this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))},_props:{duration:{set:function(a){this._duration=a?1e3*a:500,this.stop()},get:function(){return this._duration/1e3}},fit:{set:function(a){this._fit=!1!==a},get:function(){return this._fit}},fitFOV:{set:function(a){this._fitFOV=a||45},get:function(){return this._fitFOV}},trail:{set:function(a){this._trail=!!a},get:function(){return this._trail}}},_destroy:function(){this.stop()}})}(),function(){"use strict";xeogl.Canvas=xeogl.Component.extend({type:"xeogl.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(a){if(this.canvas=null,this.gl=null,this.webgl2=!1,this.transparent=!!a.transparent,this.contextAttr=a.contextAttr||{},this.contextAttr.alpha=this.transparent,void 0!==this.contextAttr.preserveDrawingBuffer&&null!==this.contextAttr.preserveDrawingBuffer||(this.contextAttr.preserveDrawingBuffer=!1),this.contextAttr.stencil=!0,this.contextAttr.antialias=!0,this.contextAttr.premultipliedAlpha=!1!==this.contextAttr.premultipliedAlpha,a.canvas?xeogl._isString(a.canvas)?(this.canvas=document.getElementById(a.canvas),this.canvas||(this.error("Canvas element not found: "+xeogl._inQuotes(a.canvas)+" - creating default canvas instead."),this._createCanvas())):this.canvas=a.canvas:this._createCanvas(),!this.canvas)return void this.error("Faied to create canvas");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._createBackground(),this._initWebGL(a);var b=this;this.canvas.addEventListener("webglcontextlost",function(){b.fire("webglContextLost")},!1),this.canvas.addEventListener("webglcontextrestored",function(){b._initWebGL(),b.gl&&b.fire("webglContextRestored",b.gl)},!1);var c=null,d=null,e=null,f=null,g=null,h=null,i=null;this._tick=this.scene.on("tick",function(){var a=b.canvas,j=window.innerWidth!==c||window.innerHeight!==d,k=a.clientWidth!==e||a.clientHeight!==f,l=a.offsetLeft!==g||a.offsetTop!==h,m=a.parentElement,n=m!==i;if(j||k||l||n){if(b._spinner._adjustPosition(),k||l){var o=a.clientWidth,p=a.clientHeight;if(k){var q,r=0;for(var s in xeogl.scenes)xeogl.scenes.hasOwnProperty(s)&&(q=xeogl.scenes[s],r+=q.canvas.canvas.clientWidth*q.canvas.canvas.clientHeight)
;xeogl.stats.memory.pixels=r,a.width=a.clientWidth,a.height=a.clientHeight}var t=b.boundary;t[0]=a.offsetLeft,t[1]=a.offsetTop,t[2]=o,t[3]=p,b.fire("boundary",t),e=o,f=p}j&&(c=window.innerWidth,d=window.innerHeight),l&&(g=a.offsetLeft,h=a.offsetTop),i=m}}),this.canvas.oncontextmenu=function(a){a.preventDefault()},this._spinner=new xeogl.Spinner(this.scene,{canvas:this.canvas}),this.backgroundColor=a.backgroundColor,this.backgroundImage=a.backgroundImage},_createCanvas:function(){var a="xeogl-canvas-"+xeogl.math.createUUID(),b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height="100%",d.width="100%",d.padding="0",d.margin="0",d.background="rgba(0,0,0,0);",d.float="left",d.left="0",d.top="0",d.position="absolute",d.opacity="1.0",d["z-index"]="-10000",c.innerHTML+='<canvas id="'+a+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',b.appendChild(c),this.canvas=document.getElementById(a)},_createBackground:function(){var a=document.createElement("div"),b=a.style;b.padding="0",b.margin="0",b.background=null,b.backgroundImage=null,b.float="left",b.left="0",b.top="0",b.width="100%",b.height="100%",b.position="absolute",b.opacity=1,b["z-index"]="-20000",this.canvas.parentElement.appendChild(a),this._backgroundElement=a},_getElementXY:function(a){for(var b=0,c=0;a;)b+=a.offsetLeft-a.scrollLeft,c+=a.offsetTop-a.scrollTop,a=a.offsetParent;return{x:b,y:c}},_initWebGL:function(a){if(!this.gl)for(var b=0;!this.gl&&b<this._WEBGL_CONTEXT_NAMES.length;b++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[b],this.contextAttr)}catch(c){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl&&xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_standard_derivatives&&(this.gl.getExtension("OES_standard_derivatives"),this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST))},getSnapshot:function(a,b){if(!this.canvas)return this.error("Can't get snapshot - no canvas."),void b(null);if(!b)return this._getSnapshot(a);var c=this;requestAnimationFrame(function(){c.scene.render(!0),b(c._getSnapshot(a))})},_getSnapshot:function(a){a=a||{};var b,c=a.width||this.canvas.width,d=a.height||this.canvas.height,e=a.format||"jpeg";switch(e){case"jpeg":b=Canvas2Image.saveAsJPEG(this.canvas,!1,c,d);break;case"png":b=Canvas2Image.saveAsPNG(this.canvas,!0,c,d);break;case"bmp":b=Canvas2Image.saveAsBMP(this.canvas,!0,c,d);break;default:this.error("Unsupported snapshot format: '"+e+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),b=Canvas2Image.saveAsJPEG(this.canvas,!0,c,d)}return b.src},readPixels:function(a,b,c,d){return this.scene._renderer.readPixels(a,b,c,d)},_props:{backgroundColor:{set:function(a){if(a){if((this._backgroundColor=this._backgroundColor||new xeogl.math.vec4).set(a||[0,0,0,1]),!this._backgroundImageSrc){var b="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=b}}else this._backgroundColor=null},get:function(){return this._backgroundColor}},backgroundImage:{set:function(a){if(a){if(!xeogl._isString(a))return void this.error("Value for 'backgroundImage' should be a string");if(a!==this._backgroundImageSrc&&(this._backgroundElement.style.backgroundImage="url('"+a+"')",this._backgroundImageSrc=a,!this._backgroundImageSrc)){var b="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=b}}},get:function(){return this._backgroundImageSrc}},spinner:{get:function(){return this._spinner}}},_destroy:function(){this.scene.off(this._tick)}})}(),function(){"use strict";var a=!1;xeogl.Spinner=xeogl.Component.extend({type:"xeogl.Spinner",serializable:!1,_init:function(a){this._canvas=a.canvas,this._injectSpinnerCSS();var b=document.createElement("div"),c=b.style;c["z-index"]="9000",c.position="absolute",b.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(b),this._element=b,this._adjustPosition(),this.processes=0,this.textures=a.textures},_props:{textures:{set:function(a){a=!1!==a,this._textures=a},get:function(){return this._textures}},processes:{set:function(a){a=a||0,this._processes!==a&&(a<0||(this._processes=a,this._element.style.visibility=this._processes>0?"visible":"hidden",this.fire("processes",this._processes)))},get:function(){return this._processes}}},_adjustPosition:function(){if(this._canvas&&this._element){var a=this._canvas,b=this._element,c=b.style;c.left=a.offsetLeft+.5*a.clientWidth-.5*b.clientWidth+"px",c.top=a.offsetTop+.5*a.clientHeight-.5*b.clientHeight+"px"}},_injectSpinnerCSS:function(){if(!a){var b=document.createElement("style");b.innerHTML=this._spinnerCSS,document.body.appendChild(b),a=!0}},_spinnerCSS:".sk-fading-circle {        margin: 100px auto;        width: 100px;        height:100px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }"})}(),function(){"use strict";xeogl.Clip=xeogl.Component.extend({type:"xeogl.Clip",_init:function(a){this._state={active:!0,pos:new Float32Array(3),dir:new Float32Array(3)},this.active=a.active,this.pos=a.pos,this.dir=a.dir},_props:{active:{set:function(a){this._state.active=!1!==a,this.fire("active",this._state.active)},get:function(){return this._state.active}},pos:{set:function(a){this._state.pos.set(a||[0,0,0]),this._renderer.imageDirty(),this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},dir:{set:function(a){this._state.dir.set(a||[0,0,-1]),this._renderer.imageDirty(),this.fire("dir",this._state.dir)},get:function(){return this._state.dir}}}})}(),function(){"use strict";xeogl.Clips=xeogl.Component.extend({type:"xeogl.Clips",_init:function(a){this._state=new xeogl.renderer.Clips({clips:[],hash:""}),this._dirty=!0,this._clips=[],this._dirtySubs=[],this._destroyedSubs=[],this.clips=a.clips},_props:{clips:{set:function(a){function b(){h.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=h._clips.length;b<c;b++)if(h._clips[b].id===a)return h._clips=h._clips.slice(b,b+1),h._dirtySubs=h._dirtySubs.slice(b,b+1),h._destroyedSubs=h._destroyedSubs.slice(b,b+1),h._dirty=!0,h.fire("dirty",!0),void h.fire("clips",h._clips)}a=a||[];var d,e,f,g;for(e=0,f=this._clips.length;e<f;e++)d=this._clips[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._clips=[],this._dirtySubs=[],this._destroyedSubs=[];var h=this;for(e=0,f=a.length;e<f;e++)d=a[e],!xeogl._isString(d)||(g=d,d=this.components[g])?"xeogl.Clip"===d.type?(this._clips.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c,d))):this.error("Component "+xeogl._inQuotes(g)+" is not a xeogl.Clip"):this.error("Component not found: "+xeogl._inQuotes(g));this._dirty=!0,this.fire("dirty",!0),this.fire("clips",this._clips)},get:function(){return this._clips.slice(0,this._clips.length)}}},_getState:function(){var a=this._state;if(this._dirty){a.clips=[];for(var b=0,c=this._clips.length;b<c;b++)a.clips.push(this._clips[b]._state);this._makeHash(),this._dirty=!1}return a},_makeHash:function(){var a=this._state.clips;if(0===a.length)return void(this._state.hash=";");for(var b=[],c=0,d=a.length;c<d;c++)a[c],b.push("cp");b.push(";"),this._state.hash=b.join("")},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.CameraControl=xeogl.Component.extend({type:"xeogl.CameraControl",_init:function(a){this._boundaryHelper=new xeogl.Entity(this,{geometry:new xeogl.AABBGeometry(this),material:new xeogl.PhongMaterial(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visible:!1,collidable:!1}),this._cameraFlight=new xeogl.CameraFlightAnimation(this,{duration:.5}),this.firstPerson=a.firstPerson,this.walking=a.walking,this.keyboardLayout=a.keyboardLayout,this.doublePickFlyTo=a.doublePickFlyTo,this.active=a.active,this.inertia=a.inertia,this._initEvents()},_props:{active:{set:function(a){this._active=!1!==a,this.fire("active",this._active)},get:function(){return this._active}},firstPerson:{set:function(a){a=!!a,this._firstPerson=a,this.fire("firstPerson",this._firstPerson)},get:function(){return this._firstPerson}},walking:{set:function(a){a=!!a,this._walking=a,this.fire("walking",this._walking)},get:function(){return this._walking}},doublePickFlyTo:{set:function(a){this._doublePickFlyTo=!1!==a,this.fire("doublePickFlyTo",this._doublePickFlyTo)},get:function(){return this._doublePickFlyTo}},inertia:{set:function(a){this._inertia=void 0===a?.5:a,this.fire("inertia",this._inertia)},get:function(){return this._inertia}},keyboardLayout:{set:function(a){this._keyboardLayout=a||"qwerty",this.fire("keyboardLayout",this._keyboardLayout)},get:function(){return this._keyboardLayout}}},_destroy:function(){this.active=!1},_initEvents:function(){var b=this,c=this.scene,d=c.input,e=c.camera,f=xeogl.math,g=this.scene.canvas.canvas,h=!1,i=.4,j=.4,k=.8,l=.4,m=.02,n=.02,o=.02,p=.3,q=.2,r=.05;g.oncontextmenu=function(a){a.preventDefault()};var s=function(){var b=new Float32Array(2);return function(c){if(c){for(var d=c.target,e=0,f=0;d.offsetParent;)e+=d.offsetLeft,f+=d.offsetTop,d=d.offsetParent;b[0]=c.pageX-e,b[1]=c.pageY-f}else c=window.event,b[0]=c.x,b[a]=c.y;return b}}();!function(){function a(){var a=c.aabb,b=a[3]-a[0],d=a[4]-a[1],e=a[5]-a[2],f=b>d?b:d;return(f=e>f?e:f)/30}var t=0,u=0,v=0,w=0,x=0,y=0,z=!1,A=!1,B=!1,C={},D=.001,E=function(){var a=new Float32Array(3);return function(){return f.lenVec3(f.subVec3(e.look,e.eye,a))}}();c.on("tick",function(){var a=b._inertia;if(Math.abs(t)<D&&(t=0),Math.abs(u)<D&&(u=0),0!==t&&(b._firstPerson?e.pitch(-t):e.orbitPitch(t)),0!==u&&(b._firstPerson?e.yaw(u):e.orbitYaw(u)),t*=a,u*=a,Math.abs(v)<D&&(v=0),Math.abs(w)<D&&(w=0),Math.abs(x)<D&&(x=0),0!==v||0!==w||0!==x){var c=E()/80;if(b._walking){var d=e.eye[1];e.pan([v*c,w*c,x*c]);var f=e.eye;f[1]=d,e.eye=f}else e.pan([v*c,w*c,x*c])}if(v*=a,w*=a,x*=a,Math.abs(y)<D&&(y=0),0!==y){if(b._firstPerson){var d;if(b._walking&&(d=e.eye[1]),e.pan([0,0,y]),b._walking){var f=e.eye;f[1]=d,e.eye=f}}else e.zoom(y),e.ortho.scale=e.ortho.scale+y;y*=a}}),document.addEventListener("keyDown",function(a){b._active&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(z=a.ctrlKey||17===a.keyCode||a.metaKey,A=a.altKey||18===a.keyCode,B=16===a.keyCode,C[a.keyCode]=!0)},!0),document.addEventListener("keyup",function(a){b._active&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&((a.ctrlKey||17===a.keyCode)&&(z=!1),(a.altKey||18===a.keyCode)&&(A=!1),16===a.keyCode&&(B=!1),C[a.keyCode]=!1)}),function(){var e,f,m,p,q,r=0,z=0,A=!1;g.addEventListener("mousedown",function(a){if(b._active&&h)switch(a.which){case 1:m=!0,A=!0,r=0,z=0;var c=s(a);e=c[0],f=c[1];break;case 2:p=!0;break;case 3:q=!0,A=!0,r=0,z=0;var c=s(a);e=c[0],f=c[1]}}),g.addEventListener("mouseup",function(a){if(b._active){switch(a.which){case 1:m=!1;break;case 2:p=!1;break;case 3:q=!1}A=!1,r=0,z=0}}),g.addEventListener("mouseenter",function(){b._active&&(h=!0,r=0,z=0)}),g.addEventListener("mouseleave",function(){b._active&&(h=!1,r=0,z=0)}),g.addEventListener("mousemove",function(a){if(b._active&&h&&A){var c=s(a),d=c[0],g=c[1];r+=(d-e)*i,z+=(g-f)*i,e=d,f=g}}),c.on("tick",function(){if(b._active&&(0!==Math.abs(r)||0!==Math.abs(z))){B||q?(v=r*j,w=z*j):(u=-r*i,t=z*i),r=0,z=0}}),g.addEventListener("wheel",function(c){if(b._active){var d=Math.max(-1,Math.min(1,40*-c.deltaY));if(0!==d){var e=d/Math.abs(d);b._firstPerson?x+=-e*l:y=-e*a()*k,c.preventDefault()}}}),c.on("tick",function(c){if(b._active&&h){var e=c.deltaTime;if(!b.ctrlDown&&!b.altDown){var f=d.keyDown[d.KEY_ADD],g=d.keyDown[d.KEY_SUBTRACT];(f||g)&&(g?y=e*a()*o:f&&(y=-e*a()*o))}}}),function(){c.on("tick",function(a){if(b._active&&h){var c,e,f,g,i,j,k=a.deltaTime;"azerty"==b._keyboardLayout?(c=d.keyDown[d.KEY_Z],e=d.keyDown[d.KEY_S],f=d.keyDown[d.KEY_Q],g=d.keyDown[d.KEY_D],i=d.keyDown[d.KEY_W],j=d.keyDown[d.KEY_X]):(c=d.keyDown[d.KEY_W],e=d.keyDown[d.KEY_S],f=d.keyDown[d.KEY_A],g=d.keyDown[d.KEY_D],i=d.keyDown[d.KEY_Z],j=d.keyDown[d.KEY_X]),(c||e||f||g||i||j)&&(j?w+=k*n:i&&(w-=-k*n),g?v+=-k*n:f&&(v=k*n),e?x=k*n:c&&(x=-k*n))}})}()}(),function(){function c(a){var b=Date.now();return o===n?(o=a,!0):o===a?b-s>m:(o=a,s=b,!1)}var d,e=new Float32Array(2),h=-1,i=[],j=0,k=new Float32Array(2),l=new Float32Array(2),m=50,n=0,o=n,s=Date.now();g.addEventListener("touchstart",function(a){if(b._active){var c=a.touches,f=a.changedTouches;for(d=Date.now(),1===c.length&&1===f.length?(h=d,e[0]=c[0].pageX,e[1]=c[0].pageY):h=-1;i.length<c.length;)i.push(new Float32Array(2));for(var g=0,k=c.length;g<k;++g)i[g][0]=c[g].pageX,i[g][1]=c[g].pageY;o=n,j=c.length,a.stopPropagation()}},{passive:!0}),g.addEventListener("touchmove",function(d){if(b._active){var e=d.touches;if(1===j){var g=e[0];if(c(1)){var h=g.pageX-i[0][0],m=g.pageY-i[0][1],n=h*p;t=m*p,u=-n}}else if(2===j){var g=e[0],o=e[1];f.subVec2([g.pageX,g.pageY],i[0],k),f.subVec2([o.pageX,o.pageY],i[1],l);var s=f.dotVec2(k,l)>0;if(s&&c(2)&&(f.subVec2([g.pageX,g.pageY],i[0],k),v=k[0]*q,w=k[1]*q),!s&&c(4)){var x=f.distVec2([g.pageX,g.pageY],[o.pageX,o.pageY]),z=f.distVec2(i[0],i[1]);y=(z-x)*a()*r}}for(var A=0;A<j;++A)i[A][0]=e[A].pageX,i[A][1]=e[A].pageY;d.stopPropagation()}},{passive:!0})}(),function(){c.on("tick",function(a){if(b._active&&h){var c=a.deltaTime,e=d.keyDown[d.KEY_LEFT_ARROW],f=d.keyDown[d.KEY_RIGHT_ARROW],g=d.keyDown[d.KEY_UP_ARROW],i=d.keyDown[d.KEY_DOWN_ARROW];(e||f||g||i)&&(f?u+=-c*m:e&&(u+=c*m),i?t+=c*m:g&&(t+=-c*m))}})}(),function(){c.on("tick",function(a){if(b._active&&h){var c,e,f=a.deltaTime;"azerty"==b._keyboardLayout?(c=d.keyDown[d.KEY_A],e=d.keyDown[d.KEY_E]):(c=d.keyDown[d.KEY_Q],e=d.keyDown[d.KEY_E]),(e||c)&&(c?u+=f*m:e&&(u+=-f*m))}})}()}(),function(){function a(){if(i||j){if(k=!1,l=!1,f=j||b.hasSubs("hoverSurface")?c.pick({pickSurface:!0,canvasPos:h}):c.pick({canvasPos:h})){k=!0;var a=f.entity.id;e!==a&&(void 0!==e&&b.fire("hoverOut",{entity:c.entities[e]}),b.fire("hoverEnter",f),e=a),b.fire("hover",f),f.worldPos&&(l=!0,b.fire("hoverSurface",f))}else void 0!==e&&(b.fire("hoverOut",{entity:c.entities[e]}),e=void 0),b.fire("hoverOff",{canvasPos:h});i=!1,j=!1}}function d(a,b){if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b[0]=a.x,b[1]=a.y}var e,f,h=[0,0],i=!1,j=!1,k=!1,l=!1;c.on("tick",a),function(){g.addEventListener("mousemove",function(a){b._active&&(d(a,h),(b.hasSubs("hover")||b.hasSubs("hoverOut")||b.hasSubs("hoverOff")||b.hasSubs("hoverSurface"))&&(i=!0))});var c,e,k,m;g.addEventListener("mousedown",function(a){b._active&&(c=a.clientX,e=a.clientY,k=h[0],m=h[1])}),g.addEventListener("mouseup",function(d){var g,n=0;return function(d){if(b._active&&!(Math.abs(d.clientX-c)>3||Math.abs(d.clientY-e)>3)){if(!(b._doublePickFlyTo||b.hasSubs("doublePicked")||b.hasSubs("doublePickedSurface")||b.hasSubs("doublePickedNothing")))return j=!!b.hasSubs("pickedSurface"),a(),void(f?(b.fire("picked",f),l&&b.fire("pickedSurface",f)):b.fire("pickedNothing"));n++,1==n?g=setTimeout(function(){i=b._doublePickFlyTo,j=i||!!b.hasSubs("pickedSurface"),h[0]=k,h[1]=m,a(),f?(b.fire("picked",f),l&&b.fire("pickedSurface",f)):b.fire("pickedNothing"),n=0},250):(clearTimeout(g),i=b._doublePickFlyTo,j=i&&!!b.hasSubs("doublePickedSurface"),a(),f?(b.fire("doublePicked",f),l&&b.fire("doublePickedSurface",f),b._doublePickFlyTo&&b._flyTo(f)):(b.fire("doublePickedNothing"),b._doublePickFlyTo&&b._flyTo()),n=0)}}}(),!1)}(),function(){var c,d=150,e=325,k=4,m=[],n=new Float32Array(2),o=-1,p=-1;g.addEventListener("touchstart",function(a){if(b._active){var d=a.touches,e=a.changedTouches;for(c=Date.now(),1===d.length&&1===e.length?(o=c,n[0]=d[0].pageX,n[1]=d[0].pageY):o=-1;m.length<d.length;)m.push(new Float32Array(2));for(var f=0,g=d.length;f<g;++f)m[f][0]=d[f].pageX,m[f][1]=d[f].pageY;m.length=d.length,a.stopPropagation()}},{passive:!0}),g.addEventListener("touchend",function(c){if(b._active){var g=Date.now(),q=c.touches,r=c.changedTouches;0===q.length&&1===r.length&&o>-1&&g-o<d&&(p>-1&&o-p<e?(h[0]=Math.round(r[0].clientX),h[1]=Math.round(r[0].clientY),i=!0,j=!!b.hasSubs("pickedSurface"),a(),f?(b.fire("doublePicked",f),l&&b.fire("doublePickedSurface",f),b._doublePickFlyTo&&b._flyTo(f)):(b.fire("doublePickedNothing"),b._doublePickFlyTo&&b._flyTo()),p=-1):xeogl.math.distVec2(m[0],n)<k&&(h[0]=Math.round(r[0].clientX),h[1]=Math.round(r[0].clientY),i=!0,j=!!b.hasSubs("pickedSurface"),a(),f?(b.fire("picked",f),l&&b.fire("pickedSurface",f)):b.fire("pickedNothing"),p=g),o=-1),m.length=q.length;for(var s=0,t=q.length;s<t;++s)m[s][0]=q[s].pageX,m[s][1]=q[s].pageY;c.stopPropagation()}},{passive:!0})}()}(),function(){var a=49,d=50,g=51,i=52,j=53,k=54,l=new f.vec3,m=new f.vec3,n=new f.vec3,o=new f.vec3,p={eye:new Float32Array(3),look:new Float32Array(3),up:new Float32Array(3)};document.addEventListener("keydown",function(q){if(b._active&&h){var r=q.keyCode;if(r===a||r===d||r===g||r===i||r===j||r===k){var s=c.aabb,t=f.getAABB3Diag(s);l[0]=s[0]+s[3]/2,l[1]=s[1]+s[4]/2,l[2]=s[2]+s[5]/2;var u=Math.abs(t/Math.tan(b._cameraFlight.fitFOV/2));switch(r){case a:p.eye.set(f.mulVec3Scalar(e.worldRight,u,m)),p.look.set(l),p.up.set(e.worldUp);break;case d:p.eye.set(f.mulVec3Scalar(e.worldForward,u,m)),p.look.set(l),p.up.set(e.worldUp);break;case g:p.eye.set(f.mulVec3Scalar(e.worldRight,-u,m)),p.look.set(l),p.up.set(e.worldUp);break;case i:p.eye.set(f.mulVec3Scalar(e.worldForward,-u,m)),p.look.set(l),p.up.set(e.worldUp);break;case j:p.eye.set(f.mulVec3Scalar(e.worldUp,u,m)),p.look.set(l),p.up.set(f.normalizeVec3(f.mulVec3Scalar(e.worldForward,1,n),o));break;case k:p.eye.set(f.mulVec3Scalar(e.worldUp,-u,m)),p.look.set(l),p.up.set(f.normalizeVec3(f.mulVec3Scalar(e.worldForward,-1,n)));break;default:return}b._cameraFlight.duration>0?b._cameraFlight.flyTo(p):b._cameraFlight.jumpTo(p)}}})}()},_flyTo:function(a){var b;a&&a.worldPos&&(b=a.worldPos);var c=a?a.entity.aabb:this.scene.aabb;if(this._boundaryHelper.geometry.targetAABB=c,b){var d=this.scene.camera;xeogl.math.subVec3(d.eye,d.look,[]);this._cameraFlight.flyTo({aabb:c},this._hideBoundary,this)}else this._cameraFlight.flyTo({aabb:c},this._hideBoundary,this)},_hideBoundary:function(){}})}(),function(){"use strict";function a(a,b){var c=!!b.positions,d=!!b.quantized,e=!!b.normals,f=!!b.colors,g=!!b.uv,h=[c?"p":"",d?"c":"",e?"n":"",f?"c":"",g?"u":""].join(";");a._sceneVertexBufs||(a._sceneVertexBufs={});var i=a._sceneVertexBufs[h];return i||(i=new k(a,c,e,f,g,d),a._sceneVertexBufs[h]=i),i}function b(a,b){var c,d,e=new Float32Array(b),f=new Float32Array(b);for(c=0;c<b;c++)e[c]=Number.MAX_VALUE,f[c]=-Number.MAX_VALUE;for(c=0;c<a.length;c+=b)for(d=0;d<b;d++)e[d]=Math.min(e[d],a[c+d]),f[d]=Math.max(f[d],a[c+d]);return{min:e,max:f}}function c(a){var b,c,g,h,i,j,k,l=new Int8Array(2*a.length/3);for(j=0,k=0;j<a.length;j+=3,k+=2)g=b=d(a,j,"floor","floor"),c=e(b),h=i=f(a,j,c),b=d(a,j,"ceil","floor"),c=e(b),h=f(a,j,c),h>i&&(g=b,i=h),b=d(a,j,"floor","ceil"),c=e(b),h=f(a,j,c),h>i&&(g=b,i=h),b=d(a,j,"ceil","ceil"),c=e(b),h=f(a,j,c),h>i&&(g=b,i=h),l[k]=g[0],l[k+1]=g[1];return l}function d(a,b,c,d){var e=a[b]/(Math.abs(a[b])+Math.abs(a[b+1])+Math.abs(a[b+2])),f=a[b+1]/(Math.abs(a[b])+Math.abs(a[b+1])+Math.abs(a[b+2]));if(a[b+2]<0){var g=e,h=f;g=(1-Math.abs(f))*(e>=0?1:-1),h=(1-Math.abs(e))*(f>=0?1:-1),e=g,f=h}return new Int8Array([Math[c](127.5*e+(e<0?-1:0)),Math[d](127.5*f+(f<0?-1:0))])}function e(a){var b=a[0],c=a[1];b/=b<0?127:128,c/=c<0?127:128;var d=1-Math.abs(b)-Math.abs(c);d<0&&(b=(1-Math.abs(c))*(b>=0?1:-1),c=(1-Math.abs(b))*(c>=0?1:-1));var e=Math.sqrt(b*b+c*c+d*d);return[b/e,c/e,d/e]}function f(a,b,c){return a[b]*c[0]+a[b+1]*c[1]+a[b+2]*c[2]}var g=xeogl.stats.memory,h=xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint,i=h?Uint32Array:Uint16Array,j=new xeogl.renderer.VertexBufs({}),k=function(a,b,c,d,e,f){function i(){q={};var a,g,i=0;x=null;for(a in n)if(n.hasOwnProperty(a)){g=n[a];var j=!x||t.length+g.positions.length>l;if(j&&(x&&k(x),x=new xeogl.renderer.VertexBufs({positionsBuf:null,normalsBuf:null,uvBuf:null,colorsBuf:null,quantized:f}),i=0),q[a]=x,b)for(var p=0,y=g.positions.length;p<y;p++)t.push(g.positions[p]);if(c)for(var p=0,y=g.normals.length;p<y;p++)u.push(g.normals[p]);if(d)for(var p=0,y=g.colors.length;p<y;p++)v.push(g.colors[p]);if(e)for(var p=0,y=g.uv.length;p<y;p++)w.push(g.uv[p]);o[a]=i;var z;if(i){z=new(h?Uint32Array:Uint16Array)(g.indices);for(var p=0,y=z.length;p<y;p++)z[p]+=i,z[p]>l/3&&console.error("out of range: "+z[p])}else z=g.indices;g.indicesBufCombined?g.indicesBufCombined.setData(z):g.indicesBufCombined=new xeogl.renderer.ArrayBuffer(m,m.ELEMENT_ARRAY_BUFFER,z,z.length,1,m.STATIC_DRAW),i+=g.positions.length/3}x&&k(x),r=!1,s=!1}function k(h){var i,j=a.canvas.gl;b&&(i=f?new Uint16Array(t):new Float32Array(t),h.positionsBuf=new xeogl.renderer.ArrayBuffer(j,j.ARRAY_BUFFER,i,i.length,3,j.STATIC_DRAW),g.positions+=h.positionsBuf.numItems,t=[]),c&&(i=f?new Int8Array(u):new Float32Array(u),h.normalsBuf=new xeogl.renderer.ArrayBuffer(j,j.ARRAY_BUFFER,i,i.length,3,j.STATIC_DRAW),g.normals+=h.normalsBuf.numItems,u=[]),d&&(i=new Float32Array(v),h.colorsBuf=new xeogl.renderer.ArrayBuffer(j,j.ARRAY_BUFFER,i,i.length,4,j.STATIC_DRAW),g.colors+=h.colorsBuf.numItems,v=[]),e&&(i=f?new Uint16Array(w):new Float32Array(w),h.uvBuf=new xeogl.renderer.ArrayBuffer(j,j.ARRAY_BUFFER,i,i.length,2,j.STATIC_DRAW),g.uvs+=h.uvBuf.numItems,w=[])}const l=h?Number.MAX_SAFE_INTEGER/6:256e3;var m=a.canvas.gl,n={},o={},p=[],q={},r=!1,s=!1,t=[],u=[],v=[],w=[],x=null;a.canvas.on("webglContextRestored",i),this.addGeometry=function(b){if(!b.positions||!b.indices)return void a.warn("Ignoring geometry with no positions or indices: "+b.id);n[b.id]=b,o[b.id]=0,p.push(b),s=!0},this.getIndicesOffset=function(a){return(r||s)&&i(),o[a.id]},this.getVertexBufs=function(a){return n[a.id]?((r||s)&&i(),q[a.id]):j},this.setPositions=function(a){var b=q[a.id];if(b&&a.positions){var c=b.positionsBuf;c&&c.setData(a.positions,3*o[a.id])}},this.setNormals=function(a){var b=q[a.id];if(b&&a.normals){var c=b.normalsBuf;c&&c.setData(a.normals,3*o[a.id])}},this.setUVs=function(a){var b=q[a.id];if(b&&a.uv){var c=b.uvBuf;c&&c.setData(a.uv,2*o[a.id])}},this.setColors=function(a){var b=q[a.id];if(b&&a.color){var c=b.colorsBuf;c&&c.setData(a.colors,4*o[a.id])}},this.removeGeometry=function(a){var b=a.id;n[b]&&(delete n[b],delete o[b],r=!0)}};xeogl.Geometry=xeogl.Component.extend({type:"xeogl.Geometry",_init:function(d){var e=this;this._state=new xeogl.renderer.Geometry({combined:!!d.combined,quantized:!!d.quantized,autoVertexNormals:!!d.autoVertexNormals,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,indicesBufCombined:null,hash:"",getGhostEdgesIndices:function(){return e._edgesIndicesBuf||e._buildGhostEdgesIndices(),e._edgesIndicesBuf},getPickTrianglePositions:function(){return e._pickTrianglePositionsBuf||e._buildPickTriangleVBOs(),e._pickTrianglePositionsBuf},getPickTriangleColors:function(){return e._pickTriangleColorsBuf||e._buildPickTriangleVBOs(),e._pickTriangleColorsBuf},getPickVertexPositions:function(){return e._pickVertexPositionsBuf||e._buildPickTriangleVBOs(),e._pickVertexPositionsBuf},getPickVertexColors:function(){return e._pickVertexColorsBuf||e._buildPickTriangleVBOs(),e._pickVertexColorsBuf}}),this._ghostEdgeThreshold=d.ghostEdgeThreshold||2,this._edgesIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._localBoundary=null,this._boundaryDirty=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;var f=this._state,j=this.scene.canvas.gl;switch(d.primitive=d.primitive||"triangles",d.primitive){case"points":f.primitive=j.POINTS,f.primitiveName=d.primitive;break;case"lines":f.primitive=j.LINES,f.primitiveName=d.primitive;break;case"line-loop":f.primitive=j.LINE_LOOP,f.primitiveName=d.primitive;break;case"line-strip":f.primitive=j.LINE_STRIP,f.primitiveName=d.primitive;break;case"triangles":f.primitive=j.TRIANGLES,f.primitiveName=d.primitive;break;case"triangle-strip":f.primitive=j.TRIANGLE_STRIP,f.primitiveName=d.primitive;break;case"triangle-fan":f.primitive=j.TRIANGLE_FAN,f.primitiveName=d.primitive;break;default:this.error("Unsupported value for 'primitive': '"+d.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),f.primitive=j.TRIANGLES,f.primitiveName=d.primitive}if(d.positions)if(this._state.quantized){var k=b(d.positions,3),n=l(d.positions,k.min,k.max);f.positions=n.quantized,f.positionsDecodeMatrix=n.decode}else f.positions=d.positions.constructor===Float32Array?d.positions:new Float32Array(d.positions);if(d.colors&&(f.colors=d.colors.constructor===Float32Array?d.colors:new Float32Array(d.colors)),d.uv)if(this._state.quantized){var k=b(d.uv,2),n=m(d.uv,k.min,k.max);f.uv=n.quantized,f.uvDecodeMatrix=n.decode}else f.uv=d.uv.constructor===Float32Array?d.uv:new Float32Array(d.uv);if(d.normals&&(this._state.quantized?f.normals=c(d.normals):f.normals=d.normals.constructor===Float32Array?d.normals:new Float32Array(d.normals)),d.indices){if(!h&&d.indices.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");f.indices=d.indices.constructor===Uint32Array||d.indices.constructor===Uint16Array?d.indices:new i(d.indices)}f.indices&&(f.indicesBuf=new xeogl.renderer.ArrayBuffer(j,j.ELEMENT_ARRAY_BUFFER,f.indices,f.indices.length,1,j.STATIC_DRAW),g.indices+=f.indicesBuf.numItems),this._buildVBOs(),this._buildHash(),this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._buildVBOs,this),g.meshes++,this._state.combined&&(this._sceneVertexBufs=a(this.scene,this._state),this._sceneVertexBufs.addGeometry(this._state)),e.fire("created",this.created=!0)},_buildVBOs:function(){var a=this._state,b=this.scene.canvas.gl;a.indices&&(a.indicesBuf=new xeogl.renderer.ArrayBuffer(b,b.ELEMENT_ARRAY_BUFFER,a.indices,a.indices.length,1,b.STATIC_DRAW),g.indices+=a.indicesBuf.numItems),a.combined?a.indices:(a.positions&&(a.positionsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,a.positions,a.positions.length,3,b.STATIC_DRAW),g.positions+=a.positionsBuf.numItems),a.normals&&(a.normalsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,a.normals,a.normals.length,3,b.STATIC_DRAW),g.normals+=a.normalsBuf.numItems),a.colors&&(a.colorsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,a.colors,a.colors.length,4,b.STATIC_DRAW),g.colors+=a.colorsBuf.numItems),a.uv&&(a.uvBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,a.uv,a.uv.length,2,b.STATIC_DRAW),g.uvs+=a.uvBuf.numItems))},_buildHash:function(){var a=this._state,b=["/g"];b.push("/"+a.primitive+";"),a.positions&&b.push("p"),a.colors&&b.push("c"),(a.normals||a.autoVertexNormals)&&b.push("n"),a.uv&&b.push("u"),a.quantized&&b.push("cp"),b.push(";"),a.hash=b.join("")},_buildGhostEdgesIndices:function(){var a=this._state;if(a.positions&&a.indices){var b=this.scene.canvas.gl,c=a.combined?this._sceneVertexBufs.getIndicesOffset(a):0,d=n(a.positions,a.indices,a.positionsDecodeMatrix,c,this._ghostEdgeThreshold);this._edgesIndicesBuf=new xeogl.renderer.ArrayBuffer(b,b.ELEMENT_ARRAY_BUFFER,d,d.length,1,b.STATIC_DRAW),g.indices+=this._edgesIndicesBuf.numItems}},
_buildPickTriangleVBOs:function(){var a=this._state;if(a.positions&&a.indices){var b=this.scene.canvas.gl,c=xeogl.math.buildPickTriangles(a.positions,a.indices,a.quantized),d=c.positions,e=c.colors;this._pickTrianglePositionsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,d,d.length,3,b.STATIC_DRAW),this._pickTriangleColorsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,e,e.length,4,b.STATIC_DRAW,!0),g.positions+=this._pickTrianglePositionsBuf.numItems,g.colors+=this._pickTriangleColorsBuf.numItems}},_buildPickVertexVBOs:function(){},_props:{primitive:{get:function(){return this._state.primitiveName}},quantized:{get:function(){return this._state.quantized}},combined:{get:function(){return this._state.combined}},positions:{get:function(){if(this._state.positions)return this._state.quantized?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),xeogl.math.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions},set:function(a){if(this._state.quantized)return void this.error("can't update geometry positions - quantized geometry is immutable");var b=this._state,c=b.positions;return c?c.length!==a.length?void this.error("can't update geometry positions - new positions are wrong length"):(c.set(a),b.positionsBuf&&b.positionsBuf.setData(c),this._state.combined&&this._sceneVertexBufs.setPositions(b),this._setBoundaryDirty(),void this._renderer.imageDirty()):void this.error("can't update geometry positions - geometry has no positions")}},normals:{get:function(){if(this._state.normals){if(!this._state.quantized)return this._state.normals;if(!this._decompressedNormals){var a=this._state.normals.length,b=a+a/2;this._decompressedNormals=new Float32Array(b),xeogl.math.octDecodeVec2s(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}},set:function(a){if(this._state.quantized)return void this.error("can't update geometry normals - quantized geometry is immutable");var b=this._state,c=b.normals;return c?c.length!==a.length?void this.error("can't update geometry normals - new normals are wrong length"):(c.set(a),b.normalsBuf&&b.normalsBuf.setData(c),this._state.combined&&this._sceneVertexBufs.setNormals(b),void this._renderer.imageDirty()):void this.error("can't update geometry normals - geometry has no normals")}},uv:{get:function(){if(this._state.uv)return this._state.quantized?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),xeogl.math.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv},set:function(a){if(this._state.quantized)return void this.error("can't update geometry UVs - quantized geometry is immutable");var b=this._state,c=b.uv;return c?c.length!==a.length?void this.error("can't update geometry UVs - new UVs are wrong length"):(c.set(a),b.uvBuf&&b.uvBuf.setData(c),this._state.combined&&this._sceneVertexBufs.setUVs(b),void this._renderer.imageDirty()):void this.error("can't update geometry UVs - geometry has no UVs")}},colors:{get:function(){return this._state.colors},set:function(a){if(this._state.quantized)return void this.error("can't update geometry colors - quantized geometry is immutable");var b=this._state,c=b.colors;return c?c.length!==a.length?void this.error("can't update geometry colors - new colors are wrong length"):(c.set(a),b.colorsBuf&&b.colorsBuf.setData(c),this._state.combined&&this._sceneVertexBufs.setColors(b),void this._renderer.imageDirty()):void this.error("can't update geometry colors - geometry has no colors")}},indices:{get:function(){return this._state.indices}},aabb:{get:function(){return this._aabbDirty&&(this._aabb||(this._aabb=xeogl.math.AABB3()),xeogl.math.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}},obb:{get:function(){var a=xeogl.math.AABB3();return function(){return this._obbDirty&&(this._obb||(this._obb=xeogl.math.OBB3()),xeogl.math.positions3ToAABB3(this._state.positions,a,this._state.positionsDecodeMatrix),xeogl.math.AABB3ToOBB3(a,this._obb),this._obbDirty=!1),this._obb}}()},kdtree:{get:function(){var a=this._state;return a.indices&&a.positions?(this._kdtree||(this._kdtree=xeogl.math.buildKDTree(a.indices,a.positions,this._state.positionsDecodeMatrix)),this._kdtree):void this.error("Can't provide a KD-tree: no indices/positions")}}},_setBoundaryDirty:function(){this._boundaryDirty||(this._boundaryDirty=!0,this._aabbDirty=!0,this._obbDirty=!0,this._localBoundary&&this._localBoundary.fire("updated",!0),this.fire("boundary"))},_getState:function(){return this._state},_getVertexBufs:function(){return this._state&&this._state.combined?this._sceneVertexBufs.getVertexBufs(this._state):j},_destroy:function(){this.scene.canvas.off(this._webglContextRestored);var a=this._state;a.indicesBuf&&a.indicesBuf.destroy(),this._edgesIndicesBuf&&this._edgesIndicesBuf.destroy(),a.indicesBufCombined&&a.indicesBufCombined.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),this._localBoundary&&this._localBoundary.destroy(),this._state.combined&&this._sceneVertexBufs.removeGeometry(a),a.destroy(),g.meshes--}});var l=function(){var a=xeogl.math,b=a.mat4(),c=a.mat4();return function(d,e,f){var g,h=new Uint16Array(d.length),i=new Float32Array([65535/(f[0]-e[0]),65535/(f[1]-e[1]),65535/(f[2]-e[2])]);for(g=0;g<d.length;g+=3)h[g+0]=Math.floor((d[g+0]-e[0])*i[0]),h[g+1]=Math.floor((d[g+1]-e[1])*i[1]),h[g+2]=Math.floor((d[g+2]-e[2])*i[2]);return a.identityMat4(b),a.translationMat4v(e,b),a.identityMat4(c),a.scalingMat4v([(f[0]-e[0])/65535,(f[1]-e[1])/65535,(f[2]-e[2])/65535],c),{quantized:h,decode:a.mulMat4(b,c,a.identityMat4())}}}(),m=function(){var a=xeogl.math,b=a.mat3(),c=a.mat3();return function(d,e,f){var g,h=new Uint16Array(d.length),i=new Float32Array([65535/(f[0]-e[0]),65535/(f[1]-e[1])]);for(g=0;g<d.length;g+=2)h[g+0]=Math.floor((d[g+0]-e[0])*i[0]),h[g+1]=Math.floor((d[g+1]-e[1])*i[1]);return a.identityMat3(b),a.translationMat3v(e,b),a.identityMat3(c),a.scalingMat3v([(f[0]-e[0])/65535,(f[1]-e[1])/65535],c),{quantized:h,decode:a.mulMat3(b,c,a.identityMat3())}}}(),n=function(){function a(a,o,p){d=0;for(var q=0,r=o.length;q<r;q+=3){var s=3*o[q+0],t=3*o[q+1],u=3*o[q+2];p?(e[0]=a[s],e[1]=a[s+1],e[2]=a[s+2],f[0]=a[t],f[1]=a[t+1],f[2]=a[t+2],g[0]=a[u],g[1]=a[u+1],g[2]=a[u+2],b.decompressPosition(e,p,h),b.decompressPosition(f,p,i),b.decompressPosition(g,p,j)):(h[0]=a[s],h[1]=a[s+1],h[2]=a[s+2],i[0]=a[t],i[1]=a[t+1],i[2]=a[t+2],j[0]=a[u],j[1]=a[u+1],j[2]=a[u+2]),b.subVec3(j,i,k),b.subVec3(h,i,l),b.cross3Vec3(k,l,m),b.normalizeVec3(m,n);var v=c[d]||(c[d]={normal:b.vec3()});v.normal[0]=n[0],v.normal[1]=n[1],v.normal[2]=n[2],d++}}var b=xeogl.math,c=[],d=0,e=new Uint16Array(3),f=new Uint16Array(3),g=new Uint16Array(3),h=b.vec3(),i=b.vec3(),j=b.vec3(),k=b.vec3(),l=b.vec3(),m=b.vec3(),n=b.vec3();return function(b,d,e,f,g){var h=xeogl.math;a(b,d,e);for(var i,j,k,l,m,n=[],o=Math.cos(xeogl.math.DEGTORAD*g),p={},q=(h.vec3(),h.vec3(),0),r=d.length;q<r;q+=3)for(var s=q/3,t=0;t<3;t++)i=d[q+t],j=d[q+(t+1)%3],k=Math.min(i,j),l=Math.max(i,j),m=k+","+l,void 0===p[m]?p[m]={index1:k,index2:l,face1:s,face2:void 0}:p[m].face2=s;var u=!1;for(m in p){var v=p[m];if(void 0!==v.face2){var w=c[v.face1].normal,x=c[v.face2].normal;if(h.dotVec3(w,x)>o)continue}var y=v.index1+f,z=v.index2+f;(!u&&y>65535||z>65535)&&(u=!0),n.push(y),n.push(z)}return u?new Uint32Array(n):new Uint16Array(n)}}()}(),function(){"use strict";xeogl.BoxGeometry=xeogl.Geometry.extend({type:"xeogl.BoxGeometry",_init:function(a){var b=a.xSize||1;b<0&&(this.error("negative xSize not allowed - will invert"),b*=-1);var c=a.ySize||1;c<0&&(this.error("negative ySize not allowed - will invert"),c*=-1);var d=a.zSize||1;d<0&&(this.error("negative zSize not allowed - will invert"),d*=-1);var e=a.center,f=e?e[0]:0,g=e?e[1]:0,h=e?e[2]:0,i=-b+f,j=-c+g,k=-d+h,l=b+f,m=c+g,n=d+h;this._super(xeogl._apply(a,{positions:[l,m,n,i,m,n,i,j,n,l,j,n,l,m,n,l,j,n,l,j,k,l,m,k,l,m,n,l,m,k,i,m,k,i,m,n,i,m,n,i,m,k,i,j,k,i,j,n,i,j,k,l,j,k,l,j,n,i,j,n,l,j,k,i,j,k,i,m,k,l,m,k],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],tangents:null})),this.box=!0}})}(),function(){"use strict";xeogl.TorusGeometry=xeogl.Geometry.extend({type:"xeogl.TorusGeometry",_init:function(a){var b=a.radius||1;b<0&&(this.error("negative radius not allowed - will invert"),b*=-1),b*=.5;var c=a.tube||.3;c<0&&(this.error("negative tube not allowed - will invert"),c*=-1);var d=a.radialSegments||32;d<0&&(this.error("negative radialSegments not allowed - will invert"),d*=-1),d<4&&(d=4);var e=a.tubeSegments||24;e<0&&(this.error("negative tubeSegments not allowed - will invert"),e*=-1),e<4&&(e=4);var f=a.arc||2*Math.PI;f<0&&(this.warn("negative arc not allowed - will invert"),f*=-1),f>360&&(f=360);var g,h,i,j,k,l,m,n,o=a.center,p=o?o[0]:0,q=o?o[1]:0,r=o?o[2]:0,s=[],t=[],u=[],v=[];for(n=0;n<=e;n++)for(m=0;m<=d;m++)g=m/d*f,h=n/e*Math.PI*2,p=b*Math.cos(g),q=b*Math.sin(g),i=(b+c*Math.cos(h))*Math.cos(g),j=(b+c*Math.cos(h))*Math.sin(g),k=c*Math.sin(h),s.push(i+p),s.push(j+q),s.push(k+r),u.push(1-m/d),u.push(n/e),l=xeogl.math.normalizeVec3(xeogl.math.subVec3([i,j,k],[p,q,r],[]),[]),t.push(l[0]),t.push(l[1]),t.push(l[2]);var w,x,y,z;for(n=1;n<=e;n++)for(m=1;m<=d;m++)w=(d+1)*n+m-1,x=(d+1)*(n-1)+m-1,y=(d+1)*(n-1)+m,z=(d+1)*n+m,v.push(w),v.push(x),v.push(y),v.push(y),v.push(z),v.push(w);this._super(xeogl._apply(a,{positions:s,normals:t,uv:u,indices:v}))}})}(),function(){"use strict";xeogl.SphereGeometry=xeogl.Geometry.extend({type:"xeogl.SphereGeometry",_init:function(a){var b=a.lod||1,c=a.center?a.center[0]:0,d=a.center?a.center[1]:0,e=a.center?a.center[2]:0,f=a.radius||1;f<0&&(this.warn("negative radius not allowed - will invert"),f*=-1);var g=a.heightSegments||18;g<0&&(this.warn("negative heightSegments not allowed - will invert"),g*=-1),(g=Math.floor(b*g))<18&&(g=18);var h=a.widthSegments||18;h<0&&(this.warn("negative widthSegments not allowed - will invert"),h*=-1),(h=Math.floor(b*h))<18&&(h=18);var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=[],y=[],z=[],A=[];for(i=0;i<=g;i++)for(k=i*Math.PI/g,l=Math.sin(k),m=Math.cos(k),j=0;j<=h;j++)n=2*j*Math.PI/h,o=Math.sin(n),p=Math.cos(n),q=p*l,r=m,s=o*l,t=1-j/h,u=i/g,y.push(q),y.push(r),y.push(s),z.push(t),z.push(u),x.push(c+f*q),x.push(d+f*r),x.push(e+f*s);for(i=0;i<g;i++)for(j=0;j<h;j++)v=i*(h+1)+j,w=v+h+1,A.push(v+1),A.push(w+1),A.push(w),A.push(v+1),A.push(w),A.push(v);this._super(xeogl._apply(a,{positions:x,normals:y,uv:z,indices:A}))}})}(),function(){"use strict";xeogl.OBBGeometry=xeogl.Geometry.extend({type:"xeogl.OBBGeometry",_init:function(a){this._super(xeogl._apply(a,{primitive:a.primitive||"lines",positions:a.positions||[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],indices:[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]})),a.target?this.target=a.target:a.targetOBB&&(this.targetOBB=a.targetOBB)},_props:{target:{set:function(a){var b=!1,c=this;this._attach({name:"target",type:"xeogl.Component",component:a,sceneDefault:!1,on:{boundary:function(){b||(b=!0,xeogl.scheduleTask(function(){c._setPositionsFromOBB(c._attached.target.obb),b=!1}))}},onAttached:function(){c._setPositionsFromOBB(c._attached.target.obb)}})},get:function(){return this._attached.target}},targetOBB:{set:function(a){a&&(this._attached.boundary&&(this.boundary=null),this._setPositionsFromOBB(a))}}},_setPositionsFromOBB:function(a){this.positions=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10],a[12],a[13],a[14],a[16],a[17],a[18],a[20],a[21],a[22],a[24],a[25],a[26],a[28],a[29],a[30]]}})}(),function(){"use strict";xeogl.AABBGeometry=xeogl.Geometry.extend({type:"xeogl.AABBGeometry",_init:function(a){this._super(xeogl._apply(a,{primitive:a.primitive||"lines",indices:[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],positions:a.positions||[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]})),a.target?this.target=a.target:a.targetAABB&&(this.targetAABB=a.targetAABB)},_props:{target:{set:function(a){var b=!1,c=this;this._attach({name:"target",type:"xeogl.Component",component:a,sceneDefault:!1,on:{boundary:function(){b||(b=!0,xeogl.scheduleTask(function(){c._setPositionsFromAABB(c._attached.target.aabb),b=!1}))}},onAttached:function(){c._setPositionsFromAABB(c._attached.target.aabb)}})},get:function(){return this._attached.target}},targetAABB:{set:function(a){a&&(this._attached.target&&(this.target=null),this._setPositionsFromAABB(a))}}},_setPositionsFromAABB:function(a){this.positions=[a[3],a[4],a[5],a[3],a[1],a[5],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[2],a[0],a[4],a[2]]}})}(),xeogl.PathGeometry=xeogl.Geometry.extend({type:"xeogl.PathGeometry",_init:function(a){this._super(a),this.path=a.path,this.divisions=a.divisions},_update:function(){var a=this._attached.path;if(a){var b,c,d,e=a.getPoints(this._divisions),f=[];for(b=0,c=e.length;b<c;b++)d=e[b],f.push(d[0]),f.push(d[1]),f.push(d[2]);var g=[];for(b=0,c=e.length-1;b<c;b++)g.push(b),g.push(b+1);this.primitive="lines",this.positions=f,this.indices=g,this.normals=null,this.uv=null}},_props:{path:{set:function(a){this._attach({name:"path",type:"xeogl.Curve",component:a,sceneDefault:!1,on:{curves:{callback:this._needUpdate,scope:this}}})},get:function(){return this._attached.path}},divisions:{set:function(a){a=a||6,this._divisions=a,this._needUpdate()},get:function(){return this._divisions}}}}),function(){"use strict";xeogl.CylinderGeometry=xeogl.Geometry.extend({type:"xeogl.CylinderGeometry",_init:function(a){var b=a.radiusTop||1;b<0&&(this.error("negative radiusTop not allowed - will invert"),b*=-1);var c=a.radiusBottom||1;c<0&&(this.error("negative radiusBottom not allowed - will invert"),c*=-1);var d=a.height||1;d<0&&(this.error("negative height not allowed - will invert"),d*=-1);var e=a.radialSegments||32;e<0&&(this.error("negative radialSegments not allowed - will invert"),e*=-1),e<3&&(e=3);var f=a.heightSegments||1;f<0&&(this.error("negative heightSegments not allowed - will invert"),f*=-1),f<1&&(f=1);var g,h,i,j,k,l,m,n,o,p,q,r=!!a.openEnded,s=a.center,t=s?s[0]:0,u=s?s[1]:0,v=s?s[2]:0,w=d/2,x=d/f,y=2*Math.PI/e,z=1/e,A=(b-c)/f,B=[],C=[],D=[],E=[],F=(90-180*Math.atan(d/(c-b))/Math.PI)/90;for(g=0;g<=f;g++)for(k=b-g*A,l=w-g*x,h=0;h<=e;h++)i=Math.sin(h*y),j=Math.cos(h*y),C.push(k*i),C.push(F),C.push(k*j),D.push(h*z),D.push(1*g/f),B.push(k*i+t),B.push(l+u),B.push(k*j+v);for(g=0;g<f;g++)for(h=0;h<=e;h++)m=g*(e+1)+h,n=m+e,E.push(m),E.push(n),E.push(n+1),E.push(m),E.push(n+1),E.push(m+1);if(!r&&b>0){for(o=B.length/3,C.push(0),C.push(1),C.push(0),D.push(.5),D.push(.5),B.push(0+t),B.push(w+u),B.push(0+v),h=0;h<=e;h++)i=Math.sin(h*y),j=Math.cos(h*y),p=.5*Math.sin(h*y)+.5,q=.5*Math.cos(h*y)+.5,C.push(b*i),C.push(1),C.push(b*j),D.push(p),D.push(q),B.push(b*i+t),B.push(w+u),B.push(b*j+v);for(h=0;h<e;h++)s=o,m=o+1+h,E.push(m),E.push(m+1),E.push(s)}if(!r&&c>0){for(o=B.length/3,C.push(0),C.push(-1),C.push(0),D.push(.5),D.push(.5),B.push(0+t),B.push(0-w+u),B.push(0+v),h=0;h<=e;h++)i=Math.sin(h*y),j=Math.cos(h*y),p=.5*Math.sin(h*y)+.5,q=.5*Math.cos(h*y)+.5,C.push(c*i),C.push(-1),C.push(c*j),D.push(p),D.push(q),B.push(c*i+t),B.push(0-w+u),B.push(c*j+v);for(h=0;h<e;h++)s=o,m=o+1+h,E.push(s),E.push(m+1),E.push(m)}this._super(xeogl._apply(a,{positions:B,normals:C,uv:D,indices:E}))}})}(),function(){"use strict";xeogl.PlaneGeometry=xeogl.Geometry.extend({type:"xeogl.PlaneGeometry",_init:function(a){var b=a.xSize||1;b<0&&(this.error("negative xSize not allowed - will invert"),b*=-1);var c=a.zSize||1;c<0&&(this.error("negative zSize not allowed - will invert"),c*=-1);var d=a.xSegments||1;d<0&&(this.error("negative xSegments not allowed - will invert"),d*=-1),d<1&&(d=1);var e=a.xSegments||1;e<0&&(this.error("negative zSegments not allowed - will invert"),e*=-1),e<1&&(e=1);var f,g,h,i,j,k,l,m=a.center,n=m?m[0]:0,o=m?m[1]:0,p=m?m[2]:0,q=b/2,r=c/2,s=Math.floor(d)||1,t=Math.floor(e)||1,u=s+1,v=t+1,w=b/s,x=c/t,y=new Float32Array(u*v*3),z=new Float32Array(u*v*3),A=new Float32Array(u*v*2),B=0,C=0;for(f=0;f<v;f++){var D=f*x-r;for(g=0;g<u;g++)h=g*w-q,y[B]=h+n,y[B+1]=o,y[B+2]=-D+p,z[B+2]=-1,A[C]=(s-g)/s,A[C+1]=(t-f)/t,B+=3,C+=2}B=0;var E=new(y.length/3>65535?Uint32Array:Uint16Array)(s*t*6);for(f=0;f<t;f++)for(g=0;g<s;g++)i=g+u*f,j=g+u*(f+1),k=g+1+u*(f+1),l=g+1+u*f,E[B]=l,E[B+1]=j,E[B+2]=i,E[B+3]=l,E[B+4]=k,E[B+5]=j,B+=6;this._super(xeogl._apply(a,{positions:y,normals:z,uv:A,indices:E}))}})}(),function(){"use strict";xeogl.Input=xeogl.Component.extend({type:"xeogl.Input",serializable:!1,_init:function(a){var b=this;this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(a){b.enabled&&("INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!0:a.altKey?b.altDown=!0:(b.keyDown[a.keyCode]=!0,b.fire("keydown",a.keyCode,!0))),b.mouseover&&a.preventDefault())},!0),document.addEventListener("keyup",this._keyUpListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!1:a.altKey?b.altDown=!1:(b.keyDown[a.keyCode]=!1,b.fire("keyup",a.keyCode,!0)))}),a.element.addEventListener("mouseenter",this._mouseEnterListener=function(a){if(b.enabled){b.mouseover=!0;var c=b._getClickCoordsWithinElement(a);b.fire("mouseenter",c,!0)}}),a.element.addEventListener("mouseleave",this._mouseLeaveListener=function(a){if(b.enabled){b.mouseover=!1;var c=b._getClickCoordsWithinElement(a);b.fire("mouseleave",c,!0)}}),a.element.addEventListener("mousedown",this._mouseDownListener=function(c){if(b.enabled){switch(c.which){case 1:b.mouseDownLeft=!0;break;case 2:b.mouseDownMiddle=!0;break;case 3:b.mouseDownRight=!0}var d=b._getClickCoordsWithinElement(c);a.element.focus(),b.fire("mousedown",d,!0),b.mouseover&&c.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("mouseup",c,!0),b.mouseover&&a.preventDefault()}},!0),document.addEventListener("dblclick",this._dblClickListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1,b.mouseDownRight=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownLeft=!1,b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("dblclick",c,!0),b.mouseover&&a.preventDefault()}}),a.element.addEventListener("mousemove",this._mouseMoveListener=function(a){if(b.enabled){var c=b._getClickCoordsWithinElement(a);b.fire("mousemove",c,!0),b.mouseover&&a.preventDefault()}}),a.element.addEventListener("wheel",this._mouseWheelListener=function(a,c){if(b.enabled){var d=Math.max(-1,Math.min(1,40*-a.deltaY));b.fire("mousewheel",d,!0)}},{passive:!0}),function(){var a,c,d=2;b.on("mousedown",function(b){a=b[0],c=b[1]}),b.on("mouseup",function(e){a>=e[0]-d&&a<=e[0]+d&&c>=e[1]-d&&c<=e[1]+d&&b.fire("mouseclicked",e,!0)})}(),function(){var a,c,d={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0},e=xeogl.math.vec3(),f=xeogl.math.vec3(),g={orientation:null,orientationAngle:0},h={orientationAngle:0,acceleration:null,accelerationIncludingGravity:f,rotationRate:xeogl.math.vec3(),interval:0},i={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent&&window.addEventListener("orientationchange",b._orientationchangedListener=function(){a=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,c=a?d[a]||0:0,g.orientation=a,g.orientationAngle=c,b.fire("orientationchange",g)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",b._deviceMotionListener=function(a){h.interval=a.interval,h.orientationAngle=c;var d=a.acceleration;d?(e[0]=d.x,e[1]=d.y,e[2]=d.z,h.acceleration=e):h.acceleration=null;var g=a.accelerationIncludingGravity;g?(f[0]=g.x,f[1]=g.y,f[2]=g.z,h.accelerationIncludingGravity=f):h.accelerationIncludingGravity=null,h.rotationRate=a.rotationRate,b.fire("devicemotion",h)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",b._deviceOrientListener=function(a){i.gamma=a.gamma,i.beta=a.beta,i.alpha=a.alpha,i.absolute=a.absolute,b.fire("deviceorientation",i)},!1)}()},_getClickCoordsWithinElement:function(a){var b=[0,0];if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b},setEnabled:function(a){this.enabled!==a&&this.fire("enabled",this.enabled=a)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener)}})}(),function(){"use strict";xeogl.Lights=xeogl.Component.extend({type:"xeogl.Lights",_init:function(a){this._state=new xeogl.renderer.Lights({lights:[],hash:""}),this._lights=[],this._dirtySubs=[],this._destroyedSubs=[],a.lights&&(this.lights=a.lights),a.lightMap&&(this.lightMap=a.lightMap),a.reflectionMap&&(this.reflectionMap=a.reflectionMap)},_props:{lights:{set:function(a){function b(){g.fire("dirty",!0)}function c(){for(var a=this.id,b=0,c=g._lights.length;b<c;b++)if(g._lights[b].id===a)return g._lights=g._lights.slice(b,b+1),g._dirtySubs=g._dirtySubs.slice(b,b+1),g._destroyedSubs=g._destroyedSubs.slice(b,b+1),g.fire("dirty",!0),void g.fire("lights",g._lights)}a=a||[];var d,e,f;for(e=0,f=this._lights.length;e<f;e++)d=this._lights[e],d.off(this._dirtySubs[e]),d.off(this._destroyedSubs[e]);this._lights=[],this._dirtySubs=[],this._destroyedSubs=[];var g=this;for(e=0,f=a.length;e<f;e++){if(d=a[e],xeogl._isNumeric(d)||xeogl._isString(d)){var h=d;if(!(d=this.scene.components[h])){this.error("Component not found: "+xeogl._inQuotes(h));continue}}var i=d.type;"xeogl.AmbientLight"===i||"xeogl.DirLight"===i||"xeogl.PointLight"===i||"xeogl.SpotLight"===i?(this._lights.push(d),this._dirtySubs.push(d.on("dirty",b)),this._destroyedSubs.push(d.on("destroyed",c))):this.error("Component "+xeogl._inQuotes(d.id)+" is not an xeogl.AmbientLight, xeogl.DirLight, xeogl.PointLight or xeogl.SpotLight")}this.fire("dirty",!0),this._renderer.setImageForceDirty(),this.fire("lights",this._lights)},get:function(){return this._lights}},lightMap:{set:function(a){this._attachComponent("xeogl.CubeTexture","lightMap",a)},get:function(){return this._attached.lightMap}},reflectionMap:{set:function(a){this._attachComponent("xeogl.CubeTexture","reflectionMap",a)},get:function(){return this._attached.reflectionMap}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:void 0,this._hashDirty=!0},_shadowsDirty:function(){for(var a,b=0,c=this._lights.length;b<c;b++)a=this._lights[b]._state,a.shadow&&(a.shadowDirty=!0)},_getState:function(){var a=this._state;a.lights=[];for(var b=0,c=this._lights.length;b<c;b++)a.lights.push(this._lights[b]._state);return this._makeHash(),a},_makeHash:function(){for(var a,b=[],c=this._state,d=c.lights,e=0,f=d.length;e<f;e++)a=d[e],b.push("/"),b.push(a.type),b.push("world"===a.space?"w":"v"),a.shadow&&b.push("sh");c.lightMap&&b.push("/lm"),c.reflectionMap&&b.push("/rm"),b.push(";"),this._state.hash=b.join("")},_destroy:function(){var a,b,c;for(a=0,b=this._lights.length;a<b;a++)c=this._lights[a],c.off(this._dirtySubs[a]),c.off(this._destroyedSubs[a]);this._state.destroy()}})}(),function(){"use strict";xeogl.AmbientLight=xeogl.Component.extend({type:"xeogl.AmbientLight",_init:function(a){this._state={type:"ambient",color:xeogl.math.vec3([.7,.7,.7]),intensity:1},this.color=a.color,this.intensity=a.intensity},_props:{color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.setImageForceDirty(),this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){this._state.intensity=void 0!==a?a:1,this._renderer.setImageForceDirty(),this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}}})}(),function(){"use strict";var a=xeogl.math;xeogl.DirLight=xeogl.Component.extend({type:"xeogl.DirLight",_init:function(b){var c=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new xeogl.renderer.Light({type:"dir",dir:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,space:"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){var b=(a.vec3(),a.vec3([0,1,0]));return function(){if(c._shadowViewMatrixDirty){c._shadowViewMatrix||(c._shadowViewMatrix=a.identityMat4());var d=c._state.dir;a.lookAtMat4v([-d[0],-d[1],-d[2]],[0,0,0],b,c._shadowViewMatrix),c._shadowViewMatrixDirty=!1}return c._shadowViewMatrix}}(),getShadowProjMatrix:function(){return c._shadowProjMatrixDirty&&(c._shadowProjMatrix||(c._shadowProjMatrix=a.identityMat4()),xeogl.math.orthoMat4c(-10,10,-10,10,0,1e3,c._shadowProjMatrix),c._shadowProjMatrixDirty=!1),c._shadowProjMatrix},getShadowRenderBuf:function(){return c._shadowRenderBuf||(c._shadowRenderBuf=new xeogl.renderer.RenderBuffer(c.scene.canvas.canvas,c.scene.canvas.gl)),c._shadowRenderBuf}}),this.dir=b.dir,this.color=b.color,this.intensity=b.intensity,this.space=b.space,this.shadow=b.shadow},_props:{dir:{set:function(a){this._state.dir.set(a||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty(),this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty(),this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}},shadow:{set:function(a){a=!!a,this._state.shadow!==a&&(this._state.shadow=a,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("shadow",this._state.shadow),this.fire("dirty",!0))},get:function(){return this._state.shadow}}},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy()}})}(),function(){"use strict";var a=xeogl.math;xeogl.PointLight=xeogl.Component.extend({type:"xeogl.PointLight",_init:function(b){var c=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new xeogl.renderer.Light({type:"point",pos:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){var b=a.vec3([0,0,0]),d=a.vec3([0,1,0]);return function(){return c._shadowViewMatrixDirty&&(c._shadowViewMatrix||(c._shadowViewMatrix=a.identityMat4()),a.lookAtMat4v(c._state.pos,b,d,c._shadowViewMatrix),c._shadowViewMatrixDirty=!1),c._shadowViewMatrix}}(),getShadowProjMatrix:function(){if(c._shadowProjMatrixDirty){c._shadowProjMatrix||(c._shadowProjMatrix=a.identityMat4());var b=c.scene.canvas.canvas;a.perspectiveMat4(Math.PI/180*70,b.clientWidth/b.clientHeight,.1,500,c._shadowProjMatrix),c._shadowProjMatrixDirty=!1}return c._shadowProjMatrix},getShadowRenderBuf:function(){return c._shadowRenderBuf||(c._shadowRenderBuf=new xeogl.renderer.RenderBuffer(c.scene.canvas.canvas,c.scene.canvas.gl)),c._shadowRenderBuf}}),this.pos=b.pos,this.color=b.color,this.intensity=b.intensity,this.constantAttenuation=b.constantAttenuation,this.linearAttenuation=b.linearAttenuation,this.quadraticAttenuation=b.quadraticAttenuation,this.space=b.space,this.shadow=b.shadow},_props:{pos:{set:function(a){this._state.pos.set(a||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty(),this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty(),this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty(),this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty(),this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty(),this.fire("quadraticAttenuation",this._state.attenuation[2])},get:function(){return this._state.attenuation[2]}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}},shadow:{set:function(a){a=!!a,this._state.shadow!==a&&(this._state.shadow=a,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("shadow",this._state.shadow),this.fire("dirty",!0))},get:function(){return this._state.shadow}}},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy()}})}(),function(){"use strict";var a=xeogl.math;xeogl.SpotLight=xeogl.Component.extend({type:"xeogl.SpotLight",_init:function(b){var c=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new xeogl.renderer.Light({type:"spot",pos:a.vec3([1,1,1]),dir:a.vec3([0,-1,0]),color:a.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:"view",
shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){var b=a.vec3(),d=a.vec3([0,1,0]);return function(){return c._shadowViewMatrixDirty&&(c._shadowViewMatrix||(c._shadowViewMatrix=a.identityMat4()),a.addVec3(c._state.pos,c._state.dir,b),a.lookAtMat4v(c._state.pos,b,d,c._shadowViewMatrix),c._shadowViewMatrixDirty=!1),c._shadowViewMatrix}}(),getShadowProjMatrix:function(){if(c._shadowProjMatrixDirty){c._shadowProjMatrix||(c._shadowProjMatrix=a.identityMat4());var b=c.scene.canvas.canvas;a.perspectiveMat4(Math.PI/180*60,b.clientWidth/b.clientHeight,.1,400,c._shadowProjMatrix),c._shadowProjMatrixDirty=!1}return c._shadowProjMatrix},getShadowRenderBuf:function(){return c._shadowRenderBuf||(c._shadowRenderBuf=new xeogl.renderer.RenderBuffer(c.scene.canvas.canvas,c.scene.canvas.gl)),c._shadowRenderBuf}}),this.pos=b.pos,this.color=b.color,this.intensity=b.intensity,this.constantAttenuation=b.constantAttenuation,this.linearAttenuation=b.linearAttenuation,this.quadraticAttenuation=b.quadraticAttenuation,this.space=b.space,this.shadow=b.shadow},_props:{pos:{set:function(a){this._state.pos.set(a||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},dir:{set:function(a){this._state.dir.set(a||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("dir",this._state.dir)},get:function(){return this._state.dir}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty(),this.fire("color",this._state.color)},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty(),this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty(),this.fire("constantAttenuation",this._state.attenuation[0])},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty(),this.fire("linearAttenuation",this._state.attenuation[1])},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty(),this.fire("quadraticAttenuation",this._state.attenuation[2])},get:function(){return this._state.attenuation[2]}},space:{set:function(a){this._state.space=a||"view",this.fire("dirty",!0),this.fire("space",this._state.space)},get:function(){return this._state.space}},shadow:{set:function(a){a=!!a,this._state.shadow!==a&&(this._state.shadow=a,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("shadow",this._state.shadow),this.fire("dirty",!0))},get:function(){return this._state.shadow}}},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy()}})}(),function(){"use strict";xeogl.CubeTexture=xeogl.Component.extend({type:"xeogl.CubeTexture",_init:function(a){this._state=new xeogl.renderer.CubeTexture({texture:null}),this._src=[],this._images=[],this._srcDirty=!1,this._imageDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.flipY=a.flipY,this.src=a.src,this.encoding=a.encoding,xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.texture=null,this._src&&(this._srcDirty=!0),this._needUpdate()},_update:function(){if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);this._imageDirty&&(this._createTexture(),this._renderer.imageDirty())},_loadSrc:function(a){var b=this;this._images=[];for(var c=!1,d=0,e=0;e<a.length;e++){var f=new Image;f.onload=function(){var a=f,g=e;return function(){c||(a=xeogl.renderer.ensureImageSizePowerOfTwo(a),b._images[g]=a,6===++d&&(b._imageDirty=!0,b._needUpdate(),b.fire("loaded",b._src)))}}(),f.onerror=function(){c=!0},f.src=a[e]}},_createTexture:function(){var a=this.scene.canvas.gl,b=this._state.texture;b||(b=new xeogl.renderer.Texture2D(a,a.TEXTURE_CUBE_MAP),this._state.texture=b),b.setImage(this._images,this._state),b.setProps({minFilter:"linearMipmapLinear",magFilter:"linear",wrapS:"clampToEdge",wrapT:"clampToEdge",mipmaps:!0}),this._imageDirty=!1},_props:{src:{set:function(a){this._src=a,this._srcDirty=!0,this._needUpdate(),this.fire("src",this._src)},get:function(){return this._src}},flipY:{set:function(a){a=!!a,this._state.flipY!==a&&(this._state.flipY=a,this._imageDirty=!0,this._needUpdate(),this.fire("flipY",this._state.flipY))},get:function(){return this._state.flipY}},encoding:{set:function(a){a=a||"linear","linear"!==a&&"sRGB"!==a&&"gamma"!==a&&(this.error("Unsupported value for 'encoding': '"+a+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),a="linear"),this._state.encoding=a,this.fire("dirty")},get:function(){return this._state.encoding}}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Shadow=xeogl.Component.extend({type:"xeogl.Shadow",_init:function(a){this._state={resolution:xeogl.math.vec3([1e3,1e3]),intensity:1},this.resolution=a.resolution,this.intensity=a.intensity},_props:{resolution:{set:function(a){this._state.resolution.set(a||[1e3,1e3]),this._renderer.imageDirty(),this.fire("resolution",this._state.resolution)},get:function(){return this._state.resolution}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty(),this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}}})}(),function(){"use strict";xeogl.Model=xeogl.Component.extend({type:"xeogl.Model",_init:function(a){if(this.components={},this.numComponents=0,this.types={},this.entities={},this._onDestroyed={},this._onBoundary={},this._aabb=xeogl.math.AABB3(),this._aabbDirty=!1,this._dummyRootTransform=this.create({type:"xeogl.Transform",meta:"dummy"}),this.transform=a.transform,this.ghosted=a.ghosted||a.ghost,this.highlighted=a.highlighted,this.visible=a.visible,this.outlined=a.outlined,this.selected=a.selected,a.components)for(var b=a.components,c=0,d=b.length;c<d;c++)this.add(b[c])},add:function(a){var b,c;if(xeogl._isNumeric(a)||xeogl._isString(a)){if(this.scene.types[a]){var d=a;if(!(c=this.scene.types[d]))return void this.warn("Component type not found: '"+d+"'");for(b in c)c.hasOwnProperty(b)&&this.add(c[b]);return}if(!(a=this.scene.components[a]))return void this.warn("Component not found: "+xeogl._inQuotes(a))}else if(xeogl._isObject(a)){var d=a.type||"xeogl.Component";if(!xeogl._isComponentType(d))return void this.error("Not a xeogl component type: "+d);a=new window[d](this.scene,a)}if(a.scene!==this.scene)return void this.warn("Attempted to add component from different xeogl.Scene: "+xeogl._inQuotes(a.id));if(!this.components[a.id]){this.components[a.id]=a,c=this.types[a.type],c||(c=this.types[a.type]={}),c[a.id]=a,this.numComponents++;var e=this;if(this._onDestroyed[a.id]=a.on("destroyed",function(){e.remove(a)}),a.isType("xeogl.Entity")){var f=a.transform;if(f&&"default.transform"!==f.id){for(;f.parent&&f.id!==e._dummyRootTransform.id;)f=f.parent;f.id!==e._dummyRootTransform.id&&(f.parent=e._dummyRootTransform)}else a.transform=e._dummyRootTransform;this.entities[a.id]=a,a.ghosted=this.ghosted,a.highlighted=this.highlighted,a.visible=this.visible,a.selected=this.selected,this._onBoundary[a.id]=a.on("boundary",this._setAABBDirty,this),this._setAABBDirty()}return this.fire("added",a),this._dirty||this._needUpdate(),a}},_needUpdate:function(){this._dirty||(this._dirty=!0,xeogl.scheduleTask(this._notifyUpdated,this))},_notifyUpdated:function(){this.fire("updated"),this._aabbDirty||this._setAABBDirty(),this._dirty=!1},destroyAll:function(){var a,b,c,d,e=[];for(a in this.types)if(this.types.hasOwnProperty(a)){b=this.types[a];for(d in b)b.hasOwnProperty(d)&&(c=b[d],c.isType("xeogl.Entity")?e.push(c):e.unshift(c))}for(;e.length>0;)e.pop().destroy()},removeAll:function(){this.iterate(function(a){a.destroy()})},remove:function(a){if(xeogl._isNumeric(a)||xeogl._isString(a)){var b=a;if(!(a=this.scene.components[b]))return void this.warn("Component not found in Scene: "+b);if(!(a=this.components[b]))return void this.warn("Component "+b+" is not in this Model")}else if(a.scene!==this.scene)return void this.warn("Attempted to remove component that's not in same xeogl.Scene: '"+a.id+"'");this._remove(a)},_remove:function(a){var b=a.id;delete this.components[b],delete this.entities[b],a.off(this._onDestroyed[b]),delete this._onDestroyed[b];var c=this.types[a.type];c&&delete c[a.id],this.numComponents--,a.isType("xeogl.Entity")&&(a.off(this._onBoundary[a.id]),delete this._onBoundary[a.id]),this.fire("removed",a),this._dirty||this._needUpdate()},iterate:function(a,b){b=b||this;var c=this.components;for(var d in c)c.hasOwnProperty(d)&&a.call(b,c[d])},_props:{transform:{set:function(a){this._attach({name:"transform",type:"xeogl.Transform",component:a,sceneDefault:!1,onAttached:{callback:this._transformUpdated,scope:this}})},get:function(){return this._attached.transform}},aabb:{get:function(){if(this._aabbDirty){var a,b=xeogl.math.MAX_DOUBLE,c=xeogl.math.MAX_DOUBLE,d=xeogl.math.MAX_DOUBLE,e=-xeogl.math.MAX_DOUBLE,f=-xeogl.math.MAX_DOUBLE,g=-xeogl.math.MAX_DOUBLE,h=this.entities;for(var i in h)h.hasOwnProperty(i)&&(a=h[i].aabb,a[0]<b&&(b=a[0]),a[1]<c&&(c=a[1]),a[2]<d&&(d=a[2]),a[3]>e&&(e=a[3]),a[4]>f&&(f=a[4]),a[5]>g&&(g=a[5]));this._aabb[0]=b,this._aabb[1]=c,this._aabb[2]=d,this._aabb[3]=e,this._aabb[4]=f,this._aabb[5]=g,this._aabbDirty=!1}return this._aabb}},visible:{set:function(a){a=!1!==a,this._visible=a;for(var b in this.entities)this.entities.hasOwnProperty(b)&&(this.entities[b].visible=a)},get:function(){return this._visible}},"ghosted,ghost":{set:function(a){a=!!a,this._ghosted=a;for(var b in this.entities)this.entities.hasOwnProperty(b)&&(this.entities[b].ghosted=a)},get:function(){return this._ghosted}},"highlight,highlighted":{set:function(a){a=!!a,this._highlighted=a;for(var b in this.entities)this.entities.hasOwnProperty(b)&&(this.entities[b].highlighted=a)},get:function(){return this._highlighted}},selected:{set:function(a){a=!!a,this._selected=a;for(var b in this.entities)this.entities.hasOwnProperty(b)&&(this.entities[b].selected=a)},get:function(){return this._selected}},"outlined,outline":{set:function(a){a=!!a,this._outlined=a;for(var b in this.entities)this.entities.hasOwnProperty(b)&&(this.entities[b].outlined=a)},get:function(){return this._outlined}}},_transformUpdated:function(a){this._dummyRootTransform.parent=a,this._setAABBDirty()},_setAABBDirty:function(){this._aabbDirty||(this._aabbDirty=!0,this.fire("boundary"))},_destroy:function(){this.removeAll()}})}(),function(){"use strict";xeogl.Material=xeogl.Component.extend({type:"xeogl.Material",_init:function(){xeogl.stats.memory.materials++},_destroy:function(){xeogl.stats.memory.materials--}})}(),function(){"use strict";xeogl.PhongMaterial=xeogl.Material.extend({type:"xeogl.PhongMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.PhongMaterial({type:"PhongMaterial",ambient:xeogl.math.vec3([1,1,1]),diffuse:xeogl.math.vec3([1,1,1]),specular:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.ambient=a.ambient,this.diffuse=a.diffuse,this.specular=a.specular,this.emissive=a.emissive,this.alpha=a.alpha,this.shininess=a.shininess,this.reflectivity=a.reflectivity,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,a.ambientMap&&(this.ambientMap=a.ambientMap),a.diffuseMap&&(this.diffuseMap=a.diffuseMap),a.specularMap&&(this.specularMap=a.specularMap),a.emissiveMap&&(this.emissiveMap=a.emissiveMap),a.alphaMap&&(this.alphaMap=a.alphaMap),a.reflectivityMap&&(this.reflectivityMap=a.reflectivityMap),a.normalMap&&(this.normalMap=a.normalMap),a.occlusionMap&&(this.occlusionMap=a.occlusionMap),a.diffuseFresnel&&(this.diffuseFresnel=a.diffuseFresnel),a.specularFresnel&&(this.specularFresnel=a.specularFresnel),a.emissiveFresnel&&(this.emissiveFresnel=a.emissiveFresnel),a.alphaFresnel&&(this.alphaFresnel=a.alphaFresnel),a.reflectivityFresnel&&(this.reflectivityFresnel=a.reflectivityFresnel),this.alphaMode=a.alphaMode,this.alphaCutoff=a.alphaCutoff,this.backfaces=a.backfaces,this.frontface=a.frontface},_props:{ambient:{set:function(a){var b=this._state.ambient;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.ambient=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.2,b[1]=.2,b[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.ambient}},diffuse:{set:function(a){var b=this._state.diffuse;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.diffuse=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.diffuse}},specular:{set:function(a){var b=this._state.specular;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.specular=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.specular}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty())},get:function(){return this._state.alpha}},shininess:{set:function(a){this._state.shininess=void 0!==a?a:80,this._renderer.imageDirty()},get:function(){return this._state.shininess}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}},reflectivity:{set:function(a){this._state.reflectivity=void 0!==a?a:1,this._renderer.imageDirty()},get:function(){return this._state.reflectivity}},normalMap:{set:function(a){this._attachComponent("xeogl.Texture","normalMap",a)},get:function(){return this._attached.normalMap}},ambientMap:{set:function(a){this._attachComponent("xeogl.Texture","ambientMap",a)},get:function(){return this._attached.ambientMap}},diffuseMap:{set:function(a){this._attachComponent("xeogl.Texture","diffuseMap",a)},get:function(){return this._attached.diffuseMap}},specularMap:{set:function(a){this._attachComponent("xeogl.Texture","specularMap",a)},get:function(){return this._attached.specularMap}},emissiveMap:{set:function(a){this._attachComponent("xeogl.Texture","emissiveMap",a)},get:function(){return this._attached.emissiveMap}},alphaMap:{set:function(a){this._attachComponent("xeogl.Texture","alphaMap",a)},get:function(){return this._attached.alphaMap}},reflectivityMap:{set:function(a){this._attachComponent("xeogl.Texture","reflectivityMap",a)},get:function(){return this._attached.reflectivityMap}},reflection:{set:function(a){this._attachComponent("xeogl.Reflect","reflection",a)},get:function(){return this._attached.reflection}},occlusionMap:{set:function(a){this._attachComponent("xeogl.Texture","occlusionMap",a)},get:function(){return this._attached.occlusionMap}},diffuseFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","diffuseFresnel",a)},get:function(){return this._attached.diffuseFresnel}},specularFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","specularFresnel",a)},get:function(){return this._attached.specularFresnel}},emissiveFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","emissiveFresnel",a)},get:function(){return this._attached.emissiveFresnel}},alphaFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","alphaFresnel",a)},get:function(){return this._attached.alphaFresnel}},reflectivityFresnel:{set:function(a){this._attachComponent("xeogl.Fresnel","reflectivityFresnel",a)},get:function(){return this._attached.reflectivityFresnel}},alphaMode:function(){var a={opaque:0,mask:1,blend:2},b=["opaque","mask","blend"];return{set:function(b){b=b||"opaque";var c=a[b];void 0===c&&(this.error("Unsupported value for 'alphaMode': "+b+" - defaulting to 'opaque'"),c="opaque"),this._state.alphaMode!==c&&(this._state.alphaMode=c,this._renderer.imageDirty())},get:function(){return b[this._state.alphaMode]}}}(),alphaCutoff:{set:function(a){null!==a&&void 0!==a||(a=.5),this._state.alphaCutoff!==a&&(this._state.alphaCutoff=a)},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_getState:function(){return this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._state},_makeHash:function(){var a=this._state,b=["/p"];a.normalMap&&(b.push("/nm"),a.normalMap.matrix&&b.push("/mat")),a.ambientMap&&(b.push("/am"),a.ambientMap.matrix&&b.push("/mat"),b.push("/"+a.ambientMap.encoding)),a.diffuseMap&&(b.push("/dm"),a.diffuseMap.matrix&&b.push("/mat"),b.push("/"+a.diffuseMap.encoding)),a.specularMap&&(b.push("/sm"),a.specularMap.matrix&&b.push("/mat")),a.emissiveMap&&(b.push("/em"),a.emissiveMap.matrix&&b.push("/mat"),b.push("/"+a.emissiveMap.encoding)),a.alphaMap&&(b.push("/opm"),a.alphaMap.matrix&&b.push("/mat")),a.reflectivityMap&&(b.push("/rm"),a.reflectivityMap.matrix&&b.push("/mat")),a.occlusionMap&&(b.push("/ocm"),a.occlusionMap.matrix&&b.push("/mat")),a.diffuseFresnel&&b.push("/df"),a.specularFresnel&&b.push("/sf"),a.emissiveFresnel&&b.push("/ef"),a.alphaFresnel&&b.push("/of"),a.reflectivityFresnel&&b.push("/rf"),b.push(";"),a.hash=b.join("")},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.LambertMaterial=xeogl.Material.extend({type:"xeogl.LambertMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.LambertMaterial({type:"LambertMaterial",ambient:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),alpha:null,alphaMode:0,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:"/lam;"}),this.ambient=a.ambient,this.color=a.color,this.emissive=a.emissive,this.alpha=a.alpha,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,this.backfaces=a.backfaces,this.frontface=a.frontface},_props:{ambient:{set:function(a){var b=this._state.ambient;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.ambient=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.2,b[1]=.2,b[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.ambient}},color:{set:function(a){var b=this._state.color;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.color=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.color}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._state.alphaMode=a<1?2:0,this._renderer.imageDirty())},get:function(){return this._state.alpha}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}}},_getState:function(){return this._state},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.SpecularMaterial=xeogl.Material.extend({type:"xeogl.SpecularMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.SpecularMaterial({type:"SpecularMaterial",diffuse:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),specular:xeogl.math.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,diffuseMap:null,emissiveMap:null,specularMap:null,glossinessMap:null,specularGlossinessMap:null,occlusionMap:null,alphaMap:null,normalMap:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.diffuse=a.diffuse,this.specular=a.specular,this.glossiness=a.glossiness,this.specularF0=a.specularF0,this.emissive=a.emissive,this.alpha=a.alpha,a.diffuseMap&&(this.diffuseMap=a.diffuseMap),a.emissiveMap&&(this.emissiveMap=a.emissiveMap),a.specularMap&&(this.specularMap=a.specularMap),a.glossinessMap&&(this.glossinessMap=a.glossinessMap),a.specularGlossinessMap&&(this.specularGlossinessMap=a.specularGlossinessMap),a.occlusionMap&&(this.occlusionMap=a.occlusionMap),a.alphaMap&&(this.alphaMap=a.alphaMap),a.normalMap&&(this.normalMap=a.normalMap),this.alphaMode=a.alphaMode,this.alphaCutoff=a.alphaCutoff,this.backfaces=a.backfaces,this.frontface=a.frontface,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize},_props:{diffuse:{set:function(a){var b=this._state.diffuse;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.diffuse=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.diffuse}},diffuseMap:{set:function(a){this._attachComponent("xeogl.Texture","diffuseMap",a)},get:function(){return this._attached.diffuseMap}},specular:{set:function(a){var b=this._state.specular;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.specular=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.specular}},specularMap:{set:function(a){this._attachComponent("xeogl.Texture","specularMap",a)},get:function(){return this._attached.specularMap}},specularGlossinessMap:{set:function(a){this._attachComponent("xeogl.Texture","specularGlossinessMap",a)},get:function(){return this._attached.specularGlossinessMap}},glossiness:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.glossiness!==a&&(this._state.glossiness=a,this._renderer.imageDirty())},get:function(){return this._state.glossiness}},glossinessMap:{set:function(a){this._attachComponent("xeogl.Texture","glossinessMap",a)},get:function(){return this._attached.glossinessMap}},specularF0:{set:function(a){a=void 0!==a&&null!==a?a:0,this._state.specularF0!==a&&(this._state.specularF0=a,this._renderer.imageDirty())},get:function(){return this._state.specularF0}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},emissiveMap:{set:function(a){this._attachComponent("xeogl.Texture","emissiveMap",a)},get:function(){return this._attached.emissiveMap}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty())},get:function(){return this._state.alpha}},alphaMap:{set:function(a){this._attachComponent("xeogl.Texture","alphaMap",a)},get:function(){return this._attached.alphaMap}},normalMap:{set:function(a){this._attachComponent("xeogl.Texture","normalMap",a)},get:function(){return this._attached.normalMap}},occlusionMap:{set:function(a){this._attachComponent("xeogl.Texture","occlusionMap",a)},get:function(){return this._attached.occlusionMap}},alphaMode:function(){var a={opaque:0,mask:1,blend:2},b=["opaque","mask","blend"];return{set:function(b){b=b||"opaque";var c=a[b];void 0===c&&(this.error("Unsupported value for 'alphaMode': "+b+" defaulting to 'opaque'"),c="opaque"),this._state.alphaMode!==c&&(this._state.alphaMode=c,this._renderer.imageDirty())},get:function(){return b[this._state.alphaMode]}}}(),alphaCutoff:{set:function(a){null!==a&&void 0!==a||(a=.5),this._state.alphaCutoff!==a&&(this._state.alphaCutoff=a)},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_getState:function(){return this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._state},_makeHash:function(){var a=this._state,b=["/spe"];a.diffuseMap&&(b.push("/dm"),a.diffuseMap.matrix&&b.push("/mat"),b.push("/"+a.diffuseMap.encoding)),a.emissiveMap&&(b.push("/em"),a.emissiveMap.matrix&&b.push("/mat")),a.glossinessMap&&(b.push("/gm"),a.glossinessMap.matrix&&b.push("/mat")),a.specularMap&&(b.push("/sm"),a.specularMap.matrix&&b.push("/mat")),a.specularGlossinessMap&&(b.push("/sgm"),a.specularGlossinessMap.matrix&&b.push("/mat")),a.occlusionMap&&(b.push("/ocm"),a.occlusionMap.matrix&&b.push("/mat")),a.normalMap&&(b.push("/nm"),a.normalMap.matrix&&b.push("/mat")),a.alphaMap&&(b.push("/opm"),a.alphaMap.matrix&&b.push("/mat")),b.push(";"),a.hash=b.join("")},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.MetallicMaterial=xeogl.Material.extend({type:"xeogl.MetallicMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.MetallicMaterial({type:"MetallicMaterial",baseColor:xeogl.math.vec4([1,1,1]),emissive:xeogl.math.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,baseColorMap:null,alphaMap:null,metallicMap:null,roughnessMap:null,metallicRoughnessMap:null,emissiveMap:null,occlusionMap:null,normalMap:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this._hashDirty=!0,this.on("dirty",function(){this._hashDirty=!0},this),this.baseColor=a.baseColor,this.metallic=a.metallic,this.roughness=a.roughness,this.specularF0=a.specularF0,this.emissive=a.emissive,this.alpha=a.alpha,a.baseColorMap&&(this.baseColorMap=a.baseColorMap),a.metallicMap&&(this.metallicMap=a.metallicMap),a.roughnessMap&&(this.roughnessMap=a.roughnessMap),a.metallicRoughnessMap&&(this.metallicRoughnessMap=a.metallicRoughnessMap),a.emissiveMap&&(this.emissiveMap=a.emissiveMap),a.occlusionMap&&(this.occlusionMap=a.occlusionMap),a.alphaMap&&(this.alphaMap=a.alphaMap),a.normalMap&&(this.normalMap=a.normalMap),this.alphaMode=a.alphaMode,this.alphaCutoff=a.alphaCutoff,this.backfaces=a.backfaces,this.frontface=a.frontface,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize},_props:{baseColor:{set:function(a){var b=this._state.baseColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.baseColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.baseColor}},baseColorMap:{set:function(a){this._attachComponent("xeogl.Texture","baseColorMap",a)},get:function(){return this._attached.baseColorMap}},metallic:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.metallic!==a&&(this._state.metallic=a,this._renderer.imageDirty())},get:function(){return this._state.metallic}},metallicMap:{set:function(a){this._attachComponent("xeogl.Texture","metallicMap",a)},get:function(){return this._attached.metallicMap}},roughness:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.roughness!==a&&(this._state.roughness=a,this._renderer.imageDirty())},get:function(){return this._state.roughness}},roughnessMap:{set:function(a){this._attachComponent("xeogl.Texture","roughnessMap",a)},get:function(){return this._attached.roughnessMap}},metallicRoughnessMap:{set:function(a){this._attachComponent("xeogl.Texture","metallicRoughnessMap",a)},get:function(){return this._attached.metallicRoughnessMap}},specularF0:{set:function(a){a=void 0!==a&&null!==a?a:0,this._state.specularF0!==a&&(this._state.specularF0=a,this._renderer.imageDirty())},get:function(){return this._state.specularF0}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},emissiveMap:{set:function(a){this._attachComponent("xeogl.Texture","emissiveMap",a)},get:function(){return this._attached.emissiveMap}},occlusionMap:{set:function(a){this._attachComponent("xeogl.Texture","occlusionMap",a)},get:function(){return this._attached.occlusionMap}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty())},get:function(){return this._state.alpha}},alphaMap:{set:function(a){this._attachComponent("xeogl.Texture","alphaMap",a)},get:function(){return this._attached.alphaMap}},normalMap:{set:function(a){this._attachComponent("xeogl.Texture","normalMap",a)},get:function(){return this._attached.normalMap}},alphaMode:function(){var a={opaque:0,mask:1,blend:2},b=["opaque","mask","blend"];return{set:function(b){b=b||"opaque";var c=a[b];void 0===c&&(this.error("Unsupported value for 'alphaMode': "+b+" defaulting to 'opaque'"),c="opaque"),this._state.alphaMode!==c&&(this._state.alphaMode=c,this._renderer.imageDirty())},get:function(){return b[this._state.alphaMode]}}}(),alphaCutoff:{set:function(a){null!==a&&void 0!==a||(a=.5),this._state.alphaCutoff!==a&&(this._state.alphaCutoff=a)},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}}},_attachComponent:function(a,b,c){c=this._attach({name:b,type:a,
component:c,sceneDefault:!1,on:{destroyed:{callback:function(){this._state[b]=null,this._hashDirty=!0},scope:this}}}),this._state[b]=c?c._state:null,this._hashDirty=!0},_getState:function(){return this._hashDirty&&(this._makeHash(),this._hashDirty=!1),this._state},_makeHash:function(){var a=this._state,b=["/met"];a.baseColorMap&&(b.push("/bm"),a.baseColorMap.matrix&&b.push("/mat"),b.push("/"+a.baseColorMap.encoding)),a.metallicMap&&(b.push("/mm"),a.metallicMap.matrix&&b.push("/mat")),a.roughnessMap&&(b.push("/rm"),a.roughnessMap.matrix&&b.push("/mat")),a.metallicRoughnessMap&&(b.push("/mrm"),a.metallicRoughnessMap.matrix&&b.push("/mat")),a.emissiveMap&&(b.push("/em"),a.emissiveMap.matrix&&b.push("/mat")),a.occlusionMap&&(b.push("/ocm"),a.occlusionMap.matrix&&b.push("/mat")),a.alphaMap&&(b.push("/am"),a.alphaMap.matrix&&b.push("/mat")),a.normalMap&&(b.push("/nm"),a.normalMap.matrix&&b.push("/mat")),b.push(";"),a.hash=b.join("")},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.EmphasisMaterial=xeogl.Material.extend({type:"xeogl.EmphasisMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.EmphasisMaterial({type:"EmphasisMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,vertices:null,vertexColor:null,vertexAlpha:null,vertexSize:null,fill:null,fillColor:null,fillAlpha:null}),this._preset="default",a.preset?(this.preset=a.preset,void 0!==a.edges&&(this.edges=a.edges),a.edgeColor&&(this.edgeColor=a.edgeColor),void 0!==a.edgeAlpha&&(this.edgeAlpha=a.edgeAlpha),void 0!==a.edgeWidth&&(this.edgeWidth=a.edgeWidth),void 0!==a.vertices&&(this.vertices=a.vertices),a.vertexColor&&(this.vertexColor=a.vertexColor),void 0!==a.vertexAlpha&&(this.vertexAlpha=a.vertexAlpha),a.vertexSize&&(this.vertexSize=a.vertexSize),void 0!==a.fill&&(this.fill=a.fill),a.fillColor&&(this.fillColor=a.fillColor),void 0!==a.fillAlpha&&(this.fillAlpha=a.fillAlpha)):(this.edges=a.edges,this.edgeColor=a.edgeColor,this.edgeAlpha=a.edgeAlpha,this.edgeWidth=a.edgeWidth,this.vertices=a.vertices,this.vertexColor=a.vertexColor,this.vertexAlpha=a.vertexAlpha,this.vertexSize=a.vertexSize,this.fill=a.fill,this.fillColor=a.fillColor,this.fillAlpha=a.fillAlpha)},_props:{edges:{set:function(a){a=!1!==a,this._state.edges!==a&&(this._state.edges=a,this._renderer.imageDirty())},get:function(){return this._state.edges}},edgeColor:{set:function(a){var b=this._state.edgeColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.edgeColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.2,b[1]=.2,b[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.edgeColor}},edgeAlpha:{set:function(a){a=void 0!==a&&null!==a?a:.5,this._state.edgeAlpha!==a&&(this._state.edgeAlpha=a,this._renderer.imageDirty())},get:function(){return this._state.edgeAlpha}},edgeWidth:{set:function(a){this._state.edgeWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.edgeWidth}},vertices:{set:function(a){a=!!a,this._state.vertices!==a&&(this._state.vertices=a,this._renderer.imageDirty())},get:function(){return this._state.vertices}},vertexColor:{set:function(a){var b=this._state.vertexColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.vertexColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.4,b[1]=.4,b[2]=.4),this._renderer.imageDirty()},get:function(){return this._state.vertexColor}},vertexAlpha:{set:function(a){a=void 0!==a&&null!==a?a:.7,this._state.vertexAlpha!==a&&(this._state.vertexAlpha=a,this._renderer.imageDirty())},get:function(){return this._state.vertexAlpha}},vertexSize:{set:function(a){this._state.vertexSize=a||4,this._renderer.imageDirty()},get:function(){return this._state.vertexSize}},fill:{set:function(a){a=!1!==a,this._state.fill!==a&&(this._state.fill=a,this._renderer.imageDirty())},get:function(){return this._state.fill}},fillColor:{set:function(a){var b=this._state.fillColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.fillColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.4,b[1]=.4,b[2]=.4),this._renderer.imageDirty()},get:function(){return this._state.fillColor}},fillAlpha:{set:function(a){a=void 0!==a&&null!==a?a:.2,this._state.fillAlpha!==a&&(this._state.fillAlpha=a,this._renderer.imageDirty())},get:function(){return this._state.fillAlpha}},preset:{set:function(a){if(a=a||"default",this._preset!==a){var b=xeogl.EmphasisMaterial.presets[a];if(!b)return void this.error("unsupported preset: '"+a+"' - supported values are "+Object.keys(xeogl.EmphasisMaterial.presets).join(", "));this.edges=b.edges,this.edgeColor=b.edgeColor,this.edgeAlpha=b.edgeAlpha,this.edgeWidth=b.edgeWidth,this.vertices=b.vertices,this.vertexColor=b.vertexColor,this.vertexAlpha=b.vertexAlpha,this.vertexSize=b.vertexSize,this.fill=b.fill,this.fillColor=b.fillColor,this.fillAlpha=b.fillAlpha,this._preset=a}},get:function(){return this._preset}}},_getState:function(){return this._state},_destroy:function(){this._super(),this._state.destroy()}}),xeogl.EmphasisMaterial.presets={default:{edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[1,1,1],fillAlpha:.6},defaultLightBG:{edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},defaultDarkBG:{edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},phosphorous:{edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:1,fill:!0,fillColor:[0,0,0],fillAlpha:.4},sunset:{edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:1,fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2},vectorscope:{edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2,vertices:!0,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:8,fill:!0,fillColor:[0,0,0],fillAlpha:.7},battlezone:{edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3,vertices:!1,vertexColor:[.8,1,.8],vertexAlpha:.9,vertexSize:8,fill:!0,fillColor:[0,0,0],fillAlpha:1},sepia:{edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4},yellowHighlight:{edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[1,1,0],fillAlpha:.5},greenSelected:{edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[0,1,0],fillAlpha:.5},gamegrid:{edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9}},xeogl.GhostMaterial=xeogl.EmphasisMaterial}(),function(){"use strict";xeogl.OutlineMaterial=xeogl.Material.extend({type:"xeogl.OutlineMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.OutlineMaterial({type:"OutlineMaterial",color:null,alpha:null,width:null}),this.color=a.color,this.alpha=a.alpha,this.width=a.width},_props:{color:{set:function(a){var b=this._state.color;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.color=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=.2,b[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.color}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty())},get:function(){return this._state.alpha}},width:{set:function(a){this._state.width=a||4,this._renderer.imageDirty()},get:function(){return this._state.width}}},_getState:function(){return this._state},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.Texture=xeogl.Component.extend({type:"xeogl.Texture",_init:function(a){this._state=new xeogl.renderer.Texture({texture:new xeogl.renderer.Texture2D(this.scene.canvas.gl),matrix:null,minFilter:null,magFilter:null,wrapS:null,wrapT:null,flipY:!1}),this._src=null,this._image=null,this._translate=xeogl.math.vec2([0,0]),this._scale=xeogl.math.vec2([1,1]),this._rotate=xeogl.math.vec2([0,0]),this._matrixDirty=!1,this._srcDirty=!1,this._imageDirty=!1,this._propsDirty=!1,this._webglContextRestored=this.scene.canvas.on("webglContextRestored",this._webglContextRestored,this),this.translate=a.translate,this.scale=a.scale,this.rotate=a.rotate,this.minFilter=a.minFilter,this.magFilter=a.magFilter,this.wrapS=a.wrapS,this.wrapT=a.wrapT,this.flipY=a.flipY,this.encoding=a.encoding,a.src?this.src=a.src:a.image&&(this.image=a.image),xeogl.stats.memory.textures++},_webglContextRestored:function(){this._state.texture=null,this._matrixDirty=!0,this._propsDirty=!0,this._image?this._imageDirty=!0:this._src&&(this._srcDirty=!0),this._needUpdate()},_update:function(){var a=this.scene.canvas.gl,b=this._state;if(this._srcDirty&&this._src)return this._loadSrc(this._src),void(this._srcDirty=!1);if(this._imageDirty&&this._image&&(b.texture||(b.texture=new xeogl.renderer.Texture2D(a)),b.texture.setImage(this._image,b),b.renderable=!0,this._imageDirty=!1,this._propsDirty=!0),this._matrixDirty){var c,d;0===this._translate[0]&&0===this._translate[1]||(c=xeogl.math.translationMat4v([this._translate[0],this._translate[1],0])),1===this._scale[0]&&1===this._scale[1]||(d=xeogl.math.scalingMat4v([this._scale[0],this._scale[1],1]),c=c?xeogl.math.mulMat4(c,d):d),0!==this._rotate&&(d=xeogl.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),c=c?xeogl.math.mulMat4(c,d):d);var e=b.matrix;b.matrix=c,this._matrixDirty=!1,!!c!=!!e&&this.fire("dirty")}this._propsDirty&&(b.texture&&b.texture.setProps&&b.texture.setProps(b),this._propsDirty=!1),this._renderer.imageDirty()},_loadSrc:function(a){var b=this,c=new Image;c.onload=function(){b._src===a&&(b._image=xeogl.renderer.ensureImageSizePowerOfTwo(c),b._imageDirty=!0,b._srcDirty=!1,b._needUpdate(),b.fire("loaded",b._src))},c.onerror=function(){b.fire("error")},0===a.indexOf("data")?c.src=a:(c.crossOrigin="Anonymous",c.src=a)},_props:{image:{set:function(a){this._image=xeogl.renderer.ensureImageSizePowerOfTwo(a),this._src=null,this._imageDirty=!0,this._srcDirty=!1,this._needUpdate()},get:function(){return this._image}},src:{set:function(a){this._image=null,this._src=a,this._imageDirty=!1,this._srcDirty=!0,this._needUpdate()},get:function(){return this._src}},translate:{set:function(a){this._translate.set(a||[0,0]),this._matrixDirty=!0,this._needUpdate()},get:function(){return this._translate}},scale:{set:function(a){this._scale.set(a||[1,1]),this._matrixDirty=!0,this._needUpdate()},get:function(){return this._scale}},rotate:{set:function(a){a=a||0,this._rotate!==a&&(this._rotate=a,this._matrixDirty=!0,this._needUpdate())},get:function(){return this._rotate}},minFilter:{set:function(a){a=a||"linearMipmapLinear","linear"!==a&&"linearMipmapNearest"!==a&&"linearMipmapLinear"!==a&&"nearestMipmapLinear"!==a&&"linearMipmapLinear"!==a&&(this.error("Unsupported value for 'minFilter': '"+a+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),a="linearMipmapLinear"),this._state.minFilter=a,this._propsDirty=!0,this._needUpdate()},get:function(){return this._state.minFilter}},magFilter:{set:function(a){a=a||"linear","linear"!==a&&"nearest"!==a&&(this.error("Unsupported value for 'magFilter': '"+a+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),a="linear"),this._state.magFilter=a,this._propsDirty=!0,this._needUpdate()},get:function(){return this._state.magFilter}},wrapS:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapS': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapS=a,this._propsDirty=!0,this._needUpdate()},get:function(){return this._state.wrapS}},wrapT:{set:function(a){a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapT': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),this._state.wrapT=a,this._propsDirty=!0,this._needUpdate()},get:function(){return this._state.wrapT}},flipY:{set:function(a){a=!!a,this._state.flipY!==a&&(this._state.flipY=a,this._imageDirty=!0,this._needUpdate())},get:function(){return this._state.flipY}},encoding:{set:function(a){a=a||"linear","linear"!==a&&"sRGB"!==a&&"gamma"!==a&&(this.error("Unsupported value for 'encoding': '"+a+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),a="linear"),this._state.encoding=a,this.fire("dirty")},get:function(){return this._state.encoding}}},_destroy:function(){this.scene.canvas.off(this._webglContextRestored),this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Fresnel=xeogl.Component.extend({type:"xeogl.Fresnel",_init:function(a){this._state=new xeogl.renderer.Fresnel({edgeColor:xeogl.math.vec3([0,0,0]),centerColor:xeogl.math.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=a.edgeColor,this.centerColor=a.centerColor,this.edgeBias=a.edgeBias,this.centerBias=a.centerBias,this.power=a.power},_props:{edgeColor:{set:function(a){this._state.edgeColor.set(a||[0,0,0]),this._renderer.imageDirty()},get:function(){return this._state.edgeColor}},centerColor:{set:function(a){this._state.centerColor.set(a||[1,1,1]),this._renderer.imageDirty()},get:function(){return this._state.centerColor}},edgeBias:{set:function(a){this._state.edgeBias=a||0,this._renderer.imageDirty()},get:function(){return this._state.edgeBias}},centerBias:{set:function(a){this._state.centerBias=void 0!==a&&null!==a?a:1,this._renderer.imageDirty()},get:function(){return this._state.centerBias}},power:{set:function(a){this._state.power=void 0!==a&&null!==a?a:1,this._renderer.imageDirty()},get:function(){return this._state.power}}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Entity=xeogl.Component.extend({type:"xeogl.Entity",_init:function(a){this._state=new xeogl.renderer.Modes({translate:null,visible:!0,culled:!1,pickable:null,clippable:null,colorize:null,collidable:null,castShadow:null,receiveShadow:null,outlined:null,ghosted:!1,highlighted:!1,selected:!1,layer:null,billboard:null,hash:""}),this._objectId=null,this._loading=!1!==a.loading,this._aabbDirty=!0,this._obbDirty=!0,this._worldPositions=null,this._worldPositionsDirty=!0,this.geometry=a.geometry,this.material=a.material,this.transform=a.transform,this.ghostMaterial=a.ghostMaterial,this.outlineMaterial=a.outlineMaterial,this.highlightMaterial=a.highlightMaterial,this.selectedMaterial=a.selectedMaterial,this.translate=a.translate,this.visible=a.visible,this.culled=a.culled,this.pickable=a.pickable,this.clippable=a.clippable,this.collidable=a.collidable,this.castShadow=a.castShadow,this.receiveShadow=a.receiveShadow,this.outlined=a.outlined,this.layer=a.layer,this.stationary=a.stationary,this.billboard=a.billboard,this.solid=a.solid,this.ghosted=a.ghosted,this.highlighted=a.highlighted,this.selected=a.selected,this.colorize=a.colorize},_props:{geometry:{set:function(a){this._attach({name:"geometry",type:"xeogl.Component",component:a,sceneDefault:!0,on:{boundary:{callback:this._setBoundaryDirty,scope:this},destroyed:{callback:this._setBoundaryDirty,scope:this}}}),this._setBoundaryDirty()},get:function(){return this._attached.geometry}},material:{set:function(a){this._attach({name:"material",type:"xeogl.Material",component:a,sceneDefault:!0})},get:function(){return this._attached.material}},ghostMaterial:{set:function(a){this._attach({name:"ghostMaterial",type:"xeogl.EmphasisMaterial",component:a,sceneDefault:!0})},get:function(){return this._attached.ghostMaterial}},highlightMaterial:{set:function(a){this._attach({name:"highlightMaterial",type:"xeogl.EmphasisMaterial",component:a,sceneDefault:!0})},get:function(){return this._attached.highlightMaterial}},selectedMaterial:{set:function(a){this._attach({name:"selectedMaterial",type:"xeogl.EmphasisMaterial",component:a,sceneDefault:!0})},get:function(){return this._attached.selectedMaterial}},outlineMaterial:{set:function(a){this._attach({name:"outlineMaterial",type:"xeogl.OutlineMaterial",component:a,sceneDefault:!0})},get:function(){return this._attached.outlineMaterial}},transform:{set:function(a){this._setBoundaryDirty(),this._attach({name:"transform",type:"xeogl.Transform",component:a,sceneDefault:!0,on:{updated:{callback:function(){this._transformDirty||(this._transformDirty=!0,xeogl.scheduleTask(this._transformUpdated,this))},scope:this},destroyed:{callback:this._setBoundaryDirty,scope:this}}})},get:function(){return this._attached.transform}},visible:{set:function(a){this._state.visible=!1!==a,this._renderer.imageDirty()},get:function(){return this._state.visible}},culled:{set:function(a){this._state.culled=!!a,this._renderer.imageDirty()},get:function(){return this._state.culled}},pickable:{set:function(a){a=!1!==a,this._state.pickable!==a&&(this._state.pickable=a)},get:function(){return this._state.pickable}},clippable:{set:function(a){a=!1!==a,this._state.clippable!==a&&(this._state.clippable=a,this._renderer.imageDirty())},get:function(){return this._state.clippable}},collidable:{set:function(a){(a=!1!==a)!==this._state.collidable&&(this._state.collidable=a)},get:function(){return this._state.collidable}},castShadow:{set:function(a){(a=!1!==a)!==this._state.castShadow&&(this._state.castShadow=a,this._renderer.imageDirty())},get:function(){return this._state.castShadow}},receiveShadow:{set:function(a){(a=!1!==a)!==this._state.receiveShadow&&(this._state.receiveShadow=a,this._state.hash=a?"/mod/rs;":"/mod;",this.fire("dirty",this))},get:function(){return this._state.receiveShadow}},"outlined,outline":{set:function(a){(a=!!a)!==this._state.outlined&&(this._state.outlined=a,this._renderer.imageDirty())},get:function(){return this._state.outlined}},"highlight,highlighted":{set:function(a){(a=!!a)!==this._state.highlighted&&(this._state.highlighted=a,this._renderer.imageDirty())},get:function(){return this._state.highlighted}},selected:{set:function(a){(a=!!a)!==this._state.selected&&(this._state.selected=a,this._renderer.imageDirty())},get:function(){return this._state.selected}},colorize:{set:function(a){var b=this._state.colorize;b||(b=this._state.colorize=new Float32Array(4)),a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):(b[0]=1,b[1]=1,b[2]=1,b[3]=1),this._renderer.imageDirty()},get:function(){return this._state.colorize}},layer:{set:function(a){a=a||0,(a=Math.round(a))!==this._state.layer&&(this._state.layer=a,this._renderer.needStateSort())},get:function(){return this._state.layer}},stationary:{set:function(a){a=!!a,this._state.stationary!==a&&(this._state.stationary=a,this.fire("dirty",this))},get:function(){return this._state.stationary}},billboard:{set:function(a){a=a||"none","spherical"!==a&&"cylindrical"!==a&&"none"!==a&&(this.error("Unsupported value for 'billboard': "+a+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),a="none"),this._state.billboard!==a&&(this._state.billboard=a,this.fire("dirty",this))},get:function(){return this._state.billboard}},"ghosted,ghost":{set:function(a){a=!!a,this._state.ghosted!==a&&(this._state.ghosted=a,this._renderer.imageDirty())},get:function(){return this._state.ghosted}},center:{get:function(){if(this._aabbDirty){this._center||(this._center=xeogl.math.AABB3());var a=this.aabb;this._center[0]=(a[0]+a[3])/2,this._center[1]=(a[1]+a[4])/2,this._center[2]=(a[2]+a[5])/2}return this._center}},aabb:{get:function(){if(this._aabbDirty){this._aabbDirty=!1;var a=xeogl.math,b=this._attached.transform,c=this._attached.geometry;if(!b)return c.aabb;this._aabb||(this._aabb=a.AABB3()),this._obb||(this._obb=a.OBB3()),a.transformOBB3(b.leafMatrix,c.obb,this._obb),a.OBB3ToAABB3(this._obb,this._aabb)}return this._aabb}},obb:{get:function(){if(this._obbDirty){this._obbDirty=!1;var a=this._attached.transform,b=this._attached.geometry;if(!a)return b.obb;this._obb||(this._obb=xeogl.math.OBB3()),xeogl.math.transformOBB3(a.leafMatrix,b.obb,this._obb)}return this._obb}},worldPositions:{get:function(){if(this._worldPositionsDirty){var a=this.geometry.positions;this._worldPositions||(this._worldPositions=new Float32Array(a.length)),this._attached.transform?xeogl.math.transformPositions3(this._attached.transform.leafMatrix,a,this._worldPositions):this._worldPositions.set(a),this._worldPositionsDirty=!1}return this._worldPositions},set:function(a){(a=null===a)&&(this._worldPositions=null,this._worldPositionsDirty=!0)}}},_transformUpdated:function(){this._transformDirty&&(this._attached.transform._buildLeafMatrix(),this._setBoundaryDirty(),this._transformDirty=!1)},_setBoundaryDirty:function(){this._aabbDirty=!0,this._obbDirty=!0,this._worldPositionsDirty=!0,this.fire("boundary")},_valid:function(){if(this.destroyed)return!1;var a=this._attached.geometry;return!!a&&!!a.created},_compile:function(){this._objectId&&(this._renderer.destroyObject(this._objectId),this._objectId=null);var a=this.material._getState(),b=this.ghostMaterial._state,c=this.outlineMaterial._state,d=this.highlightMaterial._state,e=this.selectedMaterial._state,f=this.geometry._getVertexBufs(),g=this.geometry._state,h=this.transform._state,i=this._getState(),j=this._renderer.createObject(this.id,a,b,c,d,e,f,g,h,i);if(this._loading&&(this._loading=!1,this.fire("loaded",!0)),j.objectId)this._objectId=j.objectId;else if(j.errors){var k=j.errors.join("\n");this.error(k),this.fire("error",k)}},_getState:function(){return this._makeHash(),this._state},_makeHash:function(){var a=[],b=this._state;b.stationary&&a.push("/s"),"none"===b.billboard?a.push("/n"):"spherical"===b.billboard?a.push("/s"):"cylindrical"===b.billboard&&a.push("/c"),b.receiveShadow&&a.push("/rs"),a.push(";"),this._state.hash=a.join("")},_destroy:function(){this._objectId&&(this._renderer.destroyObject(this._objectId),this._objectId=null)}})}(),function(){"use strict";xeogl.Viewport=xeogl.Component.extend({type:"xeogl.Viewport",_init:function(a){this._state=new xeogl.renderer.Viewport({boundary:[0,0,100,100]}),this.boundary=a.boundary,this.autoBoundary=a.autoBoundary},_props:{boundary:{set:function(a){if(!this._autoBoundary){if(!a){var b=this.scene.canvas.boundary;a=[0,0,b[2],b[3]]}this._state.boundary=a,this._renderer.imageDirty(),this.fire("boundary",this._state.boundary)}},get:function(){return this._state.boundary}},autoBoundary:{set:function(a){(a=!!a)!==this._autoBoundary&&(this._autoBoundary=a,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(a){var b=a[2],c=a[3];this._state.boundary=[0,0,b,c],this._renderer.imageDirty(),this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))},get:function(){return this._autoBoundary}}},_getState:function(){return this._state}})}(),function(){"use strict";xeogl.Transform=xeogl.Component.extend({type:"xeogl.Transform",_init:function(a){this._onParentUpdated=null,this._onParentDestroyed=null,this._matrix=xeogl.math.identityMat4(xeogl.math.mat4()),this._leafMatrix=null,this._leafNormalMatrix=null,this._leafMatrixDirty=!0,this._leafNormalMatrixDirty=!0;var b=this;this._state=new xeogl.renderer.Transform({getMatrix:function(){return b._leafMatrixDirty&&b._buildLeafMatrix(),b._leafMatrix},getNormalMatrix:function(){return b._leafNormalMatrixDirty&&b._buildLeafNormalMatrix(),b._leafNormalMatrix}}),this.parent=a.parent,this.matrix=a.matrix,this.postMultiply=a.postMultiply,xeogl.stats.memory.transforms++},_parentUpdated:function(){this._leafMatrixDirty=!0,this.fire("updated",!0)},_buildLeafMatrix:function(){if(this._leafMatrixDirty){if(this._leafMatrix||(this._leafMatrix=xeogl.math.mat4()),this._build&&this._buildScheduled&&(this._build(),this._buildScheduled=!1),this._parent)this._postMultiply?xeogl.math.mulMat4(this._parent.leafMatrix,this._matrix,this._leafMatrix):xeogl.math.mulMat4(this._matrix,this._parent.leafMatrix,this._leafMatrix);else for(var a=0,b=this._matrix.length;a<b;a++)this._leafMatrix[a]=this._matrix[a];this._renderer.imageDirty(),this._leafMatrixDirty=!1,this._leafNormalMatrixDirty=!0}},_buildLeafNormalMatrix:function(){this._leafMatrixDirty&&this._buildLeafMatrix(),this._leafNormalMatrix||(this._leafNormalMatrix=xeogl.math.mat4()),xeogl.math.inverseMat4(this._leafMatrix,this._leafNormalMatrix),xeogl.math.transposeMat4(this._leafNormalMatrix),this._leafNormalMatrixDirty=!1},_props:{parent:{set:function(a){if(a)for(var b=this.id,c=a;c;c=c._parent)if(b===c.id)return void this.error("Not allowed to attach Transform as parent of itself - ignoring");!this._parent||a&&a.id===this._parent.id||(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed)),this._parent=a,this._parent&&(this._onParentUpdated=this._parent.on("updated",this._parentUpdated,this),this._onParentDestroyed=this._parent.on("destroyed",this._parentUpdated,this)),this._parentUpdated()},get:function(){return this._parent}},postMultiply:{set:function(a){a=!1!==a,this._postMultiply!==a&&(this._postMultiply=a,this._leafMatrixDirty=!0,this._renderer.imageDirty(),this.fire("updated",!0))},get:function(){return this._postMultiply}},matrix:{set:function(a){this._matrix.set(a||xeogl.math.identityMat4()),this._leafMatrixDirty=!0,this._renderer.imageDirty(),this.fire("matrix",this._matrix),this.fire("updated",!0)},get:function(){return this._updateScheduled&&this._doUpdate(),this._matrix}},leafMatrix:{get:function(){return this._leafMatrixDirty&&this._buildLeafMatrix(),this._leafMatrix}},leafNormalMatrix:{get:function(){return this._leafMatrixDirty&&this._buildLeafNormalMatrix(),this._leafNormalMatrix}}},_destroy:function(){this._parent&&(this._parent.off(this._onParentUpdated),this._parent.off(this._onParentDestroyed)),xeogl.stats.memory.transforms--}})}(),function(){"use strict";xeogl.Rotate=xeogl.Transform.extend({type:"xeogl.Rotate",_init:function(a){this._super(a),this.xyz=a.xyz,this.angle=a.angle},_update:function(){if(0===this._xyz[0]&&0===this._xyz[1]&&0===this._xyz[2])return void this.warn("Rotation axis is [0,0,0] - won't build matrix.");this.matrix=xeogl.math.rotationMat4v(this._angle*xeogl.math.DEGTORAD,this._xyz,this._matrix)},_props:{xyz:{set:function(a){(this._xyz=this._xyz||new xeogl.math.vec3).set(a||[0,1,0]),this._needUpdate(0)},get:function(){return this._xyz}},angle:{set:function(a){this._angle=a||0,this._needUpdate(0)},get:function(){return this._angle}}}})}(),function(){"use strict";xeogl.Quaternion=xeogl.Transform.extend({type:"xeogl.Quaternion",_init:function(a){this._super(a),this.xyzw=a.xyzw},_props:{xyzw:{set:function(a){var b=xeogl.math;(this._xyzw=this._xyzw||new b.vec4).set(a||b.identityQuaternion()),this.matrix=b.quaternionToMat4(this._xyzw,this._matrix||(this._matrix=xeogl.math.identityMat4()))},get:function(){return this._xyzw}}},rotate:function(){var a=xeogl.math,b=a.vec4(),c=a.vec4();return function(d){b[0]=d[0],b[1]=d[1],b[2]=d[2],b[3]=d[3]*a.DEGTORAD,a.angleAxisToQuaternion(b,c),this.xyzw=a.mulQuaternions(this._xyzw,c,this._xyzw)}}()})}(),function(){"use strict";xeogl.Scale=xeogl.Transform.extend({type:"xeogl.Scale",_init:function(a){this._super(a),this.xyz=a.xyz},_props:{xyz:{set:function(a){(this._xyz=this._xyz||new xeogl.math.vec3).set(a||[1,1,1]),this.matrix=xeogl.math.scalingMat4v(this._xyz,this._matrix)},get:function(){return this._xyz}}}})}(),function(){"use strict";xeogl.Translate=xeogl.Transform.extend({type:"xeogl.Translate",_init:function(a){this._super(a),this.xyz=a.xyz},_props:{xyz:{set:function(a){(this._xyz=this._xyz||new xeogl.math.vec3).set(a||[0,0,0]),this.matrix=xeogl.math.translationMat4v(this._xyz,this._matrix)},get:function(){return this._xyz}}}})}(),function(){"use strict";var a=xeogl.math,b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3(),g=a.vec3();xeogl.Camera=xeogl.Component.extend({type:"xeogl.Camera",_init:function(b){this._state=new xeogl.renderer.ViewTransform({matrix:a.mat4(),normalMatrix:a.mat4()}),this._perspective=new xeogl.Perspective(this),this._ortho=new xeogl.Ortho(this),this._frustum=new xeogl.Frustum(this),this._project=this._perspective;var c=this;this._eye=a.vec3([0,0,10]),this._look=a.vec3([0,0,0]),this._up=a.vec3([0,1,0]),this._worldUp=a.vec3([0,1,0]),this._worldRight=a.vec3([1,0,0]),this._worldForward=a.vec3([0,0,-1]),this.eye=b.eye,this.look=b.look,this.up=b.up,this.worldAxis=b.worldAxis,this.gimbalLock=b.gimbalLock,this.projection=b.projection,this._perspective.on("matrix",function(){"perspective"===c._projectionType&&c.fire("projMatrix",c._perspective.matrix)}),this._ortho.on("matrix",function(){"ortho"===c._projectionType&&c.fire("projMatrix",c._ortho.matrix)}),this._frustum.on("matrix",function(){"frustum"===c._projectionType&&c.fire("projMatrix",c._frustum.matrix)})},_update:function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3();return function(){var f;"ortho"===this.projection?(a.subVec3(this._eye,this._look,b),a.normalizeVec3(b,c),a.mulVec3Scalar(c,1e3,d),a.addVec3(this._look,d,e),f=e):f=this._eye,a.lookAtMat4v(f,this._look,this._up,this._state.matrix),a.inverseMat4(this._state.matrix,this._state.normalMatrix),a.transposeMat4(this._state.normalMatrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}}(),orbitYaw:function(){var f=a.mat4();return function(g){var h=a.subVec3(this._eye,this._look,b);a.rotationMat4v(.0174532925*g,this._gimbalLock?this._worldUp:this._up,f),h=a.transformPoint3(f,h,c),this.eye=a.addVec3(this._look,h,d),this.up=a.transformPoint3(f,this._up,e)}}(),orbitPitch:function(){var h=a.mat4();return function(i){var j=a.subVec3(this._eye,this._look,b),k=a.cross3Vec3(a.normalizeVec3(j,c),a.normalizeVec3(this._up,d));a.rotationMat4v(.0174532925*i,k,h),j=a.transformPoint3(h,j,e),this.eye=a.addVec3(j,this._look,f),this.up=a.transformPoint3(h,this._up,g)}}(),yaw:function(){var f=a.mat4();return function(g){var h=a.subVec3(this._look,this._eye,b);a.rotationMat4v(.0174532925*g,this._gimbalLock?this._worldUp:this._up,f),h=a.transformPoint3(f,h,c),this.look=a.addVec3(h,this._eye,d),this._gimbalLock&&(this.up=a.transformPoint3(f,this._up,e))}}(),pitch:function(){var h=a.mat4();return function(i){var j=a.subVec3(this._look,this._eye,b),k=a.cross3Vec3(a.normalizeVec3(j,c),a.normalizeVec3(this._up,d));a.rotationMat4v(.0174532925*i,k,h),j=a.transformPoint3(h,j,e),this.look=a.addVec3(j,this._eye,f),this.up=a.transformPoint3(h,this._up,g)}}(),pan:function(h){var i,j=a.subVec3(this._eye,this._look,b),k=[0,0,0];if(0!==h[0]){var l=a.cross3Vec3(a.normalizeVec3(j,[]),a.normalizeVec3(this._up,c));i=a.mulVec3Scalar(l,h[0]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]}0!==h[1]&&(i=a.mulVec3Scalar(a.normalizeVec3(this._up,d),h[1]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]),0!==h[2]&&(i=a.mulVec3Scalar(a.normalizeVec3(j,e),h[2]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]),this.eye=a.addVec3(this._eye,k,f),this.look=a.addVec3(this._look,k,g)},zoom:function(f){var g=a.subVec3(this._eye,this._look,b),h=Math.abs(a.lenVec3(g,c)),i=Math.abs(h+f);if(!(i<.5)){var j=a.normalizeVec3(g,d);this.eye=a.addVec3(this._look,a.mulVec3Scalar(j,i),e)}},_props:{eye:{
set:function(a){this._eye.set(a||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)},get:function(){return this._eye}},look:{set:function(a){this._look.set(a||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)},get:function(){return this._look}},up:{set:function(a){this._up.set(a||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)},get:function(){return this._up}},worldAxis:{set:function(a){a=a||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(a):this._worldAxis=new Float32Array(a),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)},get:function(){return this._worldAxis}},worldUp:{get:function(){return this._worldUp}},worldRight:{get:function(){return this._worldRight}},worldForward:{get:function(){return this._worldForward}},gimbalLock:{set:function(a){this._gimbalLock=!1!==a,this.fire("gimbalLock",this._gimbalLock)},get:function(){return this._gimbalLock}},eyeLookDist:{get:function(){var b=new Float32Array(3);return function(){return a.lenVec3(a.subVec3(this._look,this._eye,b))}}()},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},viewMatrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},normalMatrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},viewNormalMatrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},projMatrix:{get:function(){return this[this.projection].matrix}},perspective:{get:function(){return this._perspective}},ortho:{get:function(){return this._ortho}},frustum:{get:function(){return this._frustum}},projection:{set:function(a){a=a||"perspective",this._projectionType!==a&&("perspective"===a?this._project=this._perspective:"ortho"===a?this._project=this._ortho:"frustum"===a?this._project=this._frustum:(this.error("Unsupported value for 'projection': "+a+" defaulting to 'perspective'"),this._project=this._perspective,a="perspective"),this._projectionType=a,this._renderer.imageDirty(),this._update(),this.fire("dirty"))},get:function(){return this._projectionType}},project:{get:function(){return this._project}},view:{get:function(){return this}}}})}(),function(){"use strict";xeogl.Frustum=xeogl.Component.extend({type:"xeogl.Frustum",_init:function(a){this._state=new xeogl.renderer.ProjTransform({matrix:xeogl.math.mat4()}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=1e4,this.left=a.left,this.right=a.right,this.bottom=a.bottom,this.top=a.top,this.near=a.near,this.far=a.far},_update:function(){xeogl.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._needUpdate(0),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._needUpdate(0),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._needUpdate(0),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._needUpdate(0),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._needUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._needUpdate(0),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}}}})}(),function(){"use strict";xeogl.Ortho=xeogl.Component.extend({type:"xeogl.Ortho",_init:function(a){this._state=new xeogl.renderer.ProjTransform({matrix:xeogl.math.mat4()}),this.scale=a.scale,this.near=a.near,this.far=a.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)},_update:function(){var a,b,c,d,e=this.scene,f=this._scale,g=e.canvas.canvas,h=g.clientWidth,i=g.clientHeight,j=.5*f,k=h/i;h>i?(a=-j,b=j,c=j/k,d=-j/k):(a=-j*k,b=j*k,c=j,d=-j),xeogl.math.orthoMat4c(a,b,d,c,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)},_props:{scale:{set:function(a){void 0!==a&&null!==a||(a=1),a<=0&&(a=.01),this._scale=a,this._needUpdate(0),this.fire("scale",this._scale)},get:function(){return this._scale}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._needUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._needUpdate(0),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}}},_destroy:function(){this._super(),this.scene.canvas.off(this._onCanvasBoundary)}})}(),function(){"use strict";xeogl.Perspective=xeogl.Component.extend({type:"xeogl.Perspective",_init:function(a){this._state=new xeogl.renderer.ProjTransform({matrix:xeogl.math.mat4()}),this._dirty=!1,this._fov=60,this._near=.1,this._far=1e4,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=a.fov,this.fovAxis=a.fovAxis,this.near=a.near,this.far=a.far},_update:function(){var a=this.scene.canvas.canvas,b=a.clientWidth/a.clientHeight,c=this._fov,d=this._fovAxis;("x"==d||"min"==d&&b<1||"max"==d&&b>1)&&(c/=b),c=Math.min(c,120),xeogl.math.perspectiveMat4(c*(Math.PI/180),b,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)},_props:{fov:{set:function(a){this._fov=void 0!==a&&null!==a?a:60,this._needUpdate(0),this.fire("fov",this._fov)},get:function(){return this._fov}},fovAxis:{set:function(a){a=a||"min",this._fovAxis!==a&&("x"!==a&&"y"!==a&&"min"!==a&&(this.error("Unsupported value for 'fovAxis': "+a+" - defaulting to 'min'"),a="min"),this._fovAxis=a,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))},get:function(){return this._fovAxis}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._needUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._needUpdate(0),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}}},_destroy:function(){this._super(),this.scene.canvas.off(this._canvasResized)}})}(),xeogl.version="0.7.0";